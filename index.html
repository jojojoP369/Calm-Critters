<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Calm Critters - Meditation for Kids</title>
  <meta name="description"
    content="A child-friendly meditation app for kids ages 3+ with breathing exercises, guided meditations, and emotion check-ins.">
  <meta name="theme-color" content="#89CFF0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Calm Critters">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sky: #89CFF0;
      --lavender: #C3B1E1;
      --mint: #98FB98;
      --peach: #FFDAB9;
      --sunshine: #FDFD96;
      --coral: #FF7F7F;
      --text: #4A4A6A;
      --bg-gradient: linear-gradient(135deg, #89CFF0 0%, #C3B1E1 50%, #FFDAB9 100%);
    }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 24px 16px 40px;
      animation: fadeIn 0.4s ease;
    }

    .screen.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mascot-container {
      position: relative;
      margin: 16px 0;
    }

    .mascot {
      width: 160px;
      height: 160px;
      animation: float 3s ease-in-out infinite;
    }

    .mascot-small {
      width: 100px;
      height: 100px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-12px);
      }
    }

    @keyframes wiggle {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-5deg);
      }

      75% {
        transform: rotate(5deg);
      }
    }

    @keyframes bounce {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    @keyframes celebrate {
      0% {
        transform: scale(1) rotate(0deg);
      }

      25% {
        transform: scale(1.2) rotate(-10deg);
      }

      50% {
        transform: scale(1.3) rotate(0deg);
      }

      75% {
        transform: scale(1.2) rotate(10deg);
      }

      100% {
        transform: scale(1) rotate(0deg);
      }
    }

    .mascot-breathing {
      animation: breatheMascot 6s ease-in-out infinite;
    }

    @keyframes breatheMascot {

      0%,
      100% {
        transform: scale(1);
      }

      40% {
        transform: scale(1.15);
      }

      60% {
        transform: scale(1.15);
      }
    }

    .app-title {
      font-size: 2.2rem;
      font-weight: 800;
      color: #fff;
      text-shadow: 2px 2px 8px rgba(100, 80, 160, 0.3);
      margin-bottom: 4px;
      text-align: center;
    }

    .app-subtitle {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 24px;
      text-align: center;
    }

    .activity-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      width: 100%;
      max-width: 360px;
      margin-top: 8px;
    }

    .activity-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 24px 16px;
      border: none;
      border-radius: 24px;
      font-family: 'Nunito', sans-serif;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-height: 120px;
      user-select: none;
    }

    .activity-btn:active {
      transform: scale(0.95);
    }

    .activity-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .activity-btn .icon {
      font-size: 2.5rem;
    }

    .btn-breathe {
      background: linear-gradient(135deg, #89CFF0, #B0E0FF);
    }

    .btn-meditate {
      background: linear-gradient(135deg, #C3B1E1, #D8C8F0);
    }

    .btn-feelings {
      background: linear-gradient(135deg, #FFDAB9, #FFE8D0);
    }

    .btn-rewards {
      background: linear-gradient(135deg, #FDFD96, #FFFCB0);
    }

    .back-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.85);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
      z-index: 100;
    }

    .back-btn:active {
      transform: scale(0.9);
    }

    .screen-title {
      font-size: 1.8rem;
      font-weight: 800;
      color: #fff;
      text-shadow: 2px 2px 8px rgba(100, 80, 160, 0.3);
      margin: 16px 0 8px;
      text-align: center;
    }

    .big-btn {
      padding: 18px 48px;
      border: none;
      border-radius: 50px;
      font-family: 'Nunito', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      min-height: 64px;
      user-select: none;
    }

    .big-btn:active {
      transform: scale(0.95);
    }

    .big-btn-blue {
      background: linear-gradient(135deg, #5B9BD5, #89CFF0);
    }

    .big-btn-green {
      background: linear-gradient(135deg, #66BB6A, #98FB98);
      color: var(--text);
    }

    .big-btn-coral {
      background: linear-gradient(135deg, #E57373, #FF7F7F);
    }

    /* BREATHING */
    .breathing-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 24px;
      width: 100%;
    }

    .breathing-circle-container {
      position: relative;
      width: 220px;
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .breathing-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(137, 207, 240, 0.6), rgba(195, 177, 225, 0.8));
      transition: width 0.3s ease, height 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 40px rgba(137, 207, 240, 0.4);
    }

    .breathing-circle.inhale {
      width: 200px;
      height: 200px;
      transition: width 4s ease-in-out, height 4s ease-in-out;
    }

    .breathing-circle.hold {
      width: 200px;
      height: 200px;
    }

    .breathing-circle.exhale {
      width: 120px;
      height: 120px;
      transition: width 4s ease-in-out, height 4s ease-in-out;
    }

    .breathing-circle-inner {
      font-size: 3rem;
    }

    .breathing-label {
      font-size: 1.6rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.15);
      min-height: 48px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .breathing-counter {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 4px;
    }

    /* FEELINGS */
    .feelings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      max-width: 360px;
      width: 100%;
      margin-top: 16px;
    }

    .feeling-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 20px 12px;
      border: 4px solid transparent;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.85);
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      min-height: 100px;
    }

    .feeling-btn:active {
      transform: scale(0.93);
    }

    .feeling-btn:hover {
      transform: scale(1.05);
    }

    .feeling-btn.selected {
      border-color: var(--lavender);
      box-shadow: 0 4px 20px rgba(195, 177, 225, 0.4);
    }

    .feeling-btn .icon {
      font-size: 2.5rem;
    }

    .feeling-response {
      margin-top: 20px;
      padding: 20px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
      max-width: 320px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.4s ease;
    }

    /* MEDITATION LIST */
    .meditation-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 400px;
      margin-top: 16px;
    }

    .meditation-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      border: none;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.88);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-family: 'Nunito', sans-serif;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      text-align: left;
      width: 100%;
      min-height: 80px;
    }

    .meditation-card:active {
      transform: scale(0.97);
    }

    .meditation-card:hover {
      transform: scale(1.02);
      box-shadow: 0 5px 18px rgba(0, 0, 0, 0.12);
    }

    .meditation-card .icon {
      font-size: 2.8rem;
      flex-shrink: 0;
    }

    .meditation-card-info {
      flex: 1;
    }

    .meditation-card-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text);
    }

    .meditation-card-desc {
      font-size: 0.85rem;
      color: #8888AA;
      margin-top: 2px;
    }

    .meditation-card-duration {
      font-size: 0.8rem;
      font-weight: 700;
      background: var(--lavender);
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      flex-shrink: 0;
    }

    /* MEDITATION PLAYER */
    .player-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      gap: 12px;
      width: 100%;
      position: relative;
    }

    .player-canvas-wrap {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 4/3;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.12);
    }

    .player-canvas-wrap canvas {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 24px;
    }

    .player-subtitle-bar {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.88);
      border-radius: 16px;
      padding: 10px 20px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 700;
      max-width: 85%;
      text-align: center;
      backdrop-filter: blur(6px);
      pointer-events: none;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      line-height: 1.4;
      transition: opacity 0.3s;
    }

    .player-timer {
      font-size: 2.5rem;
      font-weight: 800;
      color: #fff;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.15);
    }

    .player-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
    }

    .player-controls {
      display: flex;
      gap: 16px;
      margin-top: 4px;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 8px 16px;
    }

    .volume-control label {
      color: #fff;
      font-size: 1.2rem;
    }

    .volume-control input[type="range"] {
      width: 120px;
      accent-color: #fff;
    }

    .voice-loading {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85rem;
      min-height: 20px;
    }

    /* REWARDS */
    .rewards-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 100%;
      max-width: 400px;
    }

    .streak-display {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      padding: 24px 32px;
      text-align: center;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      width: 100%;
    }

    .streak-number {
      font-size: 3.5rem;
      font-weight: 800;
      color: var(--coral);
    }

    .streak-label {
      font-size: 1.1rem;
      font-weight: 700;
      color: #8888AA;
    }

    .stars-display {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      width: 100%;
    }

    .stars-count {
      font-size: 3.5rem;
      font-weight: 800;
      color: #F0B800;
    }

    .stars-visual {
      font-size: 2rem;
      margin-top: 8px;
      line-height: 1.8;
      word-spacing: 4px;
    }

    .recent-feelings {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      width: 100%;
    }

    .recent-feelings-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #8888AA;
      margin-bottom: 12px;
    }

    .recent-feelings-list {
      font-size: 2rem;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* CELEBRATION */
    .celebration-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.3);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      animation: fadeIn 0.3s ease;
    }

    .celebration-overlay.active {
      display: flex;
    }

    .celebration-box {
      background: #fff;
      border-radius: 32px;
      padding: 40px 32px;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
      max-width: 320px;
      animation: celebrate 0.6s ease;
    }

    .celebration-star {
      font-size: 4rem;
      margin-bottom: 8px;
    }

    .celebration-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }

    .celebration-sub {
      font-size: 1rem;
      color: #8888AA;
      margin-bottom: 20px;
    }

    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1001;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 3px;
      top: -20px;
      animation: confettiFall linear forwards;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* JOURNEY MAP */
    .journey-btn-featured {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      max-width: 360px;
      padding: 20px 24px;
      border: none;
      border-radius: 24px;
      background: linear-gradient(135deg, #FF9A56, #FF6B9D, #C471ED);
      font-family: 'Nunito', sans-serif;
      font-size: 1.2rem;
      font-weight: 800;
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 20px rgba(255, 107, 157, 0.35);
      min-height: 70px;
      margin-bottom: 8px;
      user-select: none;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.15);
    }

    .journey-btn-featured:active {
      transform: scale(0.95);
    }

    .journey-btn-featured:hover {
      transform: scale(1.03);
      box-shadow: 0 6px 25px rgba(255, 107, 157, 0.45);
    }

    .journey-btn-featured .icon {
      font-size: 2rem;
    }

    .journey-path {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      width: 100%;
      max-width: 340px;
      margin-top: 12px;
      padding-bottom: 40px;
    }

    .journey-connector {
      width: 4px;
      height: 36px;
      background: rgba(255, 255, 255, 0.35);
      border-radius: 2px;
    }

    .journey-connector.completed {
      background: linear-gradient(180deg, #66BB6A, #98FB98);
    }

    .journey-node {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      padding: 18px 20px;
      border: 4px solid transparent;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      font-family: 'Nunito', sans-serif;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
    }

    .journey-node:active {
      transform: scale(0.97);
    }

    .journey-node:hover {
      transform: scale(1.02);
    }

    .journey-node.active-node {
      border-color: #FF6B9D;
      box-shadow: 0 4px 24px rgba(255, 107, 157, 0.3);
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {

      0%,
      100% {
        box-shadow: 0 4px 24px rgba(255, 107, 157, 0.3);
      }

      50% {
        box-shadow: 0 4px 32px rgba(255, 107, 157, 0.55);
      }
    }

    .journey-node.completed-node {
      border-color: #66BB6A;
      background: rgba(240, 255, 240, 0.95);
    }

    .journey-node.locked {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.4);
    }

    .journey-node.locked:active {
      transform: none;
    }

    .journey-node.locked:hover {
      transform: none;
    }

    .journey-node-icon {
      font-size: 2.4rem;
      flex-shrink: 0;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
    }

    .journey-node-info {
      flex: 1;
    }

    .journey-node-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }

    .journey-node-desc {
      font-size: 0.8rem;
      color: #8888AA;
      margin-top: 2px;
    }

    .journey-node-badge {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    /* CURRICULUM LESSON */
    .curriculum-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 20px;
      width: 100%;
      max-width: 400px;
    }

    .curriculum-step-label {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.15);
      min-height: 48px;
      text-align: center;
      line-height: 1.4;
      padding: 0 12px;
    }

    .curriculum-progress-bar {
      width: 100%;
      max-width: 300px;
      height: 10px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.3);
      overflow: hidden;
    }

    .curriculum-progress-fill {
      height: 100%;
      border-radius: 5px;
      background: linear-gradient(90deg, #66BB6A, #98FB98);
      transition: width 0.5s ease;
    }

    /* QUIZ OVERLAY */
    .quiz-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.35);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      animation: fadeIn 0.3s ease;
    }

    .quiz-overlay.active {
      display: flex;
    }

    .quiz-box {
      background: #fff;
      border-radius: 32px;
      padding: 36px 28px 32px;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
      max-width: 340px;
      width: 90%;
      animation: celebrate 0.5s ease;
    }

    .quiz-question {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .quiz-answers {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quiz-answer-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px 20px;
      border: 3px solid rgba(195, 177, 225, 0.3);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.95);
      font-family: 'Nunito', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, background 0.2s;
      min-height: 64px;
    }

    .quiz-answer-btn:active {
      transform: scale(0.95);
    }

    .quiz-answer-btn:hover {
      border-color: var(--lavender);
      background: rgba(195, 177, 225, 0.12);
    }

    .quiz-answer-btn.correct {
      border-color: #66BB6A;
      background: rgba(102, 187, 106, 0.15);
      animation: bounce 0.5s ease;
    }

    .quiz-answer-btn.wrong {
      border-color: #FF7F7F;
      background: rgba(255, 127, 127, 0.1);
      animation: shake 0.5s ease;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-8px);
      }

      40% {
        transform: translateX(8px);
      }

      60% {
        transform: translateX(-5px);
      }

      80% {
        transform: translateX(5px);
      }
    }

    .quiz-feedback {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 12px;
      min-height: 28px;
      transition: opacity 0.3s;
    }

    /* REAL-LIFE PROMPT OVERLAY */
    .reallife-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.35);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      animation: fadeIn 0.3s ease;
    }

    .reallife-overlay.active {
      display: flex;
    }

    .reallife-box {
      background: #fff;
      border-radius: 32px;
      padding: 36px 28px 32px;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
      max-width: 340px;
      width: 90%;
      animation: celebrate 0.5s ease;
    }

    .reallife-icon {
      font-size: 3.5rem;
      margin-bottom: 8px;
    }

    .reallife-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }

    .reallife-prompt-text {
      font-size: 1.05rem;
      font-weight: 600;
      color: #8888AA;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .reallife-did-it-btn {
      padding: 18px 40px;
      border: none;
      border-radius: 50px;
      font-family: 'Nunito', sans-serif;
      font-size: 1.15rem;
      font-weight: 800;
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      background: linear-gradient(135deg, #FF9A56, #FF6B9D);
      box-shadow: 0 4px 20px rgba(255, 107, 157, 0.3);
      min-height: 60px;
      user-select: none;
    }

    .reallife-did-it-btn:active {
      transform: scale(0.95);
    }

    .reallife-skip-btn {
      display: block;
      margin: 12px auto 0;
      padding: 8px 20px;
      border: none;
      background: transparent;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: #AAAACC;
      cursor: pointer;
    }

    /* ===== BREATH COACH STYLES ===== */
    .btn-breathcoach {
      background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
      color: #1a3a2a;
    }

    .breathcoach-picker {
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 20px 0;
      align-items: center;
    }

    .breathcoach-card {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 22px;
      padding: 22px 24px;
      width: 92%;
      max-width: 380px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
      border: 2.5px solid transparent;
    }

    .breathcoach-card:hover,
    .breathcoach-card:active {
      transform: scale(1.03);
      box-shadow: 0 6px 24px rgba(67, 233, 123, 0.22);
      border-color: #43E97B;
    }

    .breathcoach-card .card-icon {
      font-size: 2.6rem;
      flex-shrink: 0;
    }

    .breathcoach-card .card-info h3 {
      margin: 0 0 4px;
      font-size: 1.15rem;
      color: #333;
    }

    .breathcoach-card .card-info p {
      margin: 0;
      font-size: 0.85rem;
      color: #888;
    }

    /* Breath game screen */
    #breathgame-screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 16px !important;
    }

    .breath-game-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .breath-game-header h2 {
      margin: 0;
      font-size: 1.4rem;
      color: #444;
    }

    .breath-game-canvas {
      border-radius: 22px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
      max-width: 100%;
      touch-action: none;
    }

    .exhale-meter-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 14px 0 8px;
    }

    .exhale-meter-label {
      font-size: 0.85rem;
      color: #777;
      font-weight: 600;
    }

    .exhale-stars {
      display: flex;
      gap: 4px;
    }

    .exhale-star {
      font-size: 1.4rem;
      opacity: 0.25;
      transition: opacity 0.4s, transform 0.3s;
    }

    .exhale-star.lit {
      opacity: 1;
      transform: scale(1.15);
    }

    .breath-timer {
      font-size: 1.5rem;
      font-weight: 700;
      color: #666;
      margin: 6px 0 4px;
    }

    .breath-indicator {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ddd;
      display: inline-block;
      margin-left: 8px;
      vertical-align: middle;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .breath-indicator.active {
      background: #43E97B;
      box-shadow: 0 0 12px 4px rgba(67, 233, 123, 0.5);
    }

    .breath-hint {
      font-size: 0.9rem;
      color: #999;
      text-align: center;
      margin-top: 4px;
    }

    /* Mic permission overlay */
    .mic-prompt-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .mic-prompt-overlay.active {
      display: flex;
    }

    .mic-prompt-box {
      background: #fff;
      border-radius: 26px;
      padding: 36px 28px;
      text-align: center;
      max-width: 340px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.18);
    }

    .mic-prompt-box .mic-icon {
      font-size: 3.5rem;
      margin-bottom: 12px;
    }

    .mic-prompt-box h3 {
      margin: 0 0 8px;
      font-size: 1.3rem;
      color: #444;
    }

    .mic-prompt-box p {
      margin: 0 0 18px;
      font-size: 0.95rem;
      color: #888;
    }

    .mic-prompt-box .mic-btns {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .mic-prompt-box .mic-btn {
      padding: 12px 22px;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
    }

    .mic-btn-allow {
      background: linear-gradient(135deg, #43E97B, #38F9D7);
      color: #1a3a2a;
    }

    .mic-btn-skip {
      background: #eee;
      color: #777;
    }

    /* Tutorial how-to steps */
    .tutorial-howto {
      text-align: left;
      margin: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tutorial-step {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f7f7ff;
      border-radius: 14px;
      padding: 10px 14px;
    }

    .tutorial-step-icon {
      font-size: 1.6rem;
      flex-shrink: 0;
    }

    .tutorial-step-text {
      font-size: 0.85rem;
      color: #555;
      line-height: 1.3;
    }

    .tutorial-step-text strong {
      color: #333;
      font-size: 0.9rem;
    }

    /* In-game goal banner */
    .breath-goal-banner {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.92);
      padding: 8px 22px;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 700;
      color: #555;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      animation: goalPulse 2s ease-in-out infinite;
    }

    @keyframes goalPulse {

      0%,
      100% {
        transform: translateX(-50%) scale(1);
      }

      50% {
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* Bigger hint text */
    .breath-hint {
      font-size: 1rem !important;
      font-weight: 600 !important;
      color: #666 !important;
      padding: 10px !important;
    }

    @media (min-width: 500px) {
      .screen {
        padding: 32px 24px 48px;
      }

      .mascot {
        width: 200px;
        height: 200px;
      }

      .app-title {
        font-size: 2.8rem;
      }

      .activity-grid {
        max-width: 420px;
        gap: 20px;
      }

      .activity-btn {
        padding: 28px 20px;
        min-height: 140px;
      }
    }

    /* ===== AGE PICKER SCREEN ===== */
    #agepicker-screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .age-picker-title {
      font-size: 2.4rem;
      font-weight: 800;
      color: #444;
      margin-bottom: 4px;
    }

    .age-picker-sub {
      font-size: 1.05rem;
      color: #888;
      margin-bottom: 24px;
    }

    .age-portal-grid {
      display: flex;
      flex-direction: column;
      gap: 18px;
      width: 92%;
      max-width: 440px;
      padding-bottom: 40px;
    }

    .age-portal-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 22px 16px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      text-align: left;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
    }

    .age-portal-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.18);
    }

    .age-portal-card:active {
      transform: scale(0.97);
    }

    .age-portal-header {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .age-portal-icon {
      font-size: 2.8rem;
    }

    .age-portal-title-wrap {
      flex: 1;
    }

    .age-portal-label {
      font-size: 1.4rem;
      font-weight: 800;
      line-height: 1.2;
    }

    .age-portal-range {
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0.7;
    }

    .age-portal-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .age-portal-tag {
      display: inline-block;
      background: rgba(255, 255, 255, 0.45);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .age-portal-desc {
      font-size: 0.85rem;
      opacity: 0.7;
      font-style: italic;
    }

    .age-portal-tiny {
      background: linear-gradient(135deg, #FFECD2, #FCB69F);
      color: #5D4037;
    }

    .age-portal-explorer {
      background: linear-gradient(135deg, #A1C4FD, #C2E9FB);
      color: #1A237E;
    }

    .age-portal-independent {
      background: linear-gradient(135deg, #D4FC79, #96E6A1);
      color: #1B5E20;
    }

    /* Age mode badge on activity hub */
    .age-mode-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 12px;
      text-align: center;
    }

    .age-mode-badge.badge-tiny {
      background: linear-gradient(135deg, #FFECD2, #FCB69F);
      color: #5D4037;
    }

    .age-mode-badge.badge-explorer {
      background: linear-gradient(135deg, #A1C4FD, #C2E9FB);
      color: #1A237E;
    }

    .age-mode-badge.badge-independent {
      background: linear-gradient(135deg, #D4FC79, #96E6A1);
      color: #1B5E20;
    }

    /* ===== AGE-ADAPTIVE STYLES ===== */

    /* --- TINY (3‚Äì5) --- */
    body.age-tiny .activity-btn {}

    body.age-tiny .activity-btn .icon {}




    body.age-tiny .app-subtitle,
    body.age-tiny .journey-node-desc {
      display: none;
    }

    body.age-tiny .app-title {
      font-size: 2.6rem;
    }

    body.age-tiny .journey-node-title {
      font-size: 1.15rem;
    }

    body.age-tiny .quiz-answer-btn {
      font-size: 1.6rem;
      padding: 20px;
      min-height: 80px;
    }

    body.age-tiny .curriculum-step-label {
      font-size: 1.5rem;
    }

    body.age-tiny #breath-hint {
      font-size: 1.2rem;
    }

    /* --- INDEPENDENT (9‚Äì10) --- */
    body.age-independent .activity-btn {}

    body.age-independent .activity-btn .icon {}

    body.age-independent .why-tip {
      display: block;
      margin-top: 8px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.55);
      border-radius: 12px;
      font-size: 0.85rem;
      color: #555;
      font-style: italic;
      line-height: 1.4;
    }

    .why-tip {
      display: none;
    }

    /* Switch-age link */
    .switch-age-link {
      display: inline-block;
      margin-top: 16px;
      font-size: 0.8rem;
      color: #999;
      cursor: pointer;
      text-decoration: underline;
      background: none;
      border: none;
    }

    .switch-age-link:hover {
      color: #666;
    }

    /* ===== MOOD RESCUE ===== */
    .mood-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      max-width: 400px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .mood-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 18px 10px;
      border: none;
      border-radius: 18px;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .mood-btn:active {
      transform: scale(0.95);
    }

    .mood-btn .mood-emoji {
      font-size: 2.2rem;
    }

    .mood-btn-angry {
      background: linear-gradient(135deg, #FF6B6B, #EE5A24);
    }

    .mood-btn-worried {
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
    }

    .mood-btn-sad {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
    }

    .mood-btn-excited {
      background: linear-gradient(135deg, #fdcb6e, #e17055);
    }

    .mood-btn-sleep {
      background: linear-gradient(135deg, #636e9f, #2d3561);
    }

    .mood-btn-focus {
      background: linear-gradient(135deg, #55efc4, #00b894);
    }

    /* Rescue session screen */
    #rescue-screen {
      justify-content: center;
      text-align: center;
    }

    .rescue-step-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 32px 24px;
      margin: 0 auto 20px;
      max-width: 380px;
      animation: rescueFadeIn 0.6s ease;
    }

    @keyframes rescueFadeIn {
      from {
        opacity: 0;
        transform: translateY(16px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rescue-step-emoji {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .rescue-step-text {
      font-size: 1.2rem;
      font-weight: 500;
      line-height: 1.6;
      color: #fff;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    .rescue-progress {
      width: 80%;
      max-width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 4px;
      margin: 0 auto 20px;
      overflow: hidden;
    }

    .rescue-progress-bar {
      height: 100%;
      background: #fff;
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    .rescue-choice {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      animation: rescueFadeIn 0.6s ease;
    }

    .rescue-choice-btn {
      padding: 16px 40px;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease;
      min-width: 240px;
    }

    .rescue-choice-btn:active {
      transform: scale(0.95);
    }

    .rescue-more-btn {
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
      color: #fff;
    }

    .rescue-done-btn {
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
      backdrop-filter: blur(8px);
    }

    .rescue-title {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 8px;
    }

    /* Mood button on home screen */
    .btn-mood {
      background: linear-gradient(135deg, #ff9ff3, #f368e0) !important;
      grid-column: 1 / -1;
    }

    /* ===== PARENT ZONE ===== */
    .parent-tabs {
      display: flex;
      gap: 4px;
      margin: 0 auto 18px;
      max-width: 440px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 4px;
    }

    .parent-tab {
      flex: 1;
      padding: 10px 6px;
      border: none;
      border-radius: 11px;
      background: transparent;
      color: #555;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .parent-tab.active {
      background: #fff;
      color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .parent-panel {
      display: none;
      max-width: 440px;
      margin: 0 auto;
      width: 92%;
    }

    .parent-panel.active {
      display: block;
    }

    /* Together Mode */
    .together-area {
      text-align: center;
      padding: 20px 0;
    }

    .together-circle-wrap {
      position: relative;
      margin: 20px auto;
      width: 180px;
      height: 180px;
    }

    .together-circle {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(160, 210, 255, 0.8), rgba(130, 180, 240, 0.4));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      transition: transform 1.5s ease-in-out;
      box-shadow: 0 0 40px rgba(130, 180, 240, 0.4);
    }

    .together-circle.inhale {
      transform: scale(1.35);
    }

    .together-circle.exhale {
      transform: scale(0.75);
    }

    .together-label {
      font-size: 1.4rem;
      font-weight: 700;
      color: #555;
      margin: 16px 0 8px;
    }

    .together-sublabel {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .together-start-btn {
      padding: 14px 40px;
      border: none;
      border-radius: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #7B68EE, #9B59B6);
      box-shadow: 0 4px 16px rgba(123, 104, 238, 0.35);
      transition: transform 0.2s;
    }

    .together-start-btn:hover {
      transform: scale(1.05);
    }

    .together-timer {
      font-size: 0.85rem;
      color: #999;
      margin-top: 12px;
    }

    /* Co-Reg Pack */
    .coreg-card {
      background: #fff;
      border-radius: 18px;
      padding: 18px 20px;
      margin-bottom: 14px;
      box-shadow: 0 3px 14px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: transform 0.2s;
    }

    .coreg-card:hover {
      transform: scale(1.02);
    }

    .coreg-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .coreg-info h3 {
      margin: 0 0 4px;
      font-size: 1rem;
      color: #333;
    }

    .coreg-info p {
      margin: 0;
      font-size: 0.85rem;
      color: #888;
    }

    .coreg-info .coreg-time {
      font-size: 0.75rem;
      color: #aaa;
      margin-top: 4px;
    }

    /* Dashboard */
    .dash-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .dash-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.07);
    }

    .dash-card.full-width {
      grid-column: 1 / -1;
    }

    .dash-number {
      font-size: 2rem;
      font-weight: 800;
      color: #7B68EE;
    }

    .dash-label {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }

    .dash-value {
      font-size: 1rem;
      font-weight: 600;
      color: #555;
      margin-top: 4px;
    }

    .dash-note {
      text-align: center;
      font-size: 0.8rem;
      color: #bbb;
      font-style: italic;
      padding: 10px 0;
    }

    /* ===== AFFIRMATIONS ===== */
    .btn-affirmations {
      background: linear-gradient(135deg, #FFD700, #FF8C00) !important;
    }

    .affirmation-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 65vh;
      padding: 20px;
      position: relative;
    }

    .affirmation-card {
      position: relative;
      width: 100%;
      max-width: 360px;
      min-height: 260px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 40px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), inset 0 0 40px rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.25);
      user-select: none;
    }

    .affirmation-card:hover {
      transform: scale(1.03);
    }

    .affirmation-card:active {
      transform: scale(0.97);
    }

    .affirmation-card.glow {
      animation: cardGlow 0.8s ease;
    }

    @keyframes cardGlow {
      0% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      50% {
        box-shadow: 0 0 60px rgba(255, 215, 0, 0.7), 0 0 100px rgba(255, 165, 0, 0.3);
      }

      100% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 8px 32px rgba(0, 0, 0, 0.2);
      }
    }

    .affirmation-emoji {
      font-size: 4rem;
      margin-bottom: 16px;
      animation: floatEmoji 3s ease-in-out infinite;
    }

    @keyframes floatEmoji {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .affirmation-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.4;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .affirmation-counter {
      margin-top: 12px;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .affirmation-card.slide-in-right {
      animation: slideInRight 0.4s ease forwards;
    }

    .affirmation-card.slide-in-left {
      animation: slideInLeft 0.4s ease forwards;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(80px) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-80px) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .affirmation-nav {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 24px;
    }

    .affirmation-nav-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .affirmation-nav-btn:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: scale(1.1);
    }

    .affirmation-nav-btn:disabled {
      opacity: 0.3;
      cursor: default;
      transform: none;
    }

    .affirmation-dots {
      display: flex;
      gap: 8px;
    }

    .affirmation-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s;
    }

    .affirmation-dot.active {
      background: #FFD700;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
      transform: scale(1.3);
    }

    .affirmation-dot.read {
      background: rgba(255, 215, 0, 0.5);
    }

    .affirmation-tap-hint {
      margin-top: 16px;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    /* Confetti sparkles */
    .sparkle-burst {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
    }

    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: sparkleOut 0.8s ease-out forwards;
    }

    @keyframes sparkleOut {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translate(var(--sx), var(--sy)) scale(0);
        opacity: 0;
      }
    }

    .affirmation-speak-btn {
      margin-top: 14px;
      padding: 10px 24px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .affirmation-speak-btn:hover {
      background: rgba(255, 255, 255, 0.35);
    }
  </style>

</head>

<body>

  <!-- AGE PICKER -->
  <div id="agepicker-screen" class="screen">
    <div class="mascot-container">
      <svg class="mascot" viewBox="0 0 200 200">
        <circle cx="100" cy="115" r="65" fill="#D4A574" />
        <circle cx="55" cy="55" r="25" fill="#D4A574" />
        <circle cx="145" cy="55" r="25" fill="#D4A574" />
        <circle cx="55" cy="55" r="15" fill="#C49264" />
        <circle cx="145" cy="55" r="15" fill="#C49264" />
        <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
        <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <circle cx="75" cy="97" r="3" fill="#fff" />
        <circle cx="119" cy="97" r="3" fill="#fff" />
        <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
        <path d="M88 128 Q100 140 112 128" fill="none" stroke="#4A4A6A" stroke-width="2.5" stroke-linecap="round" />
        <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
        <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      </svg>
    </div>
    <h1 class="age-picker-title">Calm Critters</h1>
    <p class="age-picker-sub">Pick your age group to begin!</p>
    <div class="age-portal-grid">

      <button class="age-portal-card age-portal-tiny" onclick="selectAge('tiny')">
        <div class="age-portal-header">
          <span class="age-portal-icon">üß∏</span>
          <div class="age-portal-title-wrap">
            <div class="age-portal-label">Little Cubs</div>
            <div class="age-portal-range">Ages 3‚Äì6</div>
          </div>
        </div>
        <div class="age-portal-preview">
          <span class="age-portal-tag">üßò Meditate</span>
          <span class="age-portal-tag">üéÆ Breath Coach</span>
          <span class="age-portal-tag">üÜò How Am I Feeling?</span>
          <span class="age-portal-tag">‚ú® Affirmations</span>
          <span class="age-portal-tag">üë®‚Äçüë©‚Äçüëß Parent Zone</span>
          <span class="age-portal-tag">‚≠ê Rewards</span>
        </div>
        <div class="age-portal-desc">Bear guides everything with a gentle voice!</div>
      </button>

      <button class="age-portal-card age-portal-explorer" onclick="selectAge('explorer')">
        <div class="age-portal-header">
          <span class="age-portal-icon">üåü</span>
          <div class="age-portal-title-wrap">
            <div class="age-portal-label">Explorers</div>
            <div class="age-portal-range">Ages 6‚Äì8</div>
          </div>
        </div>
        <div class="age-portal-preview">
          <span class="age-portal-tag">üêâ Dragon Breathing</span>
          <span class="age-portal-tag">üê¢ Deep Ocean Dive</span>
          <span class="age-portal-tag">ü¶â Enchanted Forest</span>
          <span class="age-portal-tag">üéÆ Breath Coach</span>
          <span class="age-portal-tag">üÜò Mood Rescue</span>
          <span class="age-portal-tag">‚ú® Affirmations</span>
          <span class="age-portal-tag">üë®‚Äçüë©‚Äçüëß Parent Zone</span>
        </div>
        <div class="age-portal-desc">Adventure narratives with guided exercises</div>
      </button>

      <button class="age-portal-card age-portal-independent" onclick="selectAge('independent')">
        <div class="age-portal-header">
          <span class="age-portal-icon">üèîÔ∏è</span>
          <div class="age-portal-title-wrap">
            <div class="age-portal-label">Trailblazers</div>
            <div class="age-portal-range">Ages 9‚Äì10</div>
          </div>
        </div>
        <div class="age-portal-preview">
          <span class="age-portal-tag">üß† Box & 4-7-8</span>
          <span class="age-portal-tag">üåä Body Scan</span>
          <span class="age-portal-tag">üå≤ 5-4-3-2-1 Grounding</span>
          <span class="age-portal-tag">üéÆ Breath Coach</span>
          <span class="age-portal-tag">üÜò Mood Rescue</span>
          <span class="age-portal-tag">‚ú® Affirmations</span>
          <span class="age-portal-tag">üë®‚Äçüë©‚Äçüëß Parent Zone</span>
        </div>
        <div class="age-portal-desc">Science-backed techniques ‚Äî learn why it works</div>
      </button>

    </div>
  </div>

  <!-- HOME (Activity Hub) -->
  <div id="home-screen" class="screen">
    <button class="back-btn" onclick="showScreen('agepicker')">‚¨ÖÔ∏è</button>
    <div id="age-mode-badge" class="age-mode-badge"></div>
    <div class="mascot-container">
      <svg class="mascot" viewBox="0 0 200 200">
        <circle cx="100" cy="115" r="65" fill="#D4A574" />
        <circle cx="55" cy="55" r="25" fill="#D4A574" />
        <circle cx="145" cy="55" r="25" fill="#D4A574" />
        <circle cx="55" cy="55" r="15" fill="#C49264" />
        <circle cx="145" cy="55" r="15" fill="#C49264" />
        <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
        <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <circle cx="75" cy="97" r="3" fill="#fff" />
        <circle cx="119" cy="97" r="3" fill="#fff" />
        <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
        <path d="M88 128 Q100 140 112 128" fill="none" stroke="#4A4A6A" stroke-width="2.5" stroke-linecap="round" />
        <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
        <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      </svg>
    </div>
    <h1 class="app-title">Calm Critters</h1>
    <p class="app-subtitle">Let's feel calm and happy!</p>
    <button class="journey-btn-featured" onclick="showScreen('journey')">
      <span class="icon">üó∫Ô∏è</span> <span class="btn-label">My Superpower Journey</span>
    </button>
    <div class="activity-grid">
      <button class="activity-btn btn-meditate" onclick="showScreen('meditate')"><span class="icon">üßò</span>
        <span class="btn-label">Meditate</span></button>
      <button class="activity-btn btn-breathcoach" onclick="showScreen('breathcoach')"><span class="icon">üéÆ</span>
        <span class="btn-label">Breath Coach</span></button>
      <button class="activity-btn" onclick="showScreen('parent')"
        style="background: linear-gradient(135deg, #7B68EE, #9B59B6);">
        <span class="icon">üë®‚Äçüë©‚Äçüëß</span>
        <span class="btn-label">Parent Zone</span>
      </button>
      <button class="activity-btn btn-affirmations" onclick="showScreen('affirmations')"><span class="icon">‚ú®</span>
        <span class="btn-label">Affirmations</span></button>
      <button class="activity-btn btn-mood" onclick="showScreen('mood')">
        <span class="icon">üÜò</span>
        <span class="btn-label">How Am I Feeling?</span>
      </button>
      <button class="activity-btn btn-rewards" onclick="showScreen('rewards')"><span class="icon">‚≠ê</span>
        <span class="btn-label">Rewards</span></button>
    </div>
  </div>

  <!-- AFFIRMATIONS -->
  <div id="affirmations-screen" class="screen">
    <button class="back-btn" onclick="closeAffirmations()">‚¨ÖÔ∏è</button>
    <h2 class="screen-title" id="affirmations-title">‚ú® My Affirmations</h2>
    <div class="affirmation-container">
      <div class="affirmation-card" id="affirmation-card" onclick="speakAffirmation()">
        <div class="affirmation-emoji" id="affirmation-emoji">üåü</div>
        <div class="affirmation-text" id="affirmation-text">I am amazing!</div>
        <div class="affirmation-counter" id="affirmation-counter">1 of 10</div>
      </div>
      <button class="affirmation-speak-btn" onclick="speakAffirmation()">üîä Say it out loud!</button>
      <div class="affirmation-nav">
        <button class="affirmation-nav-btn" id="aff-prev-btn" onclick="prevAffirmation()">‚óÄ</button>
        <div class="affirmation-dots" id="affirmation-dots"></div>
        <button class="affirmation-nav-btn" id="aff-next-btn" onclick="nextAffirmation()">‚ñ∂</button>
      </div>
      <div class="affirmation-tap-hint">Tap the card to hear it! ‚ú®</div>
    </div>
  </div>

  <!-- MOOD PICKER -->
  <div id="mood-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">How are you feeling?</h2>
    <p style="color:rgba(255,255,255,0.75); margin-bottom:18px; font-size:0.95rem">Tap the one that fits. Bear will help
      you feel better! üêª</p>
    <div class="mood-grid">
      <button class="mood-btn mood-btn-angry" onclick="startRescue('angry')">
        <span class="mood-emoji">üò§</span> Angry
      </button>
      <button class="mood-btn mood-btn-worried" onclick="startRescue('worried')">
        <span class="mood-emoji">üòü</span> Worried
      </button>
      <button class="mood-btn mood-btn-sad" onclick="startRescue('sad')">
        <span class="mood-emoji">üò¢</span> Sad
      </button>
      <button class="mood-btn mood-btn-excited" onclick="startRescue('excited')">
        <span class="mood-emoji">ü§™</span> Overexcited
      </button>
      <button class="mood-btn mood-btn-sleep" onclick="startRescue('sleep')">
        <span class="mood-emoji">üò¥</span> Can't Sleep
      </button>
      <button class="mood-btn mood-btn-focus" onclick="startRescue('focus')">
        <span class="mood-emoji">üåÄ</span> Can't Focus
      </button>
    </div>
  </div>

  <!-- RESCUE SESSION -->
  <div id="rescue-screen" class="screen">
    <button class="back-btn" onclick="endRescue()" style="color:#fff">‚úï</button>
    <div id="rescue-content"></div>
    <div class="rescue-progress">
      <div class="rescue-progress-bar" id="rescue-progress-bar"></div>
    </div>
  </div>

  <!-- BREATHING -->
  <div id="breathing-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">Breathe with Bear</h2>
    <div class="breathing-area">
      <svg class="mascot-small mascot-breathing" viewBox="0 0 200 200">
        <circle cx="100" cy="115" r="65" fill="#D4A574" />
        <circle cx="55" cy="55" r="25" fill="#D4A574" />
        <circle cx="145" cy="55" r="25" fill="#D4A574" />
        <circle cx="55" cy="55" r="15" fill="#C49264" />
        <circle cx="145" cy="55" r="15" fill="#C49264" />
        <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
        <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <circle cx="75" cy="97" r="3" fill="#fff" />
        <circle cx="119" cy="97" r="3" fill="#fff" />
        <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
        <ellipse cx="100" cy="132" rx="7" ry="5" fill="#C49264" stroke="#4A4A6A" stroke-width="1.5" />
        <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
        <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      </svg>
      <div class="breathing-circle-container">
        <div id="breathing-circle" class="breathing-circle"><span class="breathing-circle-inner">üå∏</span></div>
      </div>
      <div id="breathing-label" class="breathing-label">Tap Start to begin!</div>
      <div id="breathing-counter" class="breathing-counter"></div>
      <button id="breathing-start-btn" class="big-btn big-btn-blue" onclick="toggleBreathing()">‚ñ∂Ô∏è Start</button>
    </div>
  </div>

  <!-- FEELINGS -->
  <div id="feelings-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">How Do You Feel?</h2>
    <svg class="mascot-small" viewBox="0 0 200 200" style="animation: wiggle 2s ease-in-out infinite;">
      <circle cx="100" cy="115" r="65" fill="#D4A574" />
      <circle cx="55" cy="55" r="25" fill="#D4A574" />
      <circle cx="145" cy="55" r="25" fill="#D4A574" />
      <circle cx="55" cy="55" r="15" fill="#C49264" />
      <circle cx="145" cy="55" r="15" fill="#C49264" />
      <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
      <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
      <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
      <circle cx="75" cy="97" r="3" fill="#fff" />
      <circle cx="119" cy="97" r="3" fill="#fff" />
      <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
      <path d="M88 128 Q100 140 112 128" fill="none" stroke="#4A4A6A" stroke-width="2.5" stroke-linecap="round" />
      <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
    </svg>
    <div class="feelings-grid">
      <button class="feeling-btn" onclick="selectFeeling('happy', this)"><span class="icon">üòä</span> Happy</button>
      <button class="feeling-btn" onclick="selectFeeling('calm', this)"><span class="icon">üòå</span> Calm</button>
      <button class="feeling-btn" onclick="selectFeeling('excited', this)"><span class="icon">ü§©</span> Excited</button>
      <button class="feeling-btn" onclick="selectFeeling('sad', this)"><span class="icon">üò¢</span> Sad</button>
      <button class="feeling-btn" onclick="selectFeeling('angry', this)"><span class="icon">üò†</span> Angry</button>
      <button class="feeling-btn" onclick="selectFeeling('scared', this)"><span class="icon">üò®</span> Scared</button>
    </div>
    <div id="feeling-response" class="feeling-response" style="display:none;"></div>
  </div>

  <!-- MEDITATE LIST -->
  <div id="meditate-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">Pick a Journey</h2>
    <div class="meditation-list" id="meditation-list-container"></div>
  </div>

  <!-- MEDITATION PLAYER -->
  <div id="player-screen" class="screen">
    <button class="back-btn" onclick="stopMeditation()">‚¨ÖÔ∏è</button>
    <div class="player-area">
      <div id="player-title" class="player-title">Ocean Waves</div>
      <div class="player-canvas-wrap">
        <canvas id="meditation-canvas"></canvas>
        <div id="subtitle-bar" class="player-subtitle-bar">Get ready...</div>
      </div>
      <div id="player-timer" class="player-timer">2:00</div>
      <div id="voice-status" class="voice-loading"></div>
      <div class="volume-control">
        <label>üîä</label>
        <input type="range" id="volume-slider" min="0" max="100" value="60" oninput="setVolume(this.value)">
      </div>
      <div class="player-controls">
        <button id="player-toggle-btn" class="big-btn big-btn-blue" onclick="toggleMeditationPlayback()">‚è∏Ô∏è
          Pause</button>
        <button class="big-btn big-btn-coral" onclick="stopMeditation()">‚èπÔ∏è Stop</button>
      </div>
    </div>
  </div>

  <!-- REWARDS -->
  <div id="rewards-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">Your Rewards!</h2>
    <svg class="mascot-small" viewBox="0 0 200 200" style="animation: bounce 1.5s ease-in-out infinite;">
      <circle cx="100" cy="115" r="65" fill="#D4A574" />
      <circle cx="55" cy="55" r="25" fill="#D4A574" />
      <circle cx="145" cy="55" r="25" fill="#D4A574" />
      <circle cx="55" cy="55" r="15" fill="#C49264" />
      <circle cx="145" cy="55" r="15" fill="#C49264" />
      <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
      <path d="M70 98 Q78 92 86 98" fill="none" stroke="#4A4A6A" stroke-width="3" stroke-linecap="round" />
      <path d="M114 98 Q122 92 130 98" fill="none" stroke="#4A4A6A" stroke-width="3" stroke-linecap="round" />
      <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
      <path d="M82 128 Q100 148 118 128" fill="none" stroke="#4A4A6A" stroke-width="2.5" stroke-linecap="round" />
      <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
    </svg>
    <div class="rewards-area">
      <div class="streak-display">
        <div class="streak-label">üî• Day Streak</div>
        <div id="streak-number" class="streak-number">0</div>
      </div>
      <div class="stars-display">
        <div class="streak-label">‚≠ê Stars Collected</div>
        <div id="stars-count" class="stars-count">0</div>
        <div id="stars-visual" class="stars-visual"></div>
      </div>
      <div class="recent-feelings">
        <div class="recent-feelings-title">üìù Recent Feelings</div>
        <div id="recent-feelings-list" class="recent-feelings-list">No feelings logged yet!</div>
      </div>
    </div>
  </div>

  <!-- JOURNEY MAP -->
  <div id="journey-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">ü¶∏ Calm Superpowers</h2>
    <svg class="mascot-small" viewBox="0 0 200 200" style="animation: float 3s ease-in-out infinite;">
      <circle cx="100" cy="115" r="65" fill="#D4A574" />
      <circle cx="55" cy="55" r="25" fill="#D4A574" />
      <circle cx="145" cy="55" r="25" fill="#D4A574" />
      <circle cx="55" cy="55" r="15" fill="#C49264" />
      <circle cx="145" cy="55" r="15" fill="#C49264" />
      <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
      <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
      <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
      <circle cx="75" cy="97" r="3" fill="#fff" />
      <circle cx="119" cy="97" r="3" fill="#fff" />
      <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
      <path d="M88 128 Q100 140 112 128" fill="none" stroke="#4A4A6A" stroke-width="2.5" stroke-linecap="round" />
      <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
    </svg>
    <div id="journey-path" class="journey-path">
      <!-- Dynamically rendered by JS -->
    </div>
  </div>

  <!-- CURRICULUM LESSON -->
  <div id="curriculum-lesson-screen" class="screen">
    <button class="back-btn" onclick="stopCurriculumLesson()">‚¨ÖÔ∏è</button>
    <h2 id="curriculum-lesson-title" class="screen-title">Calm Breath</h2>
    <div class="curriculum-area">
      <svg class="mascot-small mascot-breathing" viewBox="0 0 200 200">
        <circle cx="100" cy="115" r="65" fill="#D4A574" />
        <circle cx="55" cy="55" r="25" fill="#D4A574" />
        <circle cx="145" cy="55" r="25" fill="#D4A574" />
        <circle cx="55" cy="55" r="15" fill="#C49264" />
        <circle cx="145" cy="55" r="15" fill="#C49264" />
        <circle cx="100" cy="110" r="55" fill="#E8C9A0" />
        <ellipse cx="78" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <ellipse cx="122" cy="100" rx="7" ry="8" fill="#4A4A6A" />
        <circle cx="75" cy="97" r="3" fill="#fff" />
        <circle cx="119" cy="97" r="3" fill="#fff" />
        <ellipse cx="100" cy="118" rx="10" ry="7" fill="#C49264" />
        <ellipse cx="100" cy="132" rx="7" ry="5" fill="#C49264" stroke="#4A4A6A" stroke-width="1.5" />
        <circle cx="68" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
        <circle cx="132" cy="118" r="10" fill="rgba(255,150,150,0.35)" />
      </svg>
      <div id="curriculum-step-label" class="curriculum-step-label">Get ready...</div>
      <div class="curriculum-progress-bar">
        <div id="curriculum-progress-fill" class="curriculum-progress-fill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- QUIZ OVERLAY -->
  <div id="quiz-overlay" class="quiz-overlay">
    <div class="quiz-box">
      <div style="font-size: 3rem; margin-bottom: 8px;">üß†</div>
      <div id="quiz-question" class="quiz-question">Question goes here?</div>
      <div id="quiz-answers" class="quiz-answers">
        <!-- Dynamically rendered -->
      </div>
      <div id="quiz-feedback" class="quiz-feedback"></div>
    </div>
  </div>

  <!-- REAL-LIFE PROMPT OVERLAY -->
  <div id="reallife-overlay" class="reallife-overlay">
    <div class="reallife-box">
      <div class="reallife-icon">üåü</div>
      <div class="reallife-title">Try This in Real Life!</div>
      <div id="reallife-prompt-text" class="reallife-prompt-text">Prompt goes here</div>
      <button class="reallife-did-it-btn" onclick="completeRealLifePrompt()">I Did It! ‚úã</button>
      <button class="reallife-skip-btn" onclick="skipRealLifePrompt()">Maybe later</button>
    </div>
  </div>

  <!-- CELEBRATION -->
  <div id="celebration-overlay" class="celebration-overlay">
    <div class="celebration-box">
      <div class="celebration-star">üåü</div>
      <div id="celebration-text" class="celebration-text">Great Job!</div>
      <div id="celebration-sub" class="celebration-sub">You earned a star!</div>
      <button class="big-btn big-btn-green" onclick="closeCelebration()">Yay! ‚ú®</button>
    </div>
  </div>
  <div id="confetti-container" class="confetti-container"></div>

  <!-- PARENT ZONE -->
  <div id="parent-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 class="screen-title">üë®‚Äçüë©‚Äçüëß Parent Zone</h2>
    <p style="text-align:center;color:#888;margin:0 0 16px;font-size:0.9rem;">Calm together. Grow together.</p>

    <div class="parent-tabs">
      <button class="parent-tab active" onclick="switchParentTab('together')">ü§ù Together</button>
      <button class="parent-tab" onclick="switchParentTab('coreg')">üíÜ Co-Reg</button>
      <button class="parent-tab" onclick="switchParentTab('dashboard')">üìä Dashboard</button>
    </div>

    <!-- Together Mode -->
    <div id="parent-together" class="parent-panel active">
      <div class="together-area">
        <p style="color:#666;margin:0 0 10px;">Breathe together with your child using one shared animation.</p>
        <div class="together-circle-wrap">
          <div id="together-circle" class="together-circle">ü§ù</div>
        </div>
        <div id="together-label" class="together-label">Ready?</div>
        <div id="together-sublabel" class="together-sublabel">Sit together, place hands on your bellies</div>
        <button id="together-start-btn" class="together-start-btn" onclick="startTogetherMode()">Start
          Breathing</button>
        <div id="together-timer" class="together-timer"></div>
      </div>
    </div>

    <!-- Co-Reg Pack -->
    <div id="parent-coreg" class="parent-panel">
      <p style="color:#666;margin:0 0 14px;text-align:center;">3-minute reset exercises to do together</p>
      <div class="coreg-card" onclick="startCoRegExercise('mirror')">
        <span class="coreg-icon">ü™û</span>
        <div class="coreg-info">
          <h3>Mirror Breathing</h3>
          <p>Face each other and mirror each other's breath</p>
          <div class="coreg-time">~3 minutes</div>
        </div>
      </div>
      <div class="coreg-card" onclick="startCoRegExercise('squeeze')">
        <span class="coreg-icon">ü§ù</span>
        <div class="coreg-info">
          <h3>Squeeze & Release</h3>
          <p>Hold hands, squeeze together, release together</p>
          <div class="coreg-time">~3 minutes</div>
        </div>
      </div>
      <div class="coreg-card" onclick="startCoRegExercise('counting')">
        <span class="coreg-icon">üî¢</span>
        <div class="coreg-info">
          <h3>Counting Calm</h3>
          <p>Count backward from 10 together, one per exhale</p>
          <div class="coreg-time">~3 minutes</div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="parent-dashboard" class="parent-panel">
      <div class="dash-grid">
        <div class="dash-card">
          <div id="dash-skills" class="dash-number">0</div>
          <div class="dash-label">Skills practiced<br>this week</div>
        </div>
        <div class="dash-card">
          <div id="dash-streak" class="dash-number">0</div>
          <div class="dash-label">Day streak</div>
        </div>
        <div class="dash-card">
          <div class="dash-label">Best calming routine</div>
          <div id="dash-best" class="dash-value">‚Äî</div>
        </div>
        <div class="dash-card">
          <div class="dash-label">Recommended next</div>
          <div id="dash-next" class="dash-value">‚Äî</div>
        </div>
      </div>
      <div class="dash-note">üìã Privacy-first: no timestamps, no surveillance ‚Äî just helpful insights.</div>
    </div>
  </div>

  <!-- BREATH COACH PICKER -->
  <div id="breathcoach-screen" class="screen">
    <button class="back-btn" onclick="showScreen('home')">‚¨ÖÔ∏è</button>
    <h2 style="text-align:center;margin-bottom:4px;">üéÆ Breath Coach</h2>
    <p style="text-align:center;color:#888;margin:0 0 12px;">Play games with your real breath!</p>
    <div class="breathcoach-picker">
      <div class="breathcoach-card" onclick="initBreathGame('boat')">
        <span class="card-icon">üö§</span>
        <div class="card-info">
          <h3>Steady Boat</h3>
          <p>Calm the waves with steady breathing</p>
        </div>
      </div>
      <div class="breathcoach-card" onclick="initBreathGame('firefly')">
        <span class="card-icon">üåü</span>
        <div class="card-info">
          <h3>Firefly Glow</h3>
          <p>Light up the forest with long exhales</p>
        </div>
      </div>
      <div class="breathcoach-card" onclick="initBreathGame('bear')">
        <span class="card-icon">üß∏</span>
        <div class="card-info">
          <h3>Calm Bear</h3>
          <p>Help Bear relax with your breath</p>
        </div>
      </div>
      <div id="breathcoach-age-card" class="breathcoach-card" onclick="showScreen('breathing')">
        <span class="card-icon" id="breathcoach-age-icon">üéà</span>
        <div class="card-info">
          <h3 id="breathcoach-age-title">Balloon Game</h3>
          <p id="breathcoach-age-desc">Inflate the balloon with belly breaths</p>
        </div>
      </div>
    </div>
  </div>

  <!-- BREATH GAME -->
  <div id="breathgame-screen" class="screen">
    <button class="back-btn" onclick="stopBreathGame()">‚¨ÖÔ∏è</button>
    <div class="breath-game-header">
      <h2 id="breathgame-title">Steady Boat</h2>
      <div class="breath-timer" id="breath-timer">60</div>
      <span class="breath-indicator" id="breath-indicator"></span>
    </div>
    <canvas id="breath-canvas" class="breath-game-canvas" width="380" height="340"></canvas>
    <div class="exhale-meter-wrap">
      <span class="exhale-meter-label">Exhale Power:</span>
      <div class="exhale-stars" id="exhale-stars">
        <span class="exhale-star" id="estar-1">‚≠ê</span>
        <span class="exhale-star" id="estar-2">‚≠ê</span>
        <span class="exhale-star" id="estar-3">‚≠ê</span>
        <span class="exhale-star" id="estar-4">‚≠ê</span>
        <span class="exhale-star" id="estar-5">‚≠ê</span>
      </div>
    </div>
    <div class="breath-hint" id="breath-hint">Blow gently into the mic ‚Äî or tap & hold the screen</div>
    <div class="breath-goal-banner" id="breath-goal-banner">üö§ Calm the waves!</div>
  </div>

  <!-- GAME TUTORIAL OVERLAY -->
  <div id="mic-prompt-overlay" class="mic-prompt-overlay">
    <div class="mic-prompt-box" style="max-width:380px;">
      <div class="mic-icon" id="tutorial-game-icon">üö§</div>
      <h3 id="tutorial-game-title">Steady Boat</h3>
      <p id="tutorial-game-goal" style="font-size:1.05rem;color:#555;font-weight:600;margin-bottom:14px;">Breathe out
        slowly to calm the ocean waves!</p>

      <div class="tutorial-howto">
        <div class="tutorial-step">
          <span class="tutorial-step-icon">üå¨Ô∏è</span>
          <div class="tutorial-step-text">
            <strong>Breathe out slowly</strong><br>
            <span>The longer you exhale, the better you do!</span>
          </div>
        </div>
        <div class="tutorial-step">
          <span class="tutorial-step-icon">üé§</span>
          <div class="tutorial-step-text">
            <strong>Blow near the microphone</strong><br>
            <span>The game listens to your real breath!</span>
          </div>
        </div>
        <div class="tutorial-step">
          <span class="tutorial-step-icon">üëÜ</span>
          <div class="tutorial-step-text">
            <strong>Or tap & hold the screen</strong><br>
            <span>Hold your finger while breathing out</span>
          </div>
        </div>
      </div>

      <p id="tutorial-game-prize" style="font-size:0.9rem;color:#7B68EE;margin:14px 0 18px;">‚≠ê Earn stars for long, slow
        breaths!</p>

      <div class="mic-btns" style="flex-direction:column;gap:10px;">
        <button class="mic-btn mic-btn-allow" onclick="allowMic()" style="width:100%;padding:14px;font-size:1.1rem;">üé§
          Use My Breath ‚Äî Let's Go!</button>
        <button class="mic-btn mic-btn-skip" onclick="skipMic()" style="width:100%;padding:12px;font-size:0.95rem;">üëÜ
          I'll Tap Instead</button>
      </div>
    </div>
  </div>

  <script>

    // ===== STATE =====
    const STORAGE_KEY = 'calm-critters-data';
    let state = loadState();
    function defaultState() { return { stars: 0, streak: 0, lastActiveDate: null, feelings: [], ageMode: null }; }
    function loadState() { try { const s = localStorage.getItem(STORAGE_KEY); if (s) return { ...defaultState(), ...JSON.parse(s) }; } catch (e) { } return defaultState(); }
    function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { } }
    function addStar() { state.stars++; updateStreak(); saveState(); }
    function updateStreak() {
      const today = new Date().toDateString();
      if (state.lastActiveDate === today) return;
      const y = new Date(); y.setDate(y.getDate() - 1);
      if (state.lastActiveDate === y.toDateString()) state.streak++;
      else if (state.lastActiveDate !== today) state.streak = 1;
      state.lastActiveDate = today;
    }

    // ===== AFFIRMATIONS =====
    const AFFIRMATIONS_BY_AGE = {
      tiny: [
        { emoji: 'üåü', text: 'I am brave and strong!' },
        { emoji: 'üíñ', text: 'I am loved just as I am!' },
        { emoji: 'ü¶Å', text: 'I can do hard things!' },
        { emoji: 'üåà', text: 'My feelings matter!' },
        { emoji: 'üêª', text: 'I am a good friend!' },
        { emoji: '‚ú®', text: 'I make the world brighter!' },
        { emoji: 'üéà', text: "It's okay to make mistakes!" },
        { emoji: 'üåª', text: 'I am kind and caring!' },
        { emoji: 'ü¶ã', text: 'I believe in myself!' },
        { emoji: 'üåô', text: 'I am safe and peaceful!' },
      ],
      explorer: [
        { emoji: 'üöÄ', text: 'I have the power to learn anything!' },
        { emoji: 'üí™', text: 'My mistakes help me grow stronger!' },
        { emoji: 'üåç', text: 'I make a difference in the world!' },
        { emoji: 'üß†', text: 'My brain gets stronger every day!' },
        { emoji: 'üéØ', text: 'I can solve tricky problems!' },
        { emoji: 'üåä', text: 'My calm is my superpower!' },
        { emoji: 'üíé', text: "I am unique and that's my strength!" },
        { emoji: 'üî•', text: 'I choose courage over fear!' },
        { emoji: 'üåü', text: 'I deserve to be happy!' },
        { emoji: 'üõ°Ô∏è', text: "I stand up for what's right!" },
      ],
      independent: [
        { emoji: 'üß≠', text: 'I trust myself to make good choices!' },
        { emoji: 'üå±', text: 'Growth comes from challenges, and I welcome them!' },
        { emoji: 'üí°', text: 'My voice matters and deserves to be heard!' },
        { emoji: 'üèîÔ∏è', text: "I don't have to be perfect to be amazing!" },
        { emoji: 'üîë', text: 'I am in charge of my own happiness!' },
        { emoji: 'üåå', text: 'I have unlimited potential inside me!' },
        { emoji: 'ü§ù', text: 'I lift others up and they lift me!' },
        { emoji: 'üõ§Ô∏è', text: "My journey is unique and that's powerful!" },
        { emoji: '‚ö°', text: 'I transform obstacles into opportunities!' },
        { emoji: 'üå≥', text: 'I am grounded, I am calm, I am enough!' },
      ],
    };

    let currentAffirmationIndex = 0;
    let affirmationReadSet = new Set();

    function getAffirmations() {
      return AFFIRMATIONS_BY_AGE[getAgeMode()] || AFFIRMATIONS_BY_AGE.tiny;
    }

    function renderAffirmationScreen() {
      const mode = getAgeMode();
      const titles = { tiny: 'üåü My Super Affirmations', explorer: 'üöÄ Power Affirmations', independent: '‚ú® Mindful Affirmations' };
      document.getElementById('affirmations-title').textContent = titles[mode] || titles.tiny;
      currentAffirmationIndex = 0;
      affirmationReadSet = new Set();
      renderAffirmationDots();
      showAffirmationCard(0, 'none');
      MeditationMusic.start();
    }

    function renderAffirmationDots() {
      const dots = document.getElementById('affirmation-dots');
      const affs = getAffirmations();
      dots.innerHTML = '';
      for (let i = 0; i < affs.length; i++) {
        const dot = document.createElement('div');
        dot.className = 'affirmation-dot' + (i === currentAffirmationIndex ? ' active' : '') + (affirmationReadSet.has(i) ? ' read' : '');
        dots.appendChild(dot);
      }
    }

    function showAffirmationCard(index, direction) {
      const affs = getAffirmations();
      if (index < 0 || index >= affs.length) return;
      currentAffirmationIndex = index;
      const aff = affs[index];
      const card = document.getElementById('affirmation-card');
      const emoji = document.getElementById('affirmation-emoji');
      const text = document.getElementById('affirmation-text');
      const counter = document.getElementById('affirmation-counter');

      // Remove old animation classes
      card.classList.remove('slide-in-right', 'slide-in-left', 'glow');

      // Set content
      emoji.textContent = aff.emoji;
      text.textContent = aff.text;
      counter.textContent = (index + 1) + ' of ' + affs.length;

      // Trigger animation
      if (direction !== 'none') {
        void card.offsetWidth; // Force reflow
        card.classList.add(direction === 'right' ? 'slide-in-right' : 'slide-in-left');
      }

      // Update nav buttons
      document.getElementById('aff-prev-btn').disabled = index === 0;
      document.getElementById('aff-next-btn').disabled = index === affs.length - 1;

      renderAffirmationDots();
    }

    window.nextAffirmation = function () {
      const affs = getAffirmations();
      if (currentAffirmationIndex < affs.length - 1) {
        showAffirmationCard(currentAffirmationIndex + 1, 'right');
      }
    };

    window.prevAffirmation = function () {
      if (currentAffirmationIndex > 0) {
        showAffirmationCard(currentAffirmationIndex - 1, 'left');
      }
    };

    window.speakAffirmation = function () {
      const affs = getAffirmations();
      const aff = affs[currentAffirmationIndex];
      if (!aff) return;

      // Mark as read
      affirmationReadSet.add(currentAffirmationIndex);
      renderAffirmationDots();

      // Glow animation
      const card = document.getElementById('affirmation-card');
      card.classList.remove('glow');
      void card.offsetWidth;
      card.classList.add('glow');

      // Sparkle confetti burst
      spawnSparkles();

      // Speak the affirmation
      speechSynthesis.cancel();
      stopAllElevenAudio();
      elevenSpeak(aff.text);
    };

    function spawnSparkles() {
      const card = document.getElementById('affirmation-card');
      const rect = card.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      const burst = document.createElement('div');
      burst.className = 'sparkle-burst';
      burst.style.left = cx + 'px';
      burst.style.top = cy + 'px';

      const colors = ['#FFD700', '#FF6B9D', '#C471ED', '#00D2FF', '#FF9A56', '#50E3C2', '#FF5733', '#FFC300'];
      for (let i = 0; i < 20; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        const angle = (i / 20) * Math.PI * 2;
        const dist = 60 + Math.random() * 80;
        s.style.setProperty('--sx', Math.cos(angle) * dist + 'px');
        s.style.setProperty('--sy', Math.sin(angle) * dist + 'px');
        s.style.background = colors[Math.floor(Math.random() * colors.length)];
        s.style.width = (6 + Math.random() * 8) + 'px';
        s.style.height = s.style.width;
        burst.appendChild(s);
      }

      document.body.appendChild(burst);
      setTimeout(() => burst.remove(), 1000);
    }

    window.closeAffirmations = function () {
      MeditationMusic.stop();
      speechSynthesis.cancel();
      stopAllElevenAudio();
      showScreen('home');
    };

    // Swipe gesture support for affirmation cards
    (function () {
      let touchStartX = 0;
      const container = document.getElementById('affirmations-screen');
      if (!container) return;
      container.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      }, { passive: true });
      container.addEventListener('touchend', (e) => {
        const dx = e.changedTouches[0].clientX - touchStartX;
        if (Math.abs(dx) > 50) {
          if (dx < 0) nextAffirmation();
          else prevAffirmation();
        }
      }, { passive: true });
    })();


    // ===== SERVICE WORKER =====
    function getAgeMode() { return state.ageMode || 'explorer'; }

    window.selectAge = function (mode) {
      state.ageMode = mode;
      saveState();
      applyAgeMode();
      updateAgeBadge();
      showScreen('home');
    };

    function applyAgeMode() {
      const mode = getAgeMode();
      document.body.classList.remove('age-tiny', 'age-explorer', 'age-independent');
      document.body.classList.add('age-' + mode);
    }

    function updateAgeBadge() {
      const badge = document.getElementById('age-mode-badge');
      if (!badge) return;
      const mode = getAgeMode();
      const labels = { tiny: 'üß∏ Little Cubs (3‚Äì6)', explorer: 'üåü Explorers (6‚Äì8)', independent: 'üèîÔ∏è Trailblazers (9‚Äì10)' };
      badge.textContent = labels[mode] || '';
      badge.className = 'age-mode-badge badge-' + mode;
    }

    // Boot: always show age picker as landing page
    (function initAgeMode() {
      if (state.ageMode) applyAgeMode();
      document.getElementById('agepicker-screen').classList.add('active');
    })();

    // ===== AGE-ADAPTIVE HELPERS =====

    // Science "why" tips for independent mode (keyed by lesson id)
    const WHY_TIPS = {
      1: 'Deep belly breathing activates your parasympathetic nervous system, which slows your heart rate and helps you feel calm.',
      2: 'Longer exhales stimulate the vagus nerve, which sends a "relax" signal to your brain and body.',
      3: 'Body scanning helps you notice muscle tension early. When you relax those muscles, stress hormones decrease.',
      4: 'Observing thoughts without reacting is called metacognition ‚Äî it strengthens your prefrontal cortex, the brain\'s "wise leader."',
      5: 'Studies show that practicing kindness increases oxytocin and serotonin, chemicals that make you feel happy and connected.',
      6: 'Visualizing colors while breathing uses both brain hemispheres together, improving focus and emotional regulation.',
      7: 'Gentle stretching releases tension stored in fascia (the tissue around muscles) and increases blood flow to your brain.',
      8: 'Labeling thoughts as "bubbles" is a mindfulness technique that creates psychological distance from worries.',
      9: 'Different breathing patterns activate different parts of your nervous system ‚Äî fast for energy, slow for calm.',
      10: 'Gratitude journaling has been shown to increase happiness by 25% and improve sleep quality in scientific studies.',
    };

    // Game timer per age mode
    function getAgeGameTimer() {
      const m = getAgeMode();
      if (m === 'tiny') return 30;
      if (m === 'independent') return 60;
      return 45; // explorer
    }

    // Auto-narrate helper for tiny mode (non-blocking)
    function tinyNarrate(text) {
      if (getAgeMode() !== 'tiny') return;
      // Fire-and-forget ElevenLabs narration
      elevenSpeak(text).catch(() => { });
    }


    const SOUNDS = {
      ocean: 'https://moodist.mvze.net/sounds/nature/waves.mp3',
      forest: 'https://moodist.mvze.net/sounds/animals/birds.mp3',
      space: 'https://moodist.mvze.net/sounds/animals/whale.mp3',
      rain: 'https://moodist.mvze.net/sounds/rain/light-rain.mp3',
    };
    let currentAudio = null;
    let audioVolume = 0.6;

    function playAmbientSound(key) {
      stopAmbientSound();
      currentAudio = new Audio(SOUNDS[key]);
      currentAudio.loop = true;
      currentAudio.volume = audioVolume * 0.4; // lower so voice is clear
      currentAudio.play().catch(() => { });
    }
    function stopAmbientSound() { if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; } }
    window.setVolume = function (val) {
      audioVolume = val / 100;
      if (currentAudio) currentAudio.volume = audioVolume * 0.4;
    };

    function playBell() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.type = 'sine'; osc.frequency.value = 528;
        gain.gain.setValueAtTime(0.4, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
        osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 2.5);
      } catch (e) { }
    }

    // ===== GUIDED MEDITATION SCRIPTS =====
    // Each step: { text (spoken), subtitle (shown on screen), pause (seconds after speech) }
    const SCRIPTS_BY_AGE = {
      // ===== TINY (3-5): Playful, silly, exclamatory =====
      tiny: {
        ocean: [
          { text: "Guess what? We're going on an adventure under the sea! Are you ready? Yaaay!", subtitle: "Under the sea adventure! Yaaay!", pause: 2 },
          { text: "Okay, let's sit down on our magic carpet. It's going to take us underwater! Sit down, sit down!", subtitle: "Sit on the magic carpet!", pause: 3 },
          { text: "Woooosh! Here we go! Look, look! Can you see the fishies? They're waving at you! Wave back! Hi fishies!", subtitle: "Hi fishies! Wave hello!", pause: 3 },
          { text: "Oh wow, a big friendly whale is swimming by! He wants to teach us how to blow bubbles. Let's try! Take a biiiig breath in through your nose, like you're smelling a yummy cookie.", subtitle: "Smell the yummy cookie! Big breath in!", pause: 2 },
          { text: "Now blow out bubbles! Bloop, bloop, bloop! Blow, blow, blow!", subtitle: "Blow bubbles! Bloop bloop bloop!", pause: 3 },
          { text: "Haha, the fishies are playing with your bubbles! They love it! Let's make more. Big sniff in!", subtitle: "The fishies love your bubbles!", pause: 2 },
          { text: "And blow! Bigger bubbles this time! Bloooooop! Amazing!", subtitle: "Bigger bubbles! Bloooooop!", pause: 3 },
          { text: "Now the friendly octopus says shhh, let's be very quiet and listen to the ocean. Can you close your eyes? What do you hear?", subtitle: "Shhh! Close your eyes and listen...", pause: 5 },
          { text: "The water is so warm and cozy, like a big hug. You're floating like a little starfish. Arms out wide, just floating!", subtitle: "Float like a starfish!", pause: 4 },
          { text: "One more magic bubble. Sniff in that ocean air!", subtitle: "One more magic bubble!", pause: 2 },
          { text: "And blow the biggest bubble ever! Pop! Hahaha!", subtitle: "Biggest bubble ever! Pop!", pause: 2 },
          { text: "Time to swim back! Open your eyes! You were the best little diver ever! High five! Give yourself a big squeezy hug!", subtitle: "You're the best diver! Big hug!", pause: 2 },
        ],
        forest: [
          { text: "Pssst! I heard there's a secret party in the magic forest! Wanna go? Let's go!", subtitle: "Secret party in the magic forest!", pause: 2 },
          { text: "Sit down like a little bunny in the soft grass. Tuck your paws in your lap! You're the cutest bunny ever!", subtitle: "Sit like a little bunny!", pause: 3 },
          { text: "Oh look! The butterflies are dancing! They're doing a silly dance! Can you see them wiggle? Wiggle wiggle!", subtitle: "Silly butterfly dance! Wiggle!", pause: 3 },
          { text: "A friendly little bird lands next to you and says, let's play a smelling game! Smell this flower! Sniff in through your nose, biiiig sniff!", subtitle: "Smell the flower! Biiiig sniff!", pause: 2 },
          { text: "Mmmm, it smells like strawberries! Now blow on the flower and watch the petals fly! Whoooo!", subtitle: "Blow the petals! Whoooo!", pause: 3 },
          { text: "Ooh, ooh, smell this one! It's a purple one! Big sniff!", subtitle: "Smell the purple flower!", pause: 2 },
          { text: "This one smells like chocolate cake! Blow the petals! Pfffffft! Hehehe!", subtitle: "Chocolate cake! Blow! Hehehe!", pause: 3 },
          { text: "Now the little squirrel says, let's play a squeezy game! Squeeze your hands super tight like you're holding acorns. Squeeeeeze!", subtitle: "Squeeze the acorns! Squeeeze!", pause: 2 },
          { text: "And let go! Throw the acorns in the air! Wheee! Feel how wiggly and free your fingers are? Wiggle them!", subtitle: "Throw them! Wiggle your fingers!", pause: 3 },
          { text: "Okay close your eyes. The sunshine is giving you a warm hug through the trees. So cozy. The birds are singing you a little song.", subtitle: "Warm sunshine hug... birds singing...", pause: 5 },
          { text: "One more flower smell! Biiig sniff in! Mmmmm!", subtitle: "One more big sniff! Mmmmm!", pause: 2 },
          { text: "And blow a kiss to the forest! Mwah! The forest says thank you!", subtitle: "Blow a kiss! Mwah!", pause: 2 },
          { text: "Open your eyes! The butterflies are clapping for you! You did amazing! You're a forest superstar!", subtitle: "You're a forest superstar!", pause: 2 },
        ],
        space: [
          { text: "Astronaut report to your rocket ship! We're going to space! Sit in your seat! Buckle up!", subtitle: "Buckle up, astronaut!", pause: 2 },
          { text: "Let's count down together! Five, four, three, two, one, BLAST OFF! Whoooooosh!", subtitle: "5... 4... 3... 2... 1... BLAST OFF!", pause: 3 },
          { text: "Wooow! Look out the window! Stars everywhere! They're sparkling like glitter! Can you see them?", subtitle: "Stars like glitter! So sparkly!", pause: 3 },
          { text: "In space, we breathe special space air! Let's fill up our space helmet. Biiiig breath in!", subtitle: "Fill your space helmet! Breathe in!", pause: 2 },
          { text: "Now breathe out super slow like you're fogging up the glass. Haaaaaah. Can you draw a smiley face in the fog?", subtitle: "Fog up the glass! Draw a smiley!", pause: 3 },
          { text: "Haha, that's a great smiley! More space air! Biiiig sniff!", subtitle: "More space air! Big sniff!", pause: 2 },
          { text: "And fog it up again! Haaaaah! Draw a star this time!", subtitle: "Draw a star in the fog!", pause: 3 },
          { text: "Oh look! We're floating! In space everything floats! Let your arms float up slowly. Weeee! You're like a silly space jellyfish!", subtitle: "Float like a space jellyfish!", pause: 3 },
          { text: "Now let them float back down. So gentle. So slow. Like a feather.", subtitle: "Float back down like a feather...", pause: 3 },
          { text: "Close your eyes. The moon is singing you a lullaby. Mmmmm. It's so soft and sparkly up here.", subtitle: "The moon is singing to you...", pause: 5 },
          { text: "One more big breath of magic space air. In!", subtitle: "One more magic space breath!", pause: 2 },
          { text: "And out! Haaaaah! Perfect!", subtitle: "And out! Haaaaah! Perfect!", pause: 2 },
          { text: "Time to fly home! Open your eyes! Wiggle your fingers like twinkling stars! You're the bravest astronaut in the whole galaxy!", subtitle: "Bravest astronaut in the galaxy!", pause: 2 },
        ],
        rain: [
          { text: "Oh listen! Do you hear that? Pitter patter pitter patter! It's raining! Let's have a cozy rain party!", subtitle: "Pitter patter! Cozy rain party!", pause: 2 },
          { text: "Let's sit down and get super cozy. Pretend you have the fluffiest blanket ever wrapped around you! Mmmm so warm!", subtitle: "Super fluffy blanket! So warm!", pause: 3 },
          { text: "Put your hands on your tummy. Your tummy is like a little balloon! When you breathe in, the balloon gets bigger! Try it! Breathe in!", subtitle: "Tummy balloon getting bigger!", pause: 2 },
          { text: "Now breathe out and the balloon gets tiny! Pssshhh! Hehe, do you feel it?", subtitle: "Balloon gets tiny! Pssshhh!", pause: 3 },
          { text: "Let's do it with the rain! When the rain goes pitter, breathe in and your balloon gets big!", subtitle: "Pitter! Balloon gets big!", pause: 2 },
          { text: "When the rain goes patter, breathe out and your balloon gets small! Patter, pssshh!", subtitle: "Patter! Balloon gets small!", pause: 3 },
          { text: "Pitter, breathe in, big balloon!", subtitle: "Pitter! Big balloon!", pause: 2 },
          { text: "Patter, breathe out, tiny balloon! Pssshh! You're so good at this!", subtitle: "Patter! Tiny balloon! So good!", pause: 3 },
          { text: "Now close your eyes. Pretend a tiny friendly raindrop lands on your nose. Boop! Hehehe. And one on your cheek! Boop boop!", subtitle: "Raindrops on your nose! Boop!", pause: 4 },
          { text: "The raindrops are tickling you! They're like tiny little kisses from the clouds. You're so cozy and safe.", subtitle: "Tiny kisses from the clouds!", pause: 4 },
          { text: "One more tummy balloon! Big breath in, biiiiig balloon!", subtitle: "Biggest tummy balloon ever!", pause: 2 },
          { text: "And let it all out. Ahhhh! That was the best balloon yet!", subtitle: "Ahhhh! Best balloon ever!", pause: 2 },
          { text: "Open your eyes! The rain says thank you for playing! You're the coziest little raindrop catcher ever!", subtitle: "Best raindrop catcher ever!", pause: 2 },
        ],
      },
      // ===== EXPLORER (6-8): Adventure narratives, guided journeys =====
      explorer: {
        ocean: [
          { text: "Hey explorer! Today we're diving deep into the ocean. Take a seat, get comfortable, and close your eyes.", subtitle: "üåä Deep ocean dive ‚Äî close your eyes", pause: 3 },
          { text: "Imagine you're putting on a magical scuba suit. It lets you breathe underwater! Take a deep breath in through your nose... and slowly out through your mouth.", subtitle: "Breathe in through nose... out through mouth", pause: 3 },
          { text: "You dive into warm, turquoise water. A sea turtle swims up beside you! She's going to be your guide. Follow her.", subtitle: "üê¢ Follow the sea turtle guide", pause: 4 },
          { text: "She leads you past a coral reef full of colors ‚Äî orange, purple, electric blue. Breathe in deeply as you take it all in.", subtitle: "Colorful coral reef ‚Äî breathe deeply", pause: 3 },
          { text: "Now breathe out and watch tiny bubbles float up toward the sunlight. Each bubble carries away a worry. Let them go.", subtitle: "Bubbles carry worries away...", pause: 4 },
          { text: "A friendly dolphin spins around you! She wants to play. When you breathe in, she jumps. When you breathe out, she dives. Let's try three times.", subtitle: "üê¨ Breathe with the dolphin ‚Äî 3 times", pause: 5 },
          { text: "The turtle leads you into an underwater cave. Inside, the walls glow with soft blue light. It's so peaceful here. Just be still and listen.", subtitle: "Glowing cave ‚Äî be still and listen", pause: 6 },
          { text: "A gentle current rocks you back and forth, like being in a hammock. Let your whole body relax. Your shoulders drop. Your hands go loose.", subtitle: "Rocking gently... body relaxing", pause: 5 },
          { text: "Take one more deep breath, filling your lungs completely. Hold it for three... two... one. And let it all go.", subtitle: "Deep breath... hold... release", pause: 4 },
          { text: "The turtle brings you back to the surface. You pop up and feel the warm sun on your face. Open your eyes. You're calm, strong, and ready for anything!", subtitle: "‚òÄÔ∏è You're calm, strong & ready!", pause: 3 },
        ],
        forest: [
          { text: "Welcome to the enchanted forest, explorer. Find a comfy spot, sit or lie down, and close your eyes.", subtitle: "üå≤ Enchanted forest ‚Äî get comfy", pause: 3 },
          { text: "You're standing in a clearing. Tall trees surround you like gentle giants. Sunlight filters through the leaves in golden beams.", subtitle: "Golden sunlight through the trees", pause: 4 },
          { text: "A wise old owl lands on a branch nearby. She whispers: Take three slow breaths with me. In through your nose... out through your mouth.", subtitle: "ü¶â Three slow breaths with the owl", pause: 5 },
          { text: "As you breathe, notice the smell of the forest. Fresh pine, damp earth, sweet wildflowers. Each breath fills you with calm.", subtitle: "Smell the forest ‚Äî pine and flowers", pause: 4 },
          { text: "A path appears between the trees, covered in soft moss. You walk barefoot and feel the cool, squishy moss under your feet. It tickles a little!", subtitle: "üçÉ Soft moss path ‚Äî feel your feet", pause: 4 },
          { text: "You come to a stream with stepping stones. Each stone has a word on it: brave, kind, strong, loved. Step on each one and say the word in your mind.", subtitle: "Stepping stones: brave, kind, strong, loved", pause: 5 },
          { text: "By the stream, a deer is drinking water. She looks up and nods at you. You sit beside her. Everything is quiet except the water.", subtitle: "ü¶å Sitting with the deer by the stream", pause: 6 },
          { text: "Count five sounds you can hear. The stream, the birds, the leaves rustling, your own breathing, your heartbeat.", subtitle: "Count 5 sounds around you", pause: 5 },
          { text: "Take one big forest breath ‚Äî breathe in all the green, growing energy. Breathe out anything that was bothering you today.", subtitle: "Breathe in green energy, breathe out worries", pause: 4 },
          { text: "The owl hoots softly ‚Äî time to head home. Open your eyes and stretch your arms wide like tree branches. You carry the forest's peace with you!", subtitle: "üåø Carry the forest peace with you!", pause: 3 },
        ],
        space: [
          { text: "Mission control to explorer! You've been selected for a special space mission. Get comfy in your commander's seat and close your eyes.", subtitle: "üöÄ Space mission ‚Äî close your eyes", pause: 3 },
          { text: "Your rocket lifts off smoothly. You feel the gentle push as you rise above the clouds. Take a slow breath in for the countdown.", subtitle: "Lifting off above the clouds", pause: 3 },
          { text: "Now you're past the atmosphere. Press your face to the window. Earth below you is so beautiful ‚Äî blue oceans, white clouds, green land.", subtitle: "üåç Beautiful Earth from above", pause: 4 },
          { text: "In your spaceship, gravity is gentle. Lift your hands slowly, let them float up. Now let them drift back down. So light and free.", subtitle: "Floating hands ‚Äî light and free", pause: 4 },
          { text: "Your ship approaches a nebula ‚Äî a giant cloud of stardust in pinks, purples, and golds. Breathe in the stardust energy. Feel it sparkle inside you.", subtitle: "‚ú® Breathing in stardust energy", pause: 5 },
          { text: "Saturn's rings stretch out like a runway. Your ship glides between them. It's so smooth, so peaceful. Let your breathing be just as smooth.", subtitle: "ü™ê Gliding through Saturn's rings", pause: 5 },
          { text: "You park on a quiet moon. Step outside ‚Äî it's perfectly silent. No sounds at all. Just you and the stars. Feel how peaceful silence can be.", subtitle: "Perfect silence on the moon", pause: 6 },
          { text: "Look up at the Milky Way ‚Äî billions of stars, and you're one of them. You are part of something huge and amazing.", subtitle: "You're part of something amazing", pause: 5 },
          { text: "Take one deep space breath. In for four... hold for four... out for four. The universe breathes with you.", subtitle: "Space breath ‚Äî 4 in, 4 hold, 4 out", pause: 5 },
          { text: "Time to head home. Your rocket turns toward Earth. Open your eyes and feel the ground beneath you. You just traveled the universe! How cool is that?", subtitle: "üåé Welcome home, space explorer!", pause: 3 },
        ],
        rain: [
          { text: "It's a rainy afternoon. You're inside a cozy treehouse high in the branches. Find a comfy spot and close your eyes.", subtitle: "üåßÔ∏è Cozy treehouse in the rain", pause: 3 },
          { text: "Listen to the rain tapping on the wooden roof above you. Tap, tap, tap. Each drop is like a tiny drumbeat just for you.", subtitle: "Rain drumming on the roof", pause: 4 },
          { text: "Breathe in slowly. The air smells fresh and clean, like a just-washed world. Breathe out any stress from the day.", subtitle: "Fresh rain air ‚Äî breathe out stress", pause: 4 },
          { text: "You have a warm cup of cocoa. Wrap your hands around it. Feel the warmth spreading from your palms up your arms, all the way to your shoulders.", subtitle: "‚òï Warm cocoa ‚Äî warmth spreading", pause: 4 },
          { text: "The rain gets softer, steadier. It becomes a rhythm. Match your breathing to it. In with the drip... out with the drop.", subtitle: "Breathe with the rain rhythm", pause: 5 },
          { text: "A rainbow appears through the treehouse window! Seven beautiful colors arching across the grey sky. Pick your favorite color.", subtitle: "üåà Rainbow through the window", pause: 4 },
          { text: "Imagine that color filling your whole body. Starting from your toes, rising up through your legs, your belly, your chest, your head. You're glowing with your favorite color!", subtitle: "Your body glows with your color", pause: 5 },
          { text: "The rain slows to a gentle mist. Birds start singing again. A squirrel peeks into the treehouse and chatters hello.", subtitle: "üêøÔ∏è The rain slows ‚Äî birds sing", pause: 4 },
          { text: "Take one deep, cozy breath. Hold it like you're keeping a warm secret. And release.", subtitle: "One deep cozy breath", pause: 4 },
          { text: "The sun peeks through the clouds. Open your eyes and stretch. You're warm, calm, and ready to go. The rain said exactly what you needed to hear.", subtitle: "‚òÄÔ∏è Warm, calm, and ready!", pause: 3 },
        ],
      },
      // ===== INDEPENDENT (9-10): Mindfulness, body scan, self-awareness =====
      independent: {
        ocean: [
          { text: "Find a comfortable position. Close your eyes. We're going to use ocean visualization to practice deep relaxation.", subtitle: "Deep relaxation through ocean visualization", pause: 3 },
          { text: "Start with three cleansing breaths. In through your nose for four counts. Out through your mouth for six. Make each exhale longer than the inhale ‚Äî this activates your body's calm response.", subtitle: "4-count inhale, 6-count exhale √ó 3", pause: 6 },
          { text: "Imagine you're floating in warm, calm ocean water. Your body is completely supported. You don't have to hold anything up. Let gravity do the work.", subtitle: "Floating ‚Äî let your body be supported", pause: 5 },
          { text: "Do a body scan starting with your feet. Notice ‚Äî are they tense or relaxed? Wiggle your toes, then let them go completely soft. Move up to your ankles, your calves.", subtitle: "Body scan: feet ‚Üí ankles ‚Üí calves", pause: 6 },
          { text: "Continue up. Your thighs, your hips. If you find tension anywhere, breathe into that spot. Imagine the ocean water dissolving the tightness.", subtitle: "Breathe into any tension you find", pause: 6 },
          { text: "Now your belly, your chest. Notice your breath here. Is it fast or slow? Deep or shallow? Don't change it, just notice.", subtitle: "Notice your breath without changing it", pause: 5 },
          { text: "Ocean waves have a pattern: they rise, they crest, they fall. Your thoughts work the same way. When a thought comes, don't fight it. Watch it rise, crest, and dissolve, like a wave.", subtitle: "üåä Thoughts are like waves ‚Äî watch them pass", pause: 7 },
          { text: "Now scan your shoulders, your jaw, your forehead. These are where most people hold stress. Consciously release each one. Drop your shoulders. Unclench your jaw. Smooth your forehead.", subtitle: "Release shoulders, jaw, forehead", pause: 6 },
          { text: "Here's something interesting: your brain can't tell the difference between vividly imagining calm and actually being calm. So right now, your brain genuinely thinks you're floating in the ocean.", subtitle: "Your brain responds to visualization as if it's real", pause: 5 },
          { text: "Take three final breaths. With each one, say a word silently: Calm. Strong. Ready. When you open your eyes, you'll carry this ocean calm with you.", subtitle: "Three words: Calm. Strong. Ready.", pause: 5 },
          { text: "Gently wiggle your fingers and toes. Open your eyes. That body scan technique is a tool you can use anywhere ‚Äî in your room, before a test, even on the bus.", subtitle: "This technique: use it anywhere, anytime", pause: 3 },
        ],
        forest: [
          { text: "Sit comfortably. Close your eyes. We're going to practice grounding ‚Äî a technique that connects you to the present moment using your senses.", subtitle: "Grounding: connecting to the present moment", pause: 3 },
          { text: "Imagine you're in a quiet forest. Start by noticing five things you can see in your mind's eye: the bark on trees, light through leaves, moss on rocks, a bird on a branch, a path ahead.", subtitle: "5 things you see", pause: 6 },
          { text: "Now four things you might touch: rough bark under your hand, cool breeze on your skin, soft earth under your feet, a smooth pebble in your pocket.", subtitle: "4 things you touch", pause: 5 },
          { text: "Three things you'd hear: birds calling, wind in the leaves, a distant stream. Really hear them in your mind.", subtitle: "3 things you hear", pause: 5 },
          { text: "Two things you'd smell: fresh pine needles and damp earth after rain.", subtitle: "2 things you smell", pause: 4 },
          { text: "One thing you'd taste: clean, cool mountain air.", subtitle: "1 thing you taste", pause: 3 },
          { text: "This is called the 5-4-3-2-1 method. It works because anxiety lives in the future. When you engage your senses, you pull your brain back to right now, where you're safe.", subtitle: "5-4-3-2-1 grounds you in the NOW", pause: 5 },
          { text: "Let's add breath to it. Breathe in for four counts... hold for four... out for four... hold for four. This is box breathing ‚Äî it balances your nervous system.", subtitle: "Box breathing: 4-4-4-4", pause: 7 },
          { text: "Do two more rounds of box breathing. There's no rush. If your mind wanders, that's normal ‚Äî just gently bring it back. That 'bringing back' is the exercise. Every time you do it, your focus gets stronger.", subtitle: "Mind wandering is normal ‚Äî bring it back", pause: 8 },
          { text: "Take one final deep breath. Open your eyes slowly. The 5-4-3-2-1 grounding method is yours now. Use it anytime you feel overwhelmed or scattered.", subtitle: "You now have: 5-4-3-2-1 + box breathing", pause: 3 },
        ],
        space: [
          { text: "Get comfortable. Close your eyes. Today we're going to explore perspective ‚Äî and there's no better place for that than space.", subtitle: "Exploring perspective through space", pause: 3 },
          { text: "Begin with five slow breaths. In for four, out for six. Each exhale slightly longer than the inhale. This tells your nervous system it's safe to relax.", subtitle: "5 breaths: 4-in, 6-out. Calm signal.", pause: 7 },
          { text: "Imagine you're rising above your room, above your building, above your neighborhood. You can see the whole town below, then the whole country. Keep rising.", subtitle: "Rising higher and higher above Earth", pause: 5 },
          { text: "From up here, you can see the curve of the Earth. The blue atmosphere, thin as an eggshell. All the people, all the drama, all the worries ‚Äî they look so small from here.", subtitle: "üåç Everything looks smaller from above", pause: 6 },
          { text: "This is called cognitive distancing. When you zoom out in your mind, problems feel more manageable. They're still real ‚Äî but they're not the whole picture.", subtitle: "Cognitive distancing: zoom out to manage stress", pause: 5 },
          { text: "Now let's do a progressive relaxation. Tense your feet for five seconds... and release. Tense your legs... and release. Tense your belly... and release.", subtitle: "Progressive relaxation: tense ‚Üí release √ó3", pause: 7 },
          { text: "Tense your hands into fists... and release. Scrunch your shoulders toward your ears... and drop them. Scrunch your face tight... and let it melt away.", subtitle: "Hands ‚Üí shoulders ‚Üí face: tense and release", pause: 7 },
          { text: "Notice how different your body feels when tension is gone. That heavy, warm feeling? That's your parasympathetic nervous system ‚Äî your body's built-in chill mode.", subtitle: "That warm feeling = your body's chill mode", pause: 5 },
          { text: "From space, think about one thing you're grateful for today. Research shows gratitude physically changes your brain, growing the areas that handle empathy and wellbeing.", subtitle: "Gratitude literally rewires your brain", pause: 6 },
          { text: "Slowly drift back to Earth. Feel your body in your seat. Open your eyes. You just used perspective, progressive relaxation, and gratitude ‚Äî three powerful mental health tools.", subtitle: "You now have 3 tools: perspective, relaxation, gratitude", pause: 3 },
        ],
        rain: [
          { text: "Settle in somewhere comfortable. Close your eyes. We're going to practice acceptance meditation using the metaphor of rain.", subtitle: "Acceptance meditation ‚Äî the rain metaphor", pause: 3 },
          { text: "Imagine sitting under a solid shelter while rain pours around you. You're dry, safe, watching the rain. Start with deep belly breaths ‚Äî feel your stomach expand as you inhale.", subtitle: "Belly breathing under shelter", pause: 5 },
          { text: "The rain represents all the things you can't control: other people's opinions, unexpected changes, things that didn't go your way today.", subtitle: "üåßÔ∏è Rain = things you can't control", pause: 5 },
          { text: "Here's the key: you don't have to stop the rain. You can't. But you can choose to stay dry. Staying dry means not letting external things control how you feel inside.", subtitle: "You can't stop the rain. You CAN stay dry.", pause: 6 },
          { text: "Notice any emotions you're feeling right now. Name them without judging: 'I notice I feel nervous.' 'I notice I feel tired.' Naming emotions reduces their power ‚Äî scientists call this 'affect labeling.'", subtitle: "Name your emotions to reduce their power", pause: 6 },
          { text: "The rain begins to ease. Each breath now is like pressing a reset button. In: fresh energy. Out: anything you don't need anymore.", subtitle: "Reset breaths: in = fresh energy, out = release", pause: 5 },
          { text: "Let's practice square breathing to deepen the calm. Inhale 4 counts... hold 4... exhale 4... hold 4. Imagine tracing a square with each breath.", subtitle: "Square breathing: trace the shape", pause: 7 },
          { text: "Fun fact: Navy SEALs use square breathing before high-pressure missions. If it works for them, it definitely works for school, friendships, and everything else you navigate.", subtitle: "Navy SEALs use this! It works.", pause: 5 },
          { text: "The rain stops. Sunlight breaks through. A rainbow appears. Rainbows only happen because of the rain. Some good things in your life also came from hard moments.", subtitle: "üåà Rainbows need rain. Growth needs challenge.", pause: 6 },
          { text: "Open your eyes gently. Today you practiced acceptance, affect labeling, and square breathing. Three techniques backed by real science, available to you whenever you need them.", subtitle: "3 science-backed tools: acceptance, labeling, square breathing", pause: 3 },
        ],
      },
    };

    // ===== MOOD RESCUE ROUTINES (90-second interactive) =====
    const RESCUE_ROUTINES = {
      angry: {
        emoji: 'üò§',
        label: 'Angry',
        color: '#EE5A24',
        steps: [
          { emoji: 'üêª', text: 'Hey, it\'s OK to feel angry. Bear is here with you. Let\'s cool that fire down together.', duration: 12 },
          { emoji: 'üå¨Ô∏è', text: 'Take a BIG breath in through your nose‚Ä¶ 1‚Ä¶ 2‚Ä¶ 3‚Ä¶ 4‚Ä¶ Now BLOW it out hard, like you\'re blowing out birthday candles! Do it 3 times.', duration: 20 },
          { emoji: 'üí™', text: 'Squeeze your fists as TIGHT as you can‚Ä¶ hold it‚Ä¶ hold it‚Ä¶ now let them go soft like spaghetti. Shake your hands out!', duration: 18 },
          { emoji: 'üßä', text: 'Imagine holding a big, cool ice cube. Feel the cool calm spreading from your hands into your whole body.', duration: 15 },
          { emoji: 'üåà', text: 'The angry feeling is just a cloud passing by. You are the sky ‚Äî big, calm, and full of space. You\'ve got this!', duration: 15 },
          { emoji: '‚≠ê', text: 'Amazing job! You turned your fire into sunshine. Bear is so proud of you! ‚òÄÔ∏è', duration: 10 },
        ],
      },
      worried: {
        emoji: 'üòü',
        label: 'Worried',
        color: '#6c5ce7',
        steps: [
          { emoji: 'üêª', text: 'Worries can feel really big. But Bear is right here with you. Let\'s make those worries smaller together.', duration: 12 },
          { emoji: 'üéà', text: 'Breathe in slowly‚Ä¶ imagine you\'re filling a balloon in your belly‚Ä¶ Now let the air out sloooowly. The balloon floats away, carrying one worry with it.', duration: 20 },
          { emoji: 'ü¶∂', text: 'Press your feet into the floor. Feel them? You\'re solid. You\'re safe. Wiggle your toes and feel the ground holding you up.', duration: 18 },
          { emoji: 'üß∏', text: 'Now hug yourself! Wrap your arms around your shoulders and give a gentle squeeze. You\'re giving yourself a bear hug!', duration: 15 },
          { emoji: 'üí≠', text: 'Worries are just "what if" thoughts. They\'re not real yet. Right now, in this moment, you are safe and you are OK.', duration: 15 },
          { emoji: '‚≠ê', text: 'You did it! Your worries just got a lot smaller. Bear believes in you! üåü', duration: 10 },
        ],
      },
      sad: {
        emoji: 'üò¢',
        label: 'Sad',
        color: '#0984e3',
        steps: [
          { emoji: 'üêª', text: 'It\'s OK to feel sad. Everybody does sometimes. Bear is sitting right next to you. You\'re not alone.', duration: 12 },
          { emoji: 'üí®', text: 'Let\'s do some gentle breaths together. Breathe in warmth‚Ä¶ breathe out the heavy feeling‚Ä¶ Again‚Ä¶ nice and easy.', duration: 18 },
          { emoji: 'ü´∂', text: 'Put your hand on your heart. Can you feel it beating? That\'s your body saying "I\'m here. I\'m strong. I\'m alive."', duration: 18 },
          { emoji: '‚òÄÔ∏è', text: 'Think of ONE thing that made you smile this week. A friend, a pet, a yummy snack‚Ä¶ Hold that happy picture in your mind.', duration: 18 },
          { emoji: 'üåä', text: 'Sadness is like a wave. It comes, and then it goes. You\'re learning to ride the wave, and that makes you really brave.', duration: 14 },
          { emoji: '‚≠ê', text: 'You\'re so brave for letting your feelings out. Bear is always here when you need a friend! üíõ', duration: 10 },
        ],
      },
      excited: {
        emoji: 'ü§™',
        label: 'Overexcited',
        color: '#e17055',
        steps: [
          { emoji: 'üêª', text: 'Woah, you\'ve got a LOT of energy! That\'s awesome ‚Äî let\'s help your body use it in a good way!', duration: 10 },
          { emoji: 'üèÉ', text: 'First, shake your whole body! Wiggle your arms, stomp your feet, shake shake shake! Get all that energy out for 10 seconds!', duration: 15 },
          { emoji: 'üßä', text: 'Now FREEZE! Stand totally still like a statue. Don\'t move a muscle‚Ä¶ Hold it‚Ä¶ 5‚Ä¶ 4‚Ä¶ 3‚Ä¶ 2‚Ä¶ 1.', duration: 15 },
          { emoji: 'üå¨Ô∏è', text: 'Slow breath in‚Ä¶ 1‚Ä¶ 2‚Ä¶ 3‚Ä¶ 4‚Ä¶ Slow breath out‚Ä¶ 1‚Ä¶ 2‚Ä¶ 3‚Ä¶ 4‚Ä¶ 5‚Ä¶ 6. Feel your body getting calmer with each breath.', duration: 20 },
          { emoji: 'üéØ', text: 'Look around and find 3 blue things. Got them? Now find 2 soft things. This helps your brain slow down and focus.', duration: 18 },
          { emoji: '‚≠ê', text: 'You turned all that big energy into calm power! That\'s a superpower! ü¶∏', duration: 12 },
        ],
      },
      sleep: {
        emoji: 'üò¥',
        label: 'Can\'t Sleep',
        color: '#2d3561',
        steps: [
          { emoji: 'üêª', text: 'Can\'t sleep? That happens to everyone. Close your eyes and let Bear help you drift off‚Ä¶', duration: 12 },
          { emoji: 'üåô', text: 'Take a long, sleepy breath in‚Ä¶ and a soft breath out‚Ä¶ like blowing a feather across your pillow. Again‚Ä¶ soooo gentle‚Ä¶', duration: 20 },
          { emoji: 'ü¶∂', text: 'Imagine warm honey slowly pouring onto your toes‚Ä¶ it\'s spreading up your feet‚Ä¶ your legs feel heavy and warm and sleepy‚Ä¶', duration: 18 },
          { emoji: 'ü´∂', text: 'The warm honey spreads to your belly‚Ä¶ your chest‚Ä¶ your arms go floppy‚Ä¶ your fingers tingle with cozy warmth‚Ä¶', duration: 18 },
          { emoji: '‚òÅÔ∏è', text: 'Now it\'s all around your head‚Ä¶ like a warm, soft cloud pillow‚Ä¶ Your eyes are heavy‚Ä¶ everything is safe and quiet‚Ä¶', duration: 15 },
          { emoji: 'üåü', text: 'Goodnight, little one. Bear is watching over you. Sweet dreams‚Ä¶ üí§', duration: 10 },
        ],
      },
      focus: {
        emoji: 'üåÄ',
        label: 'Can\'t Focus',
        color: '#00b894',
        steps: [
          { emoji: 'üêª', text: 'Brain feeling scrambled? That\'s OK! Bear has a trick to help your mind get clear and sharp.', duration: 10 },
          { emoji: 'üå¨Ô∏è', text: 'Let\'s reset your brain. Breathe in for 4‚Ä¶ hold for 4‚Ä¶ out for 4‚Ä¶ hold for 4‚Ä¶ This is called Box Breathing. Try it twice!', duration: 22 },
          { emoji: 'üëÉ', text: 'Now notice 5 things you can SEE‚Ä¶ 4 things you can TOUCH‚Ä¶ 3 things you can HEAR‚Ä¶ This wakes up your senses!', duration: 18 },
          { emoji: '‚úä', text: 'Make fists, then open wide! Fists‚Ä¶ open! Fists‚Ä¶ open! This tells your brain: "Wake up, it\'s time to focus!"', duration: 15 },
          { emoji: 'üéØ', text: 'Pick ONE small thing you need to do next. Just one! Don\'t think about everything ‚Äî just that one thing.', duration: 15 },
          { emoji: '‚≠ê', text: 'Your brain is ready! You\'ve got laser focus now. Go get it, superstar! üöÄ', duration: 10 },
        ],
      },
    };

    // Extension routines (60 seconds of additional calming)
    const RESCUE_EXTENSIONS = {
      angry: [
        { emoji: 'üå¨Ô∏è', text: 'Let\'s do 3 more slow breaths. In‚Ä¶ hold‚Ä¶ out‚Ä¶ Feel the calm getting stronger each time.', duration: 18 },
        { emoji: 'üßò', text: 'Imagine your anger is a red ball. Watch it slowly change to orange‚Ä¶ yellow‚Ä¶ green‚Ä¶ blue. Cooler and calmer.', duration: 20 },
        { emoji: 'üíõ', text: 'Think of someone you love. Send them a kind thought. Kindness is the opposite of anger, and you have so much of it!', duration: 22 },
      ],
      worried: [
        { emoji: 'üåä', text: 'Imagine you\'re lying on a warm beach. Hear the waves going in‚Ä¶ and out‚Ä¶ in‚Ä¶ and out‚Ä¶ so peaceful.', duration: 20 },
        { emoji: 'ü¶Å', text: 'You are braver than you think! Name one brave thing you did this week. See? You handle hard things!', duration: 20 },
        { emoji: 'üåà', text: 'Picture a worry jar. Put each worry into the jar and close the lid tight. You can think about them later ‚Äî or not!', duration: 20 },
      ],
      sad: [
        { emoji: 'ü§ó', text: 'Give yourself another warm hug. You deserve kindness, especially from yourself.', duration: 18 },
        { emoji: 'üé®', text: 'If your sadness were a colour, what would it be? Now imagine painting over it with your favourite bright colour.', duration: 22 },
        { emoji: 'üåª', text: 'Say this quietly: "I am loved. I am enough. This feeling will pass, and bright days are coming."', duration: 20 },
      ],
      excited: [
        { emoji: 'üê¢', text: 'Let\'s move in slow motion. Raise your hand very, very, veeeeery slowly. Now put it down slowly. Feel the control!', duration: 20 },
        { emoji: 'üßò', text: 'Close your eyes and count backwards from 10‚Ä¶ 9‚Ä¶ 8‚Ä¶ 7‚Ä¶ 6‚Ä¶ 5‚Ä¶ 4‚Ä¶ 3‚Ä¶ 2‚Ä¶ 1‚Ä¶ Zero. Still and calm.', duration: 20 },
        { emoji: 'üéµ', text: 'Hum a low, slow note. Mmmmmmmm‚Ä¶ Feel the vibration in your chest. This tells your body to calm down.', duration: 20 },
      ],
      sleep: [
        { emoji: 'üåô', text: 'Keep your eyes closed‚Ä¶ count sheep jumping over a tiny fence‚Ä¶ 1‚Ä¶ 2‚Ä¶ 3‚Ä¶ 4‚Ä¶ 5‚Ä¶ so sleepy‚Ä¶', duration: 20 },
        { emoji: 'üå¨Ô∏è', text: 'Each breath out is longer than the one before. Out‚Ä¶ 4 counts. Out‚Ä¶ 5 counts. Out‚Ä¶ 6 counts. Out‚Ä¶ 7 counts‚Ä¶', duration: 20 },
        { emoji: 'üí§', text: 'Your body is so heavy‚Ä¶ so warm‚Ä¶ so safe‚Ä¶ Bear is right beside you. Sleep now‚Ä¶', duration: 20 },
      ],
      focus: [
        { emoji: 'üî¢', text: 'Count backwards from 20 to 1 in your head. Don\'t rush! If you lose your place, start again from 20.', duration: 20 },
        { emoji: 'üëÅÔ∏è', text: 'Pick a spot on the wall and stare at it for 10 seconds without blinking. Your eyes are lasers! Feel the focus!', duration: 18 },
        { emoji: '‚úÖ', text: 'Whisper your ONE task out loud 3 times. Saying it makes it real. Now go do just that ONE thing! You\'ve got this!', duration: 22 },
      ],
    };

    let rescueStopped = false;
    let currentRescueMood = null;

    window.startRescue = async function (mood) {
      currentRescueMood = mood;
      rescueStopped = false;
      const routine = RESCUE_ROUTINES[mood];
      if (!routine) return;

      showScreen('rescue');

      // Tiny mode: narrate the intro
      tinyNarrate('Bear is here to help you feel better!');

      await runRescueSteps(routine.steps, routine);

      if (!rescueStopped) {
        showRescueChoice(mood);
      }
    };

    async function runRescueSteps(steps, routine) {
      const contentEl = document.getElementById('rescue-content');
      const progressBar = document.getElementById('rescue-progress-bar');
      const totalDuration = steps.reduce((sum, s) => sum + s.duration, 0);
      let elapsed = 0;

      for (let i = 0; i < steps.length; i++) {
        if (rescueStopped) return;

        const step = steps[i];
        // Update progress
        progressBar.style.width = Math.round((elapsed / totalDuration) * 100) + '%';

        // Render step card
        contentEl.innerHTML = `
          <div class="rescue-step-card" style="border: 2px solid ${routine.color}40">
            <div class="rescue-step-emoji">${step.emoji}</div>
            <div class="rescue-step-text">${step.text}</div>
          </div>
          <p class="rescue-title">${routine.emoji} ${routine.label} Rescue ‚Äî Step ${i + 1}/${steps.length}</p>
        `;

        // Speak the step (using the existing TTS engine)
        const speakPromise = speakStep(step.text);

        // Wait for duration OR speech to finish (whichever is longer)
        await Promise.all([
          speakPromise,
          new Promise(r => setTimeout(r, step.duration * 1000)),
        ]);

        elapsed += step.duration;
      }

      // Final progress
      progressBar.style.width = '100%';
    }

    function showRescueChoice(mood) {
      const contentEl = document.getElementById('rescue-content');
      contentEl.innerHTML = `
        <div class="rescue-step-card">
          <div class="rescue-step-emoji">üêª</div>
          <div class="rescue-step-text">How are you feeling now?</div>
        </div>
        <div class="rescue-choice">
          <button class="rescue-choice-btn rescue-more-btn" onclick="extendRescue('${mood}')">
            üïê Another 60 seconds
          </button>
          <button class="rescue-choice-btn rescue-done-btn" onclick="endRescue()">
            ‚úÖ I'm OK now!
          </button>
        </div>
      `;

      tinyNarrate('How are you feeling? Do you want another minute, or are you OK now?');
    }

    window.extendRescue = async function (mood) {
      const extension = RESCUE_EXTENSIONS[mood];
      const routine = RESCUE_ROUTINES[mood];
      if (!extension || !routine) { endRescue(); return; }

      document.getElementById('rescue-progress-bar').style.width = '0%';

      await runRescueSteps(extension, routine);

      if (!rescueStopped) {
        // After extension, just end with encouragement
        const contentEl = document.getElementById('rescue-content');
        contentEl.innerHTML = `
          <div class="rescue-step-card">
            <div class="rescue-step-emoji">üåü</div>
            <div class="rescue-step-text">You did amazing! Bear is so proud of you. Remember, you can come back anytime you need help.</div>
          </div>
          <div class="rescue-choice">
            <button class="rescue-choice-btn rescue-done-btn" onclick="endRescue()" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); min-width: 200px;">
              ‚≠ê Done ‚Äî Let's go!
            </button>
          </div>
        `;
        await speakStep('You did amazing! Bear is so proud of you.');
      }
    };

    window.endRescue = function () {
      rescueStopped = true;
      speechSynthesis.cancel();
      // Award a star for completing a rescue
      if (currentRescueMood) {
        state.stars += 1;
        saveState();
      }
      currentRescueMood = null;
      showScreen('home');
    };

    // ===== TTS ENGINE (ElevenLabs cloud voice) =====
    let ttsQueue = [];
    let ttsPlaying = false;
    let currentStepIndex = 0;
    let meditationStopped = false;

    // ElevenLabs configuration
    const ELEVEN_API_KEY = 'sk_463b99776eda3f3ee449f1b8226c5ee8526725e9afee8286';
    const ELEVEN_VOICE_ID = 'hGwlOqot9CUUiSPqArb3';  // User's chosen voice from ElevenLabs Voice Lab
    const ELEVEN_MODEL = 'eleven_multilingual_v2';     // Highest quality model ‚Äî most natural, human-like speech
    const ELEVEN_VOICE_SETTINGS = {
      stability: 0.45,          // Lower = more natural human variation, less robotic monotone
      similarity_boost: 0.80,   // High = stays true to Jessica's warm, gentle character
      style: 0.30,              // Gentle expressiveness ‚Äî calm and meditative, not over-the-top
      use_speaker_boost: true,
    };

    // Audio cache to avoid re-fetching identical phrases
    const ttsCache = new Map();

    // Fetch audio from ElevenLabs API and return as Audio element
    let activeElevenAudios = [];
    function stopAllElevenAudio() {
      activeElevenAudios.forEach(a => { try { a.pause(); a.currentTime = 0; } catch (e) { } });
      activeElevenAudios = [];
    }
    async function elevenSpeak(text) {
      // Check cache first
      if (ttsCache.has(text)) {
        const cached = ttsCache.get(text).cloneNode();
        activeElevenAudios.push(cached);
        return new Promise((resolve) => {
          cached.onended = () => { activeElevenAudios = activeElevenAudios.filter(a => a !== cached); resolve(); };
          cached.onerror = resolve;
          cached.play().catch(() => resolve());
        });
      }

      try {
        const response = await fetch(
          `https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}`,
          {
            method: 'POST',
            headers: {
              'xi-api-key': ELEVEN_API_KEY,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: text,
              model_id: ELEVEN_MODEL,
              voice_settings: ELEVEN_VOICE_SETTINGS,
            }),
          }
        );

        if (!response.ok) {
          console.warn('ElevenLabs API error:', response.status, '‚Äî falling back to browser TTS');
          return fallbackSpeak(text);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);

        // Cache it (store as template for cloning)
        ttsCache.set(text, audio.cloneNode());

        activeElevenAudios.push(audio);
        return new Promise((resolve) => {
          audio.onended = () => { activeElevenAudios = activeElevenAudios.filter(a => a !== audio); resolve(); };
          audio.onerror = () => { activeElevenAudios = activeElevenAudios.filter(a => a !== audio); resolve(); };
          audio.play().catch(() => resolve());
        });
      } catch (err) {
        console.warn('ElevenLabs fetch failed:', err, '‚Äî falling back to browser TTS');
        return fallbackSpeak(text);
      }
    }

    // Fallback: browser TTS if ElevenLabs is unavailable
    function fallbackSpeak(text) {
      return new Promise((resolve) => {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.68;
        u.pitch = 0.95;
        u.volume = 0.85;
        const voices = speechSynthesis.getVoices();
        const best = voices.find(v => /samantha|fiona|karen|moira/i.test(v.name))
          || voices.find(v => v.lang.startsWith('en'));
        if (best) u.voice = best;
        u.onend = resolve;
        u.onerror = resolve;
        speechSynthesis.speak(u);
      });
    }

    // Split text into natural phrases for breathing pauses
    function splitIntoPhrases(text) {
      const raw = text.split(/(?<=[.!?])\s+|(?<=!)\s*/);
      const phrases = [];
      let buffer = '';
      for (const chunk of raw) {
        if (buffer.length + chunk.length < 25 && buffer) {
          buffer += ' ' + chunk;
        } else {
          if (buffer) phrases.push(buffer.trim());
          buffer = chunk;
        }
      }
      if (buffer.trim()) phrases.push(buffer.trim());
      return phrases.length > 0 ? phrases : [text];
    }

    // Main speak function: phrase-by-phrase with breathing pauses
    async function speakStep(text) {
      if (meditationStopped && breathingStopped) return;

      const phrases = splitIntoPhrases(text);

      for (let i = 0; i < phrases.length; i++) {
        if (meditationStopped && breathingStopped) return;
        if (curriculumStopped) return;

        await elevenSpeak(phrases[i]);

        // Natural breathing pause between phrases (not after last)
        if (i < phrases.length - 1) {
          const pause = 600 + Math.random() * 600; // 600‚Äì1200ms
          await new Promise(r => setTimeout(r, pause));
        }
      }
    }

    async function runGuidedMeditation(key) {
      const ageMode = getAgeMode();
      const ageScripts = SCRIPTS_BY_AGE[ageMode] || SCRIPTS_BY_AGE.tiny;
      const steps = ageScripts[key];
      meditationStopped = false;
      const statusEl = document.getElementById('voice-status');
      const subtitleEl = document.getElementById('subtitle-bar');

      statusEl.textContent = 'Preparing gentle voice...';

      for (let i = 0; i < steps.length; i++) {
        if (meditationStopped) break;
        // Wait while paused
        while (meditationPaused && !meditationStopped) {
          await new Promise(r => setTimeout(r, 200));
        }
        if (meditationStopped) break;

        currentStepIndex = i;
        subtitleEl.textContent = steps[i].subtitle;
        subtitleEl.style.opacity = '1';
        statusEl.textContent = `Step ${i + 1} of ${steps.length}`;

        await speakStep(steps[i].text);

        if (meditationStopped) break;

        // Pause after speech
        const pauseMs = steps[i].pause * 1000;
        const startTime = Date.now();
        while (Date.now() - startTime < pauseMs && !meditationStopped) {
          while (meditationPaused && !meditationStopped) {
            await new Promise(r => setTimeout(r, 200));
          }
          await new Promise(r => setTimeout(r, 100));
        }
      }

      if (!meditationStopped) {
        statusEl.textContent = '';
        subtitleEl.textContent = 'Namaste! üôè';
        playBell();
        stopAmbientSound();
        stopCanvasAnimation();
        setTimeout(() => {
          completeActivity('Meditation Done!', 'You are a meditation superstar!', 'meditation');
          showScreen('meditate');
        }, 3000);
      }
    }

    // ===== NAVIGATION =====
    window.showScreen = function (name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(name + '-screen').classList.add('active');
      if (name === 'rewards') refreshRewards();
      if (name !== 'breathing' && breathingRunning) stopBreathingExercise();
      if (name !== 'player' && currentMeditationKey) {
        meditationStopped = true;
        if (meditationTimer) { clearInterval(meditationTimer); meditationTimer = null; }
        meditationPaused = false;
        speechSynthesis.cancel();
        stopAllElevenAudio();
        stopAmbientSound();
        MeditationMusic.stop();
        stopCanvasAnimation();
        currentMeditationKey = null;
      }
      // Stop rescue routines when navigating away
      if (name !== 'rescue' && currentRescueMood) {
        rescueStopped = true;
        speechSynthesis.cancel();
        stopAllElevenAudio();
        currentRescueMood = null;
      }
      // Stop curriculum lessons when navigating away
      if (name !== 'curriculum-lesson' && curriculumLessonId) {
        curriculumStopped = true;
        speechSynthesis.cancel();
        stopAllElevenAudio();
        MeditationMusic.stop();
        curriculumLessonId = null;
      }
      // Stop breath games when navigating away
      if (name !== 'breathgame' && typeof breathGameRunning !== 'undefined' && breathGameRunning) {
        breathGameRunning = false;
        clearInterval(breathGameInterval);
        if (breathGameAnimFrame) cancelAnimationFrame(breathGameAnimFrame);
        if (typeof BreathDetector !== 'undefined') BreathDetector.stop();
        if (typeof HandpanMusic !== 'undefined') HandpanMusic.stop();
        breathGameType = null;
      }
      // Catch-all: stop any lingering ElevenLabs audio on any navigation
      if (['home', 'agepicker', 'meditate', 'breathcoach', 'journey', 'rewards', 'parent', 'mood'].includes(name)) {
        stopAllElevenAudio();
        speechSynthesis.cancel();
      }
      if (name === 'home') updateAgeBadge();
      if (name === 'meditate') renderMeditationCards();
      if (name === 'breathing') renderBreathingTitle();

      // Tiny mode: auto-narrate screen transitions
      if (getAgeMode() === 'tiny') {
        if (name === 'home') {
          // no auto-narration on home
        } else if (name === 'breathcoach') {
          // no auto-narration on breathcoach
        } else if (name === 'journey') {
          // no auto-narration on journey
        }
      }
      if (name === 'breathcoach') updateBreathcoachAgeCard();
    };

    function updateBreathcoachAgeCard() {
      const mode = getAgeMode();
      const cards = {
        tiny: { icon: 'üéà', title: 'Balloon Game', desc: 'Inflate the balloon with belly breaths' },
        explorer: { icon: 'üêâ', title: 'Dragon Breath', desc: 'Breathe fire, ice & gold like a dragon' },
        independent: { icon: 'üßò', title: 'Body Scan', desc: 'Guided progressive body relaxation' },
      };
      const c = cards[mode] || cards.tiny;
      document.getElementById('breathcoach-age-icon').textContent = c.icon;
      document.getElementById('breathcoach-age-title').textContent = c.title;
      document.getElementById('breathcoach-age-desc').textContent = c.desc;
    }

    function renderMeditationCards() {
      const container = document.getElementById('meditation-list-container');
      if (!container) return;
      const ageMode = getAgeMode();
      const info = MEDITATION_INFO[ageMode] || MEDITATION_INFO.tiny;
      container.innerHTML = ['ocean', 'forest', 'space', 'rain'].map(key => {
        const m = info[key];
        const mins = Math.round(m.duration / 60);
        return `<button class="meditation-card" onclick="startMeditation('${key}')"><span class="icon">${m.icon}</span>
          <div class="meditation-card-info">
            <div class="meditation-card-title">${m.title}</div>
            <div class="meditation-card-desc">${m.desc}</div>
          </div><span class="meditation-card-duration">${mins} min</span>
        </button>`;
      }).join('');
    }

    function renderBreathingTitle() {
      const ageMode = getAgeMode();
      const breathData = BREATHING_BY_AGE[ageMode] || BREATHING_BY_AGE.tiny;
      const titleEl = document.querySelector('#breathing-screen .screen-title');
      if (titleEl) titleEl.textContent = breathData.title;
    }

    // ===== GUIDED BREATHING =====
    let breathingRunning = false;
    let breathingStopped = false;

    const BREATHING_BY_AGE = {
      // ===== TINY (3-5): Balloon Game ‚Äî playful and silly =====
      tiny: {
        title: 'üéà Balloon Game',
        intro: [
          { text: "Hey! Bear wants to play a super fun game with you! It's called the balloon game! Wanna play?", subtitle: "The Balloon Game! Wanna play?" },
          { text: "Okay! Sit down and pretend you're holding a tiny little balloon in your hands. Got it? What color is your balloon?", subtitle: "Hold your tiny balloon!" },
        ],
        cycles: [
          {
            phases: [
              { text: "Let's blow up the balloon! First take a biiiig sniff of air through your nose! Sniiiiiff!", subtitle: "üå¨Ô∏è Biiiig sniff! Sniiiiiff!", className: 'inhale', duration: 4000 },
              { text: "Hold it, hold it! Don't let the air out yet!", subtitle: "‚ú® Hold it! Don't let go!", className: 'hold', duration: 2000 },
              { text: "Now blow into your balloon! Whooooooo! Look, it's getting bigger!", subtitle: "üéà Blow! It's getting bigger!", className: 'exhale', duration: 4000 },
              { text: "Hehe! Nice! Look at your balloon! It's so pretty!", subtitle: "üòä So pretty!", className: '', duration: 2000 },
            ],
          },
          {
            phases: [
              { text: "Let's make it even bigger! Biiiig sniff through your nose, fill up your lungs!", subtitle: "üå¨Ô∏è Bigger! Biiiig sniff!", className: 'inhale', duration: 4000 },
              { text: "Hold that air! Shhh, don't let it escape!", subtitle: "‚ú® Shhh! Hold it in!", className: 'hold', duration: 2000 },
              { text: "Blow blow blow! Whoooo! Wow, your balloon is getting SO big!", subtitle: "üéà Whoooo! SO big!", className: 'exhale', duration: 4000 },
              { text: "Amazing! That's the biggest balloon I've ever seen!", subtitle: "üò≤ The biggest balloon EVER!", className: '', duration: 2000 },
            ],
          },
          {
            phases: [
              { text: "One more time! The biggest sniff EVER! Ready? Sniiiiiiiff!", subtitle: "üå¨Ô∏è Biggest sniff EVER!", className: 'inhale', duration: 4000 },
              { text: "Hold it, hold it, hold it! Almost there!", subtitle: "‚ú® Hold hold hold!", className: 'hold', duration: 2000 },
              { text: "And blow! Whoooooosh! Look at it go! It's HUGE! Hahaha!", subtitle: "üéà WHOOOOSH! It's HUGE!", className: 'exhale', duration: 4000 },
              { text: "Now let go of the balloon! Wheeeee! It's flying away! Bye bye balloon!", subtitle: "üéà Bye bye balloon! Wheeeee!", className: '', duration: 2000 },
            ],
          },
        ],
        outro: [
          { text: "Hahaha! Did you see your balloon fly away? That was so silly! You did such a great job!", subtitle: "Hahaha! So silly! Great job!" },
          { text: "Bear is giving you the biggest hug ever! Squeeeeze! You're amazing!", subtitle: "Bear hug! Squeeeeze! Amazing!" },
        ],
      },
      // ===== EXPLORER (6-8): Dragon Breathing ‚Äî adventure narrative =====
      explorer: {
        title: 'üêâ Dragon Breathing',
        intro: [
          { text: "Hey explorer! Did you know that dragons breathe in a special way? That's how they get their power. Today we're going to learn dragon breathing!", subtitle: "üêâ Learn Dragon Breathing!" },
          { text: "Sit up tall like a dragon sitting on a mountain. Your back is straight, your shoulders are back. You're a powerful dragon!", subtitle: "Sit tall like a mountain dragon!" },
        ],
        cycles: [
          {
            phases: [
              { text: "First, the fire breath! Dragons breathe in through their nose, filling their lungs with hot energy. Big breath in, feel your chest expand!", subtitle: "üî• Fire breath IN ‚Äî chest expands!", className: 'inhale', duration: 5000 },
              { text: "Hold the fire inside. Feel it warming your whole body. Three, two, one...", subtitle: "‚ú® Hold the fire ‚Äî 3... 2... 1...", className: 'hold', duration: 3000 },
              { text: "Now blow out your fire breath! Haaaaah! A long stream of flames out through your mouth! Feel the power!", subtitle: "üî• HAAAH! Dragon fire!", className: 'exhale', duration: 5000 },
              { text: "Nice! Your first fire breath! You can feel the warmth in your belly, right? That's your dragon power growing.", subtitle: "üêâ Dragon power growing!", className: '', duration: 2000 },
            ],
          },
          {
            phases: [
              { text: "Now the ice breath! This time, breathe in cool mountain air. Imagine it's a crisp winter morning. Slowly in through your nose...", subtitle: "‚ùÑÔ∏è Ice breath ‚Äî cool mountain air", className: 'inhale', duration: 5000 },
              { text: "Hold the cold. Feel it cooling you down, making you calm and focused. Hold...", subtitle: "‚ùÑÔ∏è Hold ‚Äî cool and focused", className: 'hold', duration: 3000 },
              { text: "Breathe out slowly like frost coming from your mouth. Whoooosh. Watch the ice crystals sparkle in the air!", subtitle: "‚ùÑÔ∏è Frost breath ‚Äî sparkle!", className: 'exhale', duration: 5000 },
              { text: "Awesome! Fire and ice. Hot gives you energy, cold gives you calm. A dragon needs both!", subtitle: "‚ö° Fire = energy, Ice = calm!", className: '', duration: 2000 },
            ],
          },
          {
            phases: [
              { text: "Final power move: the golden breath! Breathe in slowly and imagine golden light filling your whole body, from your toes to your head.", subtitle: "‚ú® Golden breath ‚Äî light fills you!", className: 'inhale', duration: 5000 },
              { text: "Hold the golden light. You're glowing like a treasure. Everything feels strong and warm.", subtitle: "‚ú® Glowing golden ‚Äî hold!", className: 'hold', duration: 3000 },
              { text: "Release the golden breath slowly. As it leaves, it takes any worries with it. They turn into tiny sparks and float away.", subtitle: "‚ú® Worries float away as sparks", className: 'exhale', duration: 5000 },
              { text: "You did it! Three dragon breaths: fire, ice, and gold. You have the power of a dragon inside you now!", subtitle: "üêâ 3 dragon breaths complete!", className: '', duration: 2000 },
            ],
          },
        ],
        outro: [
          { text: "The other dragons are impressed! You've mastered fire, ice, and golden breathing. Not many explorers can do that!", subtitle: "üêâ Dragon master! Impressive!" },
          { text: "Whenever you feel stressed or worried, use your dragon breath. You've got the power! Roar!", subtitle: "Use your dragon breath anytime! Roar!" },
        ],
      },
      // ===== INDEPENDENT (9-10): Box & 4-7-8 Breathing ‚Äî technique focused =====
      independent: {
        title: 'üß† Breathwork Techniques',
        intro: [
          { text: "Let's practice two powerful breathing techniques used by athletes, astronauts, and therapists. These literally change your brain chemistry in seconds.", subtitle: "üß† Science-backed breathwork" },
          { text: "Sit comfortably. Arms relaxed. We'll start with box breathing, then move to the 4-7-8 technique. Both activate your parasympathetic nervous system ‚Äî your body's built-in calm mode.", subtitle: "Box breathing ‚Üí 4-7-8 technique" },
        ],
        cycles: [
          {
            phases: [
              { text: "Box breathing, round one. Inhale through your nose for four counts. One... two... three... four.", subtitle: "üì¶ Box: Inhale 4 counts", className: 'inhale', duration: 5000 },
              { text: "Hold your breath for four counts. One... two... three... four. Your diaphragm is engaged. This builds CO2 tolerance.", subtitle: "üì¶ Hold 4 counts ‚Äî building tolerance", className: 'hold', duration: 4000 },
              { text: "Exhale slowly through your mouth for four counts. One... two... three... four. Smooth and controlled.", subtitle: "üì¶ Exhale 4 counts ‚Äî smooth", className: 'exhale', duration: 5000 },
              { text: "Hold empty for four counts. One... two... three... four. This is the hardest part. You're training your nervous system.", subtitle: "üì¶ Hold empty 4 ‚Äî training your nervous system", className: '', duration: 4000 },
            ],
          },
          {
            phases: [
              { text: "Box breathing, round two. Same pattern. Inhale, four counts. Notice how your body already feels different from just one round.", subtitle: "üì¶ Round 2 ‚Äî inhale 4", className: 'inhale', duration: 5000 },
              { text: "Hold for four. Your heart rate is already slowing. That's your vagus nerve responding ‚Äî the nerve that connects your brain to your body's calm center.", subtitle: "üì¶ Hold 4 ‚Äî vagus nerve activating", className: 'hold', duration: 4000 },
              { text: "Exhale for four. Let your jaw relax. Let your shoulders drop. Each exhale is a signal to your brain: all is well.", subtitle: "üì¶ Exhale 4 ‚Äî jaw relaxes, shoulders drop", className: 'exhale', duration: 5000 },
              { text: "Hold empty four. You're getting better at this. The discomfort zone is where growth happens.", subtitle: "üì¶ Hold empty 4 ‚Äî growth zone", className: '', duration: 4000 },
            ],
          },
          {
            phases: [
              { text: "Now switching to the 4-7-8 technique. This one is deeper. Inhale through your nose for four counts. One... two... three... four.", subtitle: "üåä 4-7-8: Inhale 4 counts", className: 'inhale', duration: 5000 },
              { text: "Hold for seven counts. This is longer ‚Äî that's intentional. Your body absorbs more oxygen. One... two... three... four... five... six... seven.", subtitle: "üåä Hold 7 counts ‚Äî absorbing oxygen", className: 'hold', duration: 7000 },
              { text: "Exhale through your mouth for eight counts, making a whoosh sound. Whoooosh. This extended exhale triggers deep relaxation.", subtitle: "üåä Exhale 8 ‚Äî whoooosh ‚Äî deep calm", className: 'exhale', duration: 8000 },
              { text: "That was one cycle. The 4-7-8 method was developed by Dr. Andrew Weil. Studies show it can lower anxiety in under two minutes.", subtitle: "üåä Developed by Dr. Weil ‚Äî proven results", className: '', duration: 3000 },
            ],
          },
        ],
        outro: [
          { text: "You now have two techniques in your toolkit. Box breathing for focus and alertness. 4-7-8 for deep calm and sleep.", subtitle: "üì¶ Box = focus. üåä 4-7-8 = deep calm." },
          { text: "The more you practice, the faster they work. Some people can shift their entire mood in three breaths. That's your goal.", subtitle: "Practice ‚Üí faster results. 3 breaths to shift your mood." },
        ],
      },
    };

    window.toggleBreathing = function () {
      if (breathingRunning) stopBreathingExercise();
      else startBreathingExercise();
    };
    // ===== MEDITATION AMBIENT MUSIC (Warm spa-quality ambient pad) =====
    const MeditationMusic = {
      ctx: null, master: null, pads: [], melodyTimer: null, noiseNode: null, playing: false,
      // Pentatonic scale for gentle melody (C major pentatonic, octave 5 & 6)
      melodyNotes: [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50],
      start() {
        if (this.playing) return;
        this.playing = true;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.master = this.ctx.createGain();
        this.master.gain.setValueAtTime(0, this.ctx.currentTime);
        this.master.gain.linearRampToValueAtTime(0.35, this.ctx.currentTime + 4);
        this.master.connect(this.ctx.destination);

        // Warm reverb-like delay for spaciousness
        this._reverbGain = this.ctx.createGain();
        this._reverbGain.gain.value = 0.3;
        const delay1 = this.ctx.createDelay(); delay1.delayTime.value = 0.15;
        const delay2 = this.ctx.createDelay(); delay2.delayTime.value = 0.37;
        const fbGain = this.ctx.createGain(); fbGain.gain.value = 0.25;
        const reverbFilter = this.ctx.createBiquadFilter();
        reverbFilter.type = 'lowpass'; reverbFilter.frequency.value = 2000;
        this._reverbGain.connect(delay1);
        delay1.connect(reverbFilter);
        reverbFilter.connect(delay2);
        delay2.connect(fbGain);
        fbGain.connect(delay1);
        delay2.connect(this.master);
        this._reverbGain.connect(this.master);

        // Lush warm pad ‚Äî layered sine waves with gentle detuning (Cmaj7 voicing)
        const padNotes = [
          { freq: 130.81, vol: 0.12 },  // C3 ‚Äî root
          { freq: 196.00, vol: 0.08 },  // G3 ‚Äî fifth
          { freq: 261.63, vol: 0.10 },  // C4 ‚Äî octave
          { freq: 329.63, vol: 0.06 },  // E4 ‚Äî major third
          { freq: 493.88, vol: 0.04 },  // B4 ‚Äî major seventh (dreamy)
        ];
        padNotes.forEach((note, i) => {
          // Main oscillator ‚Äî pure sine for warmth
          const osc = this.ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = note.freq;
          // Detuned layer for richness
          const osc2 = this.ctx.createOscillator();
          osc2.type = 'sine';
          osc2.frequency.value = note.freq * 1.002; // slight detune
          const g = this.ctx.createGain();
          g.gain.value = note.vol;
          // Very slow LFO for organic movement
          const lfo = this.ctx.createOscillator();
          lfo.type = 'sine';
          lfo.frequency.value = 0.03 + i * 0.015; // ultra-slow: 0.03-0.09 Hz
          const lfoG = this.ctx.createGain();
          lfoG.gain.value = 0.5;
          lfo.connect(lfoG);
          lfoG.connect(osc.frequency);
          lfo.start();
          // Warm low-pass filter
          const filter = this.ctx.createBiquadFilter();
          filter.type = 'lowpass';
          filter.frequency.value = 400 + i * 100;
          filter.Q.value = 0.3;
          osc.connect(filter);
          osc2.connect(filter);
          filter.connect(g);
          g.connect(this.master);
          g.connect(this._reverbGain);
          osc.start();
          osc2.start();
          this.pads.push({ osc, osc2, g, lfo, filter });
        });

        // Soft ocean-breath noise layer
        this._startBreathNoise();
        // Crystalline melody bells
        this._scheduleMelody();
      },
      _startBreathNoise() {
        const bufSize = this.ctx.sampleRate * 2;
        const buf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
        this.noiseNode = this.ctx.createBufferSource();
        this.noiseNode.buffer = buf;
        this.noiseNode.loop = true;
        const noiseFilter = this.ctx.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.value = 300;
        noiseFilter.Q.value = 0.2;
        // Slow volume modulation for breathing effect
        const noiseLfo = this.ctx.createOscillator();
        noiseLfo.type = 'sine';
        noiseLfo.frequency.value = 0.08; // breathe cycle ~12 seconds
        const noiseLfoGain = this.ctx.createGain();
        noiseLfoGain.gain.value = 0.015;
        const noiseGain = this.ctx.createGain();
        noiseGain.gain.value = 0.025;
        noiseLfo.connect(noiseLfoGain);
        noiseLfoGain.connect(noiseGain.gain);
        this.noiseNode.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noiseGain.connect(this.master);
        this.noiseNode.start();
        noiseLfo.start();
        this._noiseLfo = noiseLfo;
      },
      _scheduleMelody() {
        const playNote = () => {
          if (!this.playing || !this.ctx) return;
          const freq = this.melodyNotes[Math.floor(Math.random() * this.melodyNotes.length)];
          const now = this.ctx.currentTime;
          const osc = this.ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = freq;
          const g = this.ctx.createGain();
          // Crystal bell envelope ‚Äî very gentle
          g.gain.setValueAtTime(0, now);
          g.gain.linearRampToValueAtTime(0.06, now + 0.8);
          g.gain.exponentialRampToValueAtTime(0.001, now + 6);
          const filter = this.ctx.createBiquadFilter();
          filter.type = 'lowpass';
          filter.frequency.value = 2500;
          filter.Q.value = 0.5;
          osc.connect(filter);
          filter.connect(g);
          g.connect(this._reverbGain); // send through reverb for spaciousness
          osc.start(now);
          osc.stop(now + 7);
          // Next note: 6-14 seconds apart (very sparse, meditative)
          this.melodyTimer = setTimeout(playNote, 6000 + Math.random() * 8000);
        };
        this.melodyTimer = setTimeout(playNote, 3000);
      },
      stop() {
        this.playing = false;
        if (this.melodyTimer) clearTimeout(this.melodyTimer);
        const oldCtx = this.ctx;
        const oldMaster = this.master;
        const oldPads = this.pads;
        const oldNoise = this.noiseNode;
        const oldNoiseLfo = this._noiseLfo;
        this.ctx = null;
        this.master = null;
        this.pads = [];
        this.noiseNode = null;
        this._noiseLfo = null;
        this._reverbGain = null;
        if (oldMaster && oldCtx) {
          try { oldMaster.gain.linearRampToValueAtTime(0, oldCtx.currentTime + 2); } catch (e) { }
        }
        setTimeout(() => {
          oldPads.forEach(d => { try { d.osc.stop(); d.osc2.stop(); d.lfo.stop(); } catch (e) { } });
          try { if (oldNoise) oldNoise.stop(); } catch (e) { }
          try { if (oldNoiseLfo) oldNoiseLfo.stop(); } catch (e) { }
          if (oldCtx) { oldCtx.close().catch(() => { }); }
        }, 2500);
      }
    };

    async function startBreathingExercise() {
      breathingRunning = true;
      breathingStopped = false;
      document.getElementById('breathing-start-btn').innerHTML = '‚èπÔ∏è Stop';
      MeditationMusic.start();

      const circle = document.getElementById('breathing-circle');
      const label = document.getElementById('breathing-label');
      const counter = document.getElementById('breathing-counter');

      // Get age-specific breathing content
      const ageMode = getAgeMode();
      const breathData = BREATHING_BY_AGE[ageMode] || BREATHING_BY_AGE.tiny;

      // Intro
      for (const step of breathData.intro) {
        if (breathingStopped) return;
        label.innerHTML = step.subtitle;
        await speakStep(step.text);
        if (breathingStopped) return;
        await new Promise(r => setTimeout(r, 1500));
      }

      // Breathing cycles
      const cycleLabel = ageMode === 'tiny' ? 'Balloon' : ageMode === 'explorer' ? 'Dragon Breath' : 'Round';
      for (let cycle = 0; cycle < breathData.cycles.length; cycle++) {
        if (breathingStopped) return;
        counter.textContent = `${cycleLabel} ${cycle + 1} of ${breathData.cycles.length}`;

        for (const phase of breathData.cycles[cycle].phases) {
          if (breathingStopped) return;
          circle.className = 'breathing-circle ' + phase.className;
          label.innerHTML = phase.subtitle;
          await speakStep(phase.text);
          if (breathingStopped) return;
          const extraWait = Math.max(500, phase.duration - 2000);
          await new Promise(r => setTimeout(r, extraWait));
        }
      }

      if (breathingStopped) return;

      // Outro
      circle.className = 'breathing-circle';
      counter.textContent = '';
      for (const step of breathData.outro) {
        if (breathingStopped) return;
        label.innerHTML = step.subtitle;
        await speakStep(step.text);
        if (breathingStopped) return;
        await new Promise(r => setTimeout(r, 1500));
      }

      if (!breathingStopped) {
        playBell();
        stopBreathingExercise();
        const titles = { tiny: 'Balloon Master!', explorer: 'Dragon Master!', independent: 'Breathwork Complete!' };
        const descs = { tiny: 'You blew the best balloon ever!', explorer: 'You mastered fire, ice & gold!', independent: 'Two techniques in your toolkit!' };
        completeActivity(titles[ageMode] || titles.tiny, descs[ageMode] || descs.tiny, 'breathing');
      }
    }

    function stopBreathingExercise() {
      breathingStopped = true;
      breathingRunning = false;
      speechSynthesis.cancel();
      MeditationMusic.stop();
      document.getElementById('breathing-circle').className = 'breathing-circle';
      document.getElementById('breathing-label').innerHTML = 'Tap Start to begin!';
      document.getElementById('breathing-counter').textContent = '';
      document.getElementById('breathing-start-btn').innerHTML = '‚ñ∂Ô∏è Start';
    }

    // ===== FEELINGS =====
    const FEELING_RESPONSES = {
      happy: { text: "üòä That's wonderful! Bear is happy too!", emoji: 'üòä' },
      calm: { text: "üòå So peaceful! You're doing great.", emoji: 'üòå' },
      excited: { text: "ü§© Wow, how exciting! Let's channel that energy!", emoji: 'ü§©' },
      sad: { text: "üò¢ It's okay to feel sad. Bear gives you a big hug! ü§ó", emoji: 'üò¢' },
      angry: { text: "üò† It's okay to feel angry. Let's take a deep breath! üå¨Ô∏è", emoji: 'üò†' },
      scared: { text: "üò® You're safe here. Bear is right beside you! üß∏", emoji: 'üò®' },
    };
    window.selectFeeling = function (emotion, btnEl) {
      document.querySelectorAll('.feeling-btn').forEach(b => b.classList.remove('selected'));
      btnEl.classList.add('selected');
      const r = FEELING_RESPONSES[emotion];
      const el = document.getElementById('feeling-response');
      el.style.display = 'block'; el.textContent = r.text;
      state.feelings.push({ emotion, timestamp: Date.now() });
      if (state.feelings.length > 20) state.feelings = state.feelings.slice(-20);
      addStar(); saveState();
      setTimeout(() => completeActivity('Feelings Check-in!', 'Thank you for sharing!', 'mood'), 1500);
    };

    // ===== MEDITATION =====
    // Visual config shared across ages; titles/durations/descriptions vary
    const MEDITATION_VISUALS = {
      ocean: { bgTop: '#48C9F0', bgBottom: '#1B8FC4', creatures: ['üêü', 'üê†', 'üê°', 'üê¨', 'üêô', 'ü¶Ä', 'üêö', 'ü™∏', 'üê≥'], count: 10, moveStyle: 'swim' },
      forest: { bgTop: '#7BCF6B', bgBottom: '#3A8A2F', creatures: ['ü¶ã', 'ü¶ã', 'üêù', 'üêû', 'üå∏', 'üçÑ', 'üåª', 'üêøÔ∏è'], count: 9, moveStyle: 'flutter' },
      space: { bgTop: '#1A1A4E', bgBottom: '#0D0D2B', creatures: ['‚≠ê', 'üåü', '‚ú®', 'üí´', 'ü™ê', 'üåô', 'üõ∏', '‚òÑÔ∏è'], count: 12, moveStyle: 'drift' },
      rain: { bgTop: '#7EA8C0', bgBottom: '#4A6A7A', creatures: ['üíß', 'üíß', 'üíß', 'üåà', '‚òÇÔ∏è', 'üíß', 'üíß', 'üå∏'], count: 10, moveStyle: 'fall' },
    };
    const MEDITATION_INFO = {
      tiny: {
        ocean: { title: 'Ocean Waves', desc: 'Watch the fishies swim by', duration: 120, icon: 'üåä' },
        forest: { title: 'Magic Forest', desc: 'See the butterflies dance', duration: 120, icon: 'üå≤' },
        space: { title: 'Space Adventure', desc: 'Float among the stars', duration: 120, icon: 'üöÄ' },
        rain: { title: 'Rainy Day', desc: 'Listen to the raindrops', duration: 120, icon: 'üåßÔ∏è' },
      },
      explorer: {
        ocean: { title: 'Deep Ocean Dive', desc: 'Follow the sea turtle guide', duration: 180, icon: 'üåä' },
        forest: { title: 'Enchanted Forest', desc: 'Walk the mossy path of calm', duration: 180, icon: 'üå≤' },
        space: { title: 'Space Mission', desc: 'Explore the silent universe', duration: 180, icon: 'üöÄ' },
        rain: { title: 'Rainy Treehouse', desc: 'Cozy up with cocoa and calm', duration: 180, icon: 'üåßÔ∏è' },
      },
      independent: {
        ocean: { title: 'Ocean Body Scan', desc: 'Deep relaxation & body scan', duration: 240, icon: 'üåä' },
        forest: { title: 'Forest Grounding', desc: '5-4-3-2-1 sensory technique', duration: 240, icon: 'üå≤' },
        space: { title: 'Space Perspective', desc: 'Cognitive distancing & PMR', duration: 240, icon: 'üöÄ' },
        rain: { title: 'Rain Acceptance', desc: 'Affect labeling & square breathing', duration: 240, icon: 'üåßÔ∏è' },
      },
    };
    function getMeditation(key) {
      const ageMode = getAgeMode();
      const info = (MEDITATION_INFO[ageMode] || MEDITATION_INFO.tiny)[key];
      const vis = MEDITATION_VISUALS[key];
      return { ...vis, ...info };
    }

    let meditationTimer = null;
    let meditationRemaining = 0;
    let meditationPaused = false;
    let currentMeditationKey = null;
    let canvasAnimFrame = null;
    let canvasCreatures = [];

    window.startMeditation = function (key) {
      currentMeditationKey = key;
      const med = getMeditation(key);
      meditationRemaining = med.duration;
      meditationPaused = false;
      meditationStopped = false;

      document.getElementById('player-title').textContent = med.title;
      document.getElementById('player-toggle-btn').innerHTML = '‚è∏Ô∏è Pause';
      document.getElementById('volume-slider').value = audioVolume * 100;
      document.getElementById('voice-status').textContent = '';
      document.getElementById('subtitle-bar').textContent = 'Get ready...';
      updateTimerDisplay();
      showScreen('player');

      playAmbientSound(key);
      MeditationMusic.start();
      initCanvas(key);

      meditationTimer = setInterval(() => {
        if (!meditationPaused) {
          meditationRemaining--;
          updateTimerDisplay();
          if (meditationRemaining <= 0) { clearInterval(meditationTimer); meditationTimer = null; }
        }
      }, 1000);

      // Start guided voice
      runGuidedMeditation(key);
    };

    function updateTimerDisplay() {
      const m = Math.floor(Math.max(0, meditationRemaining) / 60);
      const s = Math.max(0, meditationRemaining) % 60;
      document.getElementById('player-timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
    }

    window.toggleMeditationPlayback = function () {
      meditationPaused = !meditationPaused;
      document.getElementById('player-toggle-btn').innerHTML = meditationPaused ? '‚ñ∂Ô∏è Play' : '‚è∏Ô∏è Pause';
      if (meditationPaused) {
        if (currentAudio) currentAudio.pause();
        if (speechSynthesis.speaking) speechSynthesis.pause();
      } else {
        if (currentAudio) currentAudio.play().catch(() => { });
        if (speechSynthesis.paused) speechSynthesis.resume();
      }
    };

    window.stopMeditation = function () {
      meditationStopped = true;
      if (meditationTimer) { clearInterval(meditationTimer); meditationTimer = null; }
      meditationPaused = false;
      speechSynthesis.cancel();
      stopAllElevenAudio();
      stopAmbientSound();
      MeditationMusic.stop();
      stopCanvasAnimation();
      currentMeditationKey = null;
      showScreen('meditate');
    };

    // ===== BRIGHT CANVAS (decorative only, no clicking) =====
    function initCanvas(key) {
      const canvas = document.getElementById('meditation-canvas');
      const ctx = canvas.getContext('2d');
      const med = getMeditation(key);

      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      const W = rect.width, H = rect.height;

      canvasCreatures = [];
      for (let i = 0; i < med.count; i++) spawnCreature(W, H, med);

      let bgStars = [];
      if (key === 'space') for (let i = 0; i < 80; i++) bgStars.push({ x: Math.random() * W, y: Math.random() * H, r: Math.random() * 2 + 0.5, tw: Math.random() * Math.PI * 2 });

      let rainDrops = [];
      if (key === 'rain') for (let i = 0; i < 60; i++) rainDrops.push({ x: Math.random() * W, y: Math.random() * H, speed: 1.5 + Math.random() * 2, len: 6 + Math.random() * 10 });

      let time = 0;
      function animate() {
        if (!currentMeditationKey) return;
        time += 0.016;
        ctx.clearRect(0, 0, W, H);

        // BRIGHT gradient background
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, med.bgTop);
        grad.addColorStop(1, med.bgBottom);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        // Theme backgrounds
        if (key === 'ocean') {
          // Light shimmering waves
          for (let w = 0; w < 3; w++) {
            ctx.beginPath();
            ctx.fillStyle = `rgba(255,255,255,${0.08 - w * 0.02})`;
            for (let x = 0; x <= W; x += 3) {
              const y = H * (0.25 + w * 0.2) + Math.sin(x * 0.015 + time * (0.6 - w * 0.1) + w * 2) * 12;
              if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath(); ctx.fill();
          }
          // Light rays from top
          for (let r = 0; r < 5; r++) {
            ctx.fillStyle = `rgba(255,255,200,${0.03 + Math.sin(time * 0.5 + r) * 0.01})`;
            ctx.beginPath();
            const rx = W * (0.15 + r * 0.18);
            ctx.moveTo(rx, 0);
            ctx.lineTo(rx - 30, H);
            ctx.lineTo(rx + 30, H);
            ctx.closePath(); ctx.fill();
          }
        }

        if (key === 'forest') {
          // Bright green ground
          ctx.fillStyle = 'rgba(100,180,60,0.5)';
          ctx.beginPath();
          for (let x = 0; x <= W; x += 3) { const y = H * 0.8 + Math.sin(x * 0.03) * 6; if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
          ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath(); ctx.fill();
          // Bright trees
          [W * 0.08, W * 0.28, W * 0.52, W * 0.72, W * 0.93].forEach((tx, i) => {
            const th = 70 + i * 8;
            ctx.fillStyle = '#6B4226';
            ctx.fillRect(tx - 5, H * 0.8 - th * 0.35, 10, th * 0.4);
            ctx.fillStyle = `hsl(${115 + i * 6}, 60%, ${40 + i * 3}%)`;
            ctx.beginPath(); ctx.arc(tx, H * 0.8 - th * 0.5, 22 + i * 3, 0, Math.PI * 2); ctx.fill();
          });
          // Sun rays
          for (let r = 0; r < 4; r++) {
            ctx.fillStyle = `rgba(255,255,100,${0.04 + Math.sin(time * 0.3 + r) * 0.02})`;
            ctx.beginPath();
            ctx.moveTo(W * (0.2 + r * 0.2), 0);
            ctx.lineTo(W * (0.2 + r * 0.2) - 20, H * 0.6);
            ctx.lineTo(W * (0.2 + r * 0.2) + 20, H * 0.6);
            ctx.closePath(); ctx.fill();
          }
        }

        if (key === 'space') {
          bgStars.forEach(s => {
            const a = 0.5 + 0.5 * Math.abs(Math.sin(time * 1.5 + s.tw));
            ctx.fillStyle = `rgba(255,255,255,${a})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2); ctx.fill();
          });
          // Nebula glow
          const ng = ctx.createRadialGradient(W * 0.3, H * 0.4, 0, W * 0.3, H * 0.4, W * 0.4);
          ng.addColorStop(0, 'rgba(100,50,200,0.08)');
          ng.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = ng; ctx.fillRect(0, 0, W, H);
          const ng2 = ctx.createRadialGradient(W * 0.7, H * 0.6, 0, W * 0.7, H * 0.6, W * 0.3);
          ng2.addColorStop(0, 'rgba(50,100,200,0.06)');
          ng2.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = ng2; ctx.fillRect(0, 0, W, H);
        }

        if (key === 'rain') {
          ctx.strokeStyle = 'rgba(200,220,240,0.25)'; ctx.lineWidth = 1;
          rainDrops.forEach(d => {
            d.y += d.speed; if (d.y > H) { d.y = -d.len; d.x = Math.random() * W; }
            ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(d.x - 0.5, d.y + d.len); ctx.stroke();
          });
        }

        // Draw creatures (decorative, larger, brighter)
        if (!meditationPaused) {
          canvasCreatures.forEach(c => {
            if (med.moveStyle === 'swim') {
              c.x += c.vx; c.y += Math.sin(time * 1.5 + c.phase) * 0.5;
              if (c.x > W + 50) { c.x = -40; c.y = 30 + Math.random() * (H - 60); }
              if (c.x < -50) { c.x = W + 40; c.y = 30 + Math.random() * (H - 60); }
            } else if (med.moveStyle === 'flutter') {
              c.x += Math.sin(time * 1.2 + c.phase) * 0.7;
              c.y += Math.cos(time * 0.9 + c.phase * 0.7) * 0.5;
              if (c.x < 15) c.x = 15; if (c.x > W - 15) c.x = W - 15;
              if (c.y < 15) c.y = 15; if (c.y > H * 0.75) c.y = H * 0.75;
            } else if (med.moveStyle === 'drift') {
              c.x += Math.sin(time * 0.4 + c.phase) * 0.35;
              c.y += Math.cos(time * 0.25 + c.phase * 1.2) * 0.25;
              if (c.x < 10) c.x = 10; if (c.x > W - 10) c.x = W - 10;
              if (c.y < 10) c.y = 10; if (c.y > H - 10) c.y = H - 10;
            } else if (med.moveStyle === 'fall') {
              c.y += c.vy; c.x += Math.sin(time * 0.8 + c.phase) * 0.4;
              if (c.y > H + 25) { c.y = -25; c.x = 15 + Math.random() * (W - 30); }
            }
            const scale = 1 + Math.sin(time * 1.5 + c.phase) * 0.06;
            ctx.save(); ctx.translate(c.x, c.y); ctx.scale(scale, scale);
            ctx.font = `${c.size}px sans-serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(c.emoji, 0, 0);
            ctx.restore();
          });
        } else {
          canvasCreatures.forEach(c => {
            ctx.font = `${c.size}px sans-serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(c.emoji, c.x, c.y);
          });
        }

        canvasAnimFrame = requestAnimationFrame(animate);
      }
      animate();
    }

    function spawnCreature(W, H, med) {
      const emoji = med.creatures[Math.floor(Math.random() * med.creatures.length)];
      let x, y, vx = 0, vy = 0;
      if (med.moveStyle === 'swim') {
        x = Math.random() * W; y = 30 + Math.random() * (H - 60);
        vx = 0.3 + Math.random() * 0.7; if (Math.random() > 0.5) vx = -vx;
      } else if (med.moveStyle === 'flutter') {
        x = 25 + Math.random() * (W - 50); y = 25 + Math.random() * (H * 0.65);
      } else if (med.moveStyle === 'drift') {
        x = 15 + Math.random() * (W - 30); y = 15 + Math.random() * (H - 30);
      } else if (med.moveStyle === 'fall') {
        x = 15 + Math.random() * (W - 30); y = Math.random() * H; vy = 0.4 + Math.random() * 0.8;
      }
      canvasCreatures.push({ emoji, x, y, vx, vy, size: 32 + Math.random() * 14, phase: Math.random() * Math.PI * 2 });
    }

    function stopCanvasAnimation() {
      if (canvasAnimFrame) { cancelAnimationFrame(canvasAnimFrame); canvasAnimFrame = null; }
      canvasCreatures = [];
    }

    // ===== REWARDS =====
    function refreshRewards() {
      document.getElementById('streak-number').textContent = state.streak;
      document.getElementById('stars-count').textContent = state.stars;
      const sv = document.getElementById('stars-visual');
      const ds = Math.min(state.stars, 30);
      sv.textContent = ds > 0 ? '‚≠ê'.repeat(ds) + (state.stars > 30 ? ` +${state.stars - 30}` : '') : 'Complete activities to earn stars!';
      const fl = document.getElementById('recent-feelings-list');
      if (state.feelings.length === 0) fl.textContent = 'No feelings logged yet!';
      else fl.textContent = state.feelings.slice(-8).map(f => FEELING_RESPONSES[f.emotion]?.emoji || '‚ùì').join(' ');
    }

    // ===== CELEBRATION =====
    function completeActivity(title, subtitle, type) {
      addStar(); saveState();
      if (type) logActivity(type);
      document.getElementById('celebration-text').textContent = title;
      document.getElementById('celebration-sub').textContent = subtitle;
      document.getElementById('celebration-overlay').classList.add('active');
      spawnConfetti();
    }
    window.closeCelebration = function () {
      document.getElementById('celebration-overlay').classList.remove('active');
      document.getElementById('confetti-container').innerHTML = '';
    };
    function spawnConfetti() {
      const c = document.getElementById('confetti-container'); c.innerHTML = '';
      const colors = ['#89CFF0', '#C3B1E1', '#98FB98', '#FFDAB9', '#FDFD96', '#FF7F7F', '#F0B800'];
      for (let i = 0; i < 40; i++) {
        const p = document.createElement('div'); p.className = 'confetti-piece';
        p.style.left = Math.random() * 100 + '%'; p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.animationDuration = (1.5 + Math.random() * 2) + 's'; p.style.animationDelay = (Math.random() * 0.8) + 's';
        p.style.width = (8 + Math.random() * 8) + 'px'; p.style.height = (8 + Math.random() * 8) + 'px';
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '3px'; c.appendChild(p);
      }
      setTimeout(() => { c.innerHTML = ''; }, 4000);
    }

    // ===== CURRICULUM DATA =====
    const CURRICULUM_BY_AGE = {
      // ‚îÄ‚îÄ TINY (Ages 3‚Äì6) ‚îÄ‚îÄ
      tiny: [
        {
          id: 1,
          title: 'Calm Breath',
          icon: 'üå¨Ô∏è',
          desc: 'Belly breathing with Bear',
          steps: [
            { text: "Hey friend! Bear wants to teach you a calm superpower! It's called Calm Breath! Ready?", subtitle: "ü¶∏ Calm Breath superpower!", pause: 2 },
            { text: "Put your hands on your tummy. Feel that? Your tummy is like a balloon!", subtitle: "üéà Hands on your tummy!", pause: 2 },
            { text: "Now breathe in through your nose, nice and slow. Feel your tummy balloon get bigger! Biiiig breath in!", subtitle: "üå¨Ô∏è Breathe in! Tummy gets bigger!", pause: 4 },
            { text: "Hold it for a second! Shhh!", subtitle: "‚ú® Hold it!", pause: 2 },
            { text: "Now breathe out through your mouth, slowly. Haaaaaah. Feel your tummy get small again!", subtitle: "üòÆ‚Äçüí® Breathe out! Tummy gets small!", pause: 4 },
            { text: "Amazing! Let's do it again! Big breath in through your nose, tummy gets big!", subtitle: "üå¨Ô∏è Big breath in again!", pause: 4 },
            { text: "Hold!", subtitle: "‚ú® Hold!", pause: 2 },
            { text: "And blow out slowly. Haaaaah. You're doing so great!", subtitle: "üòÆ‚Äçüí® Blow out slowly!", pause: 4 },
            { text: "One more time! The biggest belly breath ever! Sniiiiiff!", subtitle: "üå¨Ô∏è Biggest belly breath!", pause: 4 },
            { text: "Hold it, hold it!", subtitle: "‚ú® Hold hold hold!", pause: 2 },
            { text: "And let it all out! Whoooosh! Your tummy balloon is flat!", subtitle: "üéà Whoooosh! Flat balloon!", pause: 3 },
            { text: "You just learned Calm Breath! That's your first superpower! Bear is SO proud of you!", subtitle: "ü¶∏ First superpower unlocked!", pause: 2 },
          ],
          quiz: {
            question: "When you breathe in, your tummy gets‚Ä¶",
            answers: [
              { text: "üéà Bigger", correct: true },
              { text: "ü´ß Smaller", correct: false },
            ],
          },
          realLifePrompt: "Try 3 calm breaths before lunch today. Tap when you did!",
        },
        {
          id: 2,
          title: 'Long Exhale',
          icon: 'üïØÔ∏è',
          desc: 'Blow out the candles',
          steps: [
            { text: "Guess what? Bear has birthday candles! Let's learn to blow them out with a super long breath!", subtitle: "üïØÔ∏è Birthday candles!", pause: 2 },
            { text: "First, sniff in through your nose. Quick sniff! One, two!", subtitle: "üå¨Ô∏è Quick sniff in!", pause: 3 },
            { text: "Now blow out like you're blowing a candle. But make it suuuuper long! Whooooooooooo!", subtitle: "üïØÔ∏è Suuuper long blow!", pause: 5 },
            { text: "Did you see! The candle went out! The secret is, breathing out is longer than breathing in!", subtitle: "‚ú® Out is longer than in!", pause: 3 },
            { text: "Let's try again! Quick sniff in!", subtitle: "üå¨Ô∏è Quick sniff!", pause: 3 },
            { text: "And the longest blow ever! Blow blow blow keep going! Phoooooooo!", subtitle: "üïØÔ∏è Keep blowing! Phoooooo!", pause: 6 },
            { text: "Two candles out! You're amazing! One more time!", subtitle: "üéÇ Two candles down!", pause: 2 },
            { text: "Sniff in!", subtitle: "üå¨Ô∏è Sniff!", pause: 3 },
            { text: "And the biggest, longest, slowest blow! Whoooooooooooooooo! All the candles are out!", subtitle: "üéÇ ALL candles out! Yay!", pause: 4 },
            { text: "You learned Long Exhale! When you breathe out longer, it makes your body feel super calm and relaxed!", subtitle: "ü¶∏ Long Exhale superpower!", pause: 2 },
          ],
          quiz: {
            question: "Which is longer in Long Exhale?",
            answers: [
              { text: "üå¨Ô∏è Breathing in", correct: false },
              { text: "üïØÔ∏è Breathing out", correct: true },
            ],
          },
          realLifePrompt: "Blow out a pretend candle when you feel wiggly. Tap when you did!",
        },
        {
          id: 3,
          title: 'Body Radar',
          icon: 'üì°',
          desc: 'Squeeze & relax your body',
          steps: [
            { text: "Bear has a magic power called Body Radar! It helps you find where your body feels tight. Ready to learn?", subtitle: "üì° Body Radar!", pause: 2 },
            { text: "Let's start at your toes! Scrunch your toes up really tight! Squeeze squeeze squeeze!", subtitle: "ü¶∂ Squeeze your toes!", pause: 3 },
            { text: "Now let them go! Wiggle wiggle! Feel how floppy they are? That's relaxed!", subtitle: "ü¶∂ Wiggle! So floppy!", pause: 3 },
            { text: "Now your legs! Squeeze your legs tight like a robot! Bzzz!", subtitle: "ü¶ø Robot legs! Squeeze!", pause: 3 },
            { text: "And let go! Your legs are like noodles now! Wiggly noodle legs!", subtitle: "üçù Noodle legs! Wiggly!", pause: 3 },
            { text: "Arms next! Make the biggest muscles! Squeeze your fists! Grrrr!", subtitle: "üí™ Biggest muscles! Grrrr!", pause: 3 },
            { text: "Let go! Shake them out! Shake shake shake! Like jelly arms!", subtitle: "ü´® Jelly arms! Shake!", pause: 3 },
            { text: "Last one! Scrunch up your whole face! Squeeze your eyes, nose, mouth! Like a raisin!", subtitle: "üòñ Raisin face! Squeeze!", pause: 3 },
            { text: "And relax! Big smile! Feel how calm your face is now?", subtitle: "üòä Big smile! So calm!", pause: 3 },
            { text: "Your Body Radar found all the tight spots and made them relaxed! You're a Body Radar superstar!", subtitle: "ü¶∏ Body Radar superstar!", pause: 2 },
          ],
          quiz: {
            question: "Where do we start the Body Radar?",
            answers: [
              { text: "ü¶∂ Toes", correct: true },
              { text: "üñêÔ∏è Hands", correct: false },
            ],
          },
          realLifePrompt: "Do a Body Radar in bed tonight. Tap when you did!",
        },
        {
          id: 4,
          title: 'Thought Clouds',
          icon: '‚òÅÔ∏è',
          desc: 'Let thoughts float away',
          steps: [
            { text: "Look up! Imagine a big beautiful blue sky! That's your mind! And those fluffy things? Those are your thoughts!", subtitle: "‚òÅÔ∏è Thoughts are clouds!", pause: 3 },
            { text: "Close your eyes. Imagine a cloud floating by. Maybe it's a thought about lunch. Or a toy. Just watch it!", subtitle: "üëÄ Watch the cloud float by!", pause: 4 },
            { text: "Here's the superpower part. You don't have to grab the cloud! Just let it float away! Bye bye cloud!", subtitle: "üëã Bye bye cloud!", pause: 4 },
            { text: "Oh look, another cloud! Maybe this one is a worry cloud. That's okay! Watch it float across the sky.", subtitle: "‚òÅÔ∏è Worry cloud floating by...", pause: 4 },
            { text: "And it's going, going, gone! Just like that! You didn't have to do anything! It floated away on its own!", subtitle: "‚ú® Gone! It floated away!", pause: 3 },
            { text: "One more cloud. This time, make it a silly cloud! A cloud shaped like a dancing penguin! Hehe!", subtitle: "üêß Silly penguin cloud!", pause: 4 },
            { text: "Watch the silly cloud float away too. Bye bye penguin!", subtitle: "üëã Bye penguin cloud!", pause: 3 },
            { text: "Open your eyes! You learned Thought Clouds! When thoughts come, you don't have to hold on. Just let them float!", subtitle: "ü¶∏ Thought Clouds superpower!", pause: 2 },
          ],
          quiz: {
            question: "When a thought comes, we let it‚Ä¶",
            answers: [
              { text: "üå§Ô∏è Float away", correct: true },
              { text: "üß≤ Stick to us", correct: false },
            ],
          },
          realLifePrompt: "Watch one thought cloud at school today. Tap when you did!",
        },
        {
          id: 5,
          title: 'Kindness',
          icon: 'üíñ',
          desc: 'Send kind wishes',
          steps: [
            { text: "Bear's favorite superpower is Kindness! It makes your heart feel warm and sparkly! Ready?", subtitle: "üíñ Kindness superpower!", pause: 2 },
            { text: "Put your hand on your heart. Feel it beating? That's your kindness engine!", subtitle: "üíó Your kindness engine!", pause: 3 },
            { text: "First, let's send kind wishes to YOU! Say in your head: I am brave. I am kind. I am enough.", subtitle: "üåü I am brave, kind, enough!", pause: 4 },
            { text: "Feel that warm feeling? That's kindness filling your heart like sunshine!", subtitle: "‚òÄÔ∏è Sunshine in your heart!", pause: 3 },
            { text: "Now think of your best friend. Send them kind wishes! May you be happy! May you be safe!", subtitle: "üë´ Kind wishes to your friend!", pause: 4 },
            { text: "Now think of someone who maybe had a bad day. Send them kind wishes too! May you feel better!", subtitle: "ü§ó Kind wishes to someone sad!", pause: 4 },
            { text: "Now the biggest one! Send kind wishes to EVERYONE! The whole world! May everyone be happy and safe!", subtitle: "üåç Kind wishes to everyone!", pause: 4 },
            { text: "Feel your heart? It's glowing! When you send kindness out, it fills you up too! That's the magic!", subtitle: "‚ú® Kindness fills YOU up too!", pause: 3 },
            { text: "You learned all FIVE superpowers! You are a Calm Critter Champion! Bear is SO SO proud of you!", subtitle: "üèÜ Calm Critter Champion!", pause: 2 },
          ],
          quiz: {
            question: "We send kind wishes to‚Ä¶",
            answers: [
              { text: "üßç Just me", correct: false },
              { text: "üåç Everyone", correct: true },
            ],
          },
          realLifePrompt: "Tell someone something kind today. Tap when you did!",
        },
        {
          id: 6,
          title: 'Rainbow Breathing',
          icon: 'üåà',
          desc: 'Breathe in all the colors',
          steps: [
            { text: "Bear found a RAINBOW! And guess what? We can BREATHE the rainbow! How cool is that?", subtitle: "üåà Breathe the rainbow!", pause: 2 },
            { text: "First color ‚Äî RED! Imagine breathing in a big, warm red light. Sniff it in!", subtitle: "üî¥ Breathe in RED!", pause: 4 },
            { text: "Breathe out and blow the red all around you! Whoooosh! Everything is red!", subtitle: "üî¥ Red everywhere!", pause: 3 },
            { text: "Next ‚Äî ORANGE! Like a juicy orange. Sniff in that yummy orange air!", subtitle: "üü† Breathe in ORANGE!", pause: 4 },
            { text: "Blow it out! Orange sparkles everywhere!", subtitle: "üü† Orange sparkles!", pause: 3 },
            { text: "YELLOW like sunshine! Breathe in that warm, happy yellow!", subtitle: "üü° Breathe in YELLOW sunshine!", pause: 4 },
            { text: "Blow out yellow giggles! Hehehe!", subtitle: "üü° Yellow giggles!", pause: 3 },
            { text: "GREEN like the grass! Big sniff of fresh green air!", subtitle: "üü¢ Breathe in GREEN!", pause: 4 },
            { text: "Blow out green butterflies! They're flying around your head!", subtitle: "üü¢ Green butterflies!", pause: 3 },
            { text: "BLUE like the sky! Breathe in the calm, cool blue!", subtitle: "üîµ Breathe in BLUE calm!", pause: 4 },
            { text: "Blow it out gently. Ahhh. Blue is so peaceful.", subtitle: "üîµ So peaceful!", pause: 3 },
            { text: "Last one ‚Äî PURPLE! The most magical color! A royal purple breath. Breathe in!", subtitle: "üü£ Magical PURPLE!", pause: 4 },
            { text: "And blow out all the magic! You just breathed a whole rainbow! You're a Rainbow Breather!", subtitle: "üåà Rainbow Breather!", pause: 2 },
          ],
          quiz: {
            question: "In Rainbow Breathing, the last color we breathe is‚Ä¶",
            answers: [
              { text: "üî¥ Red", correct: false },
              { text: "üü£ Purple", correct: true },
            ],
          },
          realLifePrompt: "Try rainbow breathing when you feel upset. Tap when you did!",
        },
        {
          id: 7,
          title: 'Starfish Stretch',
          icon: '‚≠ê',
          desc: 'Stretch and relax like a starfish',
          steps: [
            { text: "Have you ever seen a starfish? They stretch out their arms and relax in the ocean! Let's be starfish!", subtitle: "‚≠ê Be a starfish!", pause: 2 },
            { text: "Stand up! Spread your arms out wide and your legs apart. You're a starfish!", subtitle: "‚≠ê Arms and legs wide!", pause: 3 },
            { text: "Now reach your right hand up to the sky! Streeeetch! Can you touch the clouds?", subtitle: "‚òÅÔ∏è Reach for the clouds!", pause: 4 },
            { text: "And flop back down. Ahhh. Floppy starfish arm!", subtitle: "üåä Floppy starfish!", pause: 3 },
            { text: "Left hand up to the sky! Streeeetch! Reach reach reach!", subtitle: "‚òÅÔ∏è Other arm up high!", pause: 4 },
            { text: "And flop! So wiggly and relaxed!", subtitle: "üåä Wiggly and relaxed!", pause: 3 },
            { text: "Now reach both arms up! Stand on your tippy toes! You're the TALLEST starfish ever!", subtitle: "‚≠ê Tallest starfish EVER!", pause: 4 },
            { text: "And melt down to the ground! Slowly, slowly, like a puddle. Melt melt melt!", subtitle: "ü´† Melting starfish puddle!", pause: 4 },
            { text: "Now just lie there like a starfish on the beach. Feel the warm sunshine on your tummy. So cozy!", subtitle: "üèñÔ∏è Beach starfish! So cozy!", pause: 5 },
            { text: "You're a Starfish Stretcher! Whenever you feel all scrunched up, just stretch like a starfish!", subtitle: "‚≠ê Starfish Stretcher!", pause: 2 },
          ],
          quiz: {
            question: "What do we do after stretching really tall?",
            answers: [
              { text: "ü´† Melt down slowly", correct: true },
              { text: "üèÉ Run around fast", correct: false },
            ],
          },
          realLifePrompt: "Do a starfish stretch when you wake up tomorrow. Tap when you did!",
        },
        {
          id: 8,
          title: 'Bubble Thoughts',
          icon: 'ü´ß',
          desc: 'Blow worries away in bubbles',
          steps: [
            { text: "Bear has a magic bubble wand! These bubbles are special ‚Äî you can put your worries inside them!", subtitle: "ü´ß Magic worry bubbles!", pause: 2 },
            { text: "Think of something that made you feel a little worried today. Got it? Don't say it, just think it.", subtitle: "ü§î Think of a worry...", pause: 4 },
            { text: "Now take a deep breath in. We're going to blow that worry into a bubble!", subtitle: "üå¨Ô∏è Deep breath in!", pause: 3 },
            { text: "Blow! Watch your worry float away inside a beautiful, shimmery bubble! Bye bye worry!", subtitle: "ü´ß Bye bye worry bubble!", pause: 4 },
            { text: "POP! The bubble popped way up in the sky and the worry disappeared! Poof!", subtitle: "üí• Pop! Worry gone! Poof!", pause: 3 },
            { text: "Got another worry? Let's blow another bubble! Big breath in!", subtitle: "üå¨Ô∏è Another big breath!", pause: 3 },
            { text: "And blow! There it goes! Another beautiful bubble floating up, up, up!", subtitle: "ü´ß Up up up!", pause: 4 },
            { text: "POP! Gone! You're so good at this!", subtitle: "üí• Pop! You're amazing!", pause: 3 },
            { text: "Now let's blow the biggest bubble EVER! For any worries you don't even know about! Giant breath in!", subtitle: "üå¨Ô∏è GIANT breath!", pause: 3 },
            { text: "BLOW! Look at that ENORMOUS bubble! It's as big as a house! And POP! All the worries are gone!", subtitle: "ü´ßüí• ENORMOUS bubble! ALL gone!", pause: 3 },
            { text: "You're a Bubble Thought master! Whenever worries come, just imagine blowing them into bubbles!", subtitle: "ü´ß Bubble Thought master!", pause: 2 },
          ],
          quiz: {
            question: "What happens to the worry bubble?",
            answers: [
              { text: "ü´ß It floats away and pops", correct: true },
              { text: "üß≤ It stays stuck to you", correct: false },
            ],
          },
          realLifePrompt: "Blow an invisible worry bubble at school today. Tap when you did!",
        },
        {
          id: 9,
          title: 'Animal Breaths',
          icon: 'üêæ',
          desc: 'Breathe like different animals',
          steps: [
            { text: "Let's go to the zoo! But this is a special zoo where we learn how animals breathe! Ready?", subtitle: "üêæ Breathing zoo!", pause: 2 },
            { text: "First animal ‚Äî BUNNY! Bunnies do tiny quick sniffs! Sniff sniff sniff sniff sniff! Like smelling a carrot!", subtitle: "üê∞ Bunny sniffs! Sniff sniff!", pause: 4 },
            { text: "Now breathe out one long bunny sigh. Ahhhh. Happy bunny!", subtitle: "üê∞ Happy bunny sigh!", pause: 3 },
            { text: "Next ‚Äî SNAKE! Snakes breathe in through their nose, then hissssss it out! Try it! Hissssss!", subtitle: "üêç Hissssss like a snake!", pause: 4 },
            { text: "Great hissing! The longer the hiss the calmer you get! Try a super long one! Hisssssssss!", subtitle: "üêç Longest hiss ever!", pause: 5 },
            { text: "Now ‚Äî LION! Lions take a big breath and then ROAR! Let's do it! Big breath in!", subtitle: "ü¶Å Big lion breath!", pause: 3 },
            { text: "ROAR! With your mouth wide open and tongue out! ROARRR! That lets out all the yucky feelings!", subtitle: "ü¶Å ROARRR! Tongue out!", pause: 4 },
            { text: "Last one ‚Äî BEAR! Bear takes the slowest, calmest breaths. Like a bear hibernating. Slow in.", subtitle: "üß∏ Slow sleepy bear breath in...", pause: 5 },
            { text: "And the slowest breath out. Like warm honey pouring. So slow. So calm.", subtitle: "üß∏ Slow warm honey breath out...", pause: 5 },
            { text: "You learned Animal Breaths! Bunny for energy, snake for calm, lion for feelings, bear for sleep!", subtitle: "üêæ Animal Breaths master!", pause: 2 },
          ],
          quiz: {
            question: "Which animal breath lets out yucky feelings?",
            answers: [
              { text: "üê∞ Bunny sniffs", correct: false },
              { text: "ü¶Å Lion roar", correct: true },
            ],
          },
          realLifePrompt: "Try a snake hiss breath when you need to calm down. Tap when you did!",
        },
        {
          id: 10,
          title: 'Grateful Heart',
          icon: 'üôè',
          desc: 'Find things to be thankful for',
          steps: [
            { text: "Bear's heart is doing a happy dance! Why? Because Bear is feeling GRATEFUL! That means thankful!", subtitle: "üôè Grateful happy dance!", pause: 2 },
            { text: "Put your hand on your heart again. Let's fill it up with thankful feelings!", subtitle: "üíó Hand on heart!", pause: 3 },
            { text: "Think of your favorite person. Someone who makes you smile SO big! Got them? Send them a thank you in your head!", subtitle: "üòä Thank you to your favorite person!", pause: 5 },
            { text: "Feel that warm fuzzy feeling? That's gratitude! It makes your heart glow!", subtitle: "‚ú® Warm fuzzy glow!", pause: 3 },
            { text: "Now think of your favorite place. Maybe your bedroom, the park, or grandma's house. Say thank you for that place!", subtitle: "üè† Thank you favorite place!", pause: 5 },
            { text: "Think of your favorite food! Mmmm! Thank you yummy food for making my tummy happy!", subtitle: "üçï Thank you yummy food!", pause: 4 },
            { text: "Now here's the tricky one. Think of something your body can do. Like run, or hug, or laugh! Thank you body!", subtitle: "ü§ó Thank you amazing body!", pause: 4 },
            { text: "Last one! Think of something that made you laugh today. Even a tiny giggle. Thank you laughs!", subtitle: "üòÑ Thank you giggles!", pause: 4 },
            { text: "Feel your heart? It's SO full! When we say thank you, our heart fills up like a balloon of happiness!", subtitle: "üéà Heart balloon of happiness!", pause: 3 },
            { text: "You're a Grateful Heart champion! The more thank-yous you find, the happier you feel!", subtitle: "üôè Grateful Heart champion!", pause: 2 },
          ],
          quiz: {
            question: "When we feel grateful, our heart feels‚Ä¶",
            answers: [
              { text: "üíó Warm and full", correct: true },
              { text: "‚ùÑÔ∏è Cold and empty", correct: false },
            ],
          },
          realLifePrompt: "Tell someone 'thank you' and mean it today. Tap when you did!",
        },
      ],
      // ‚îÄ‚îÄ EXPLORER (Ages 6‚Äì8) ‚îÄ‚îÄ
      explorer: [
        {
          id: 1, title: 'Calm Breath', icon: 'üå¨Ô∏è', desc: 'Master belly breathing',
          steps: [
            { text: "Welcome, Explorer! Today you're going to learn your first superpower ‚Äî Calm Breath. Let's go!", subtitle: "üå¨Ô∏è Calm Breath!", pause: 2 },
            { text: "Place both hands on your belly. When you breathe in, your belly should push your hands out ‚Äî like inflating a ball.", subtitle: "üéà Belly pushes hands out", pause: 3 },
            { text: "Breathe in through your nose for four counts. One‚Ä¶ two‚Ä¶ three‚Ä¶ four. Feel your belly rise.", subtitle: "üå¨Ô∏è In: 1-2-3-4", pause: 5 },
            { text: "Hold it for two counts. One‚Ä¶ two.", subtitle: "‚ú® Hold 1-2", pause: 3 },
            { text: "Now breathe out through your mouth for four counts. One‚Ä¶ two‚Ä¶ three‚Ä¶ four. Belly goes flat.", subtitle: "üòÆ‚Äçüí® Out: 1-2-3-4", pause: 5 },
            { text: "Great job! Let's do two more rounds. In through your nose‚Ä¶ belly rises‚Ä¶", subtitle: "üå¨Ô∏è Round 2 ‚Äî breathe in", pause: 5 },
            { text: "Hold‚Ä¶ and out slowly. You're doing amazing.", subtitle: "üòÆ‚Äçüí® And breathe out", pause: 5 },
            { text: "One last round. Biggest belly breath yet! In‚Ä¶", subtitle: "üå¨Ô∏è Final big breath in", pause: 5 },
            { text: "Hold‚Ä¶ and blow it all out. Whoooosh.", subtitle: "üí® Whoooosh", pause: 4 },
            { text: "You mastered Calm Breath! Use it anytime you need to feel steady and strong.", subtitle: "ü¶∏ Calm Breath unlocked!", pause: 2 },
          ],
          quiz: { question: "During belly breathing, your belly should‚Ä¶", answers: [{ text: "üéà Rise when you breathe in", correct: true }, { text: "‚¨áÔ∏è Stay flat the whole time", correct: false }] },
          realLifePrompt: "Try 3 calm breaths before your next test or tricky task. Tap when done!",
        },
        {
          id: 2, title: 'Long Exhale', icon: 'üïØÔ∏è', desc: 'Blow out the candles',
          steps: [
            { text: "Explorer, here's a secret: breathing OUT longer than you breathe IN activates your calm-down system!", subtitle: "üïØÔ∏è The Long Exhale secret", pause: 3 },
            { text: "Imagine five birthday candles. We'll breathe in for 3 counts, then blow out for 5 counts.", subtitle: "üéÇ 5 candles to blow out", pause: 3 },
            { text: "Breathe in: one, two, three.", subtitle: "üå¨Ô∏è In: 1-2-3", pause: 4 },
            { text: "Now blow out slowly: one, two, three, four, five. See the first candle flicker out!", subtitle: "üïØÔ∏è Candle 1 out!", pause: 6 },
            { text: "Again ‚Äî in for three.", subtitle: "üå¨Ô∏è In: 1-2-3", pause: 4 },
            { text: "Out for five. Steady stream! Candle two is out!", subtitle: "üïØÔ∏è Candle 2 out!", pause: 6 },
            { text: "Keep going! In‚Ä¶ and out nice and slow. Three more candles.", subtitle: "üå¨Ô∏è Keep the rhythm", pause: 5 },
            { text: "Almost there‚Ä¶ last candle. Big breath in.", subtitle: "üå¨Ô∏è Last one!", pause: 4 },
            { text: "And the longest, slowest exhale yet. The final candle goes out!", subtitle: "üïØÔ∏è All candles out! üéâ", pause: 6 },
            { text: "You've mastered the Long Exhale! Your out-breath is now longer than your in-breath. That's real calm power.", subtitle: "ü¶∏ Long Exhale unlocked!", pause: 2 },
          ],
          quiz: { question: "In Long Exhale, which is longer?", answers: [{ text: "üå¨Ô∏è Breathing in", correct: false }, { text: "üïØÔ∏è Breathing out", correct: true }] },
          realLifePrompt: "Use a long exhale next time you feel frustrated. Tap when done!",
        },
        {
          id: 3, title: 'Body Radar', icon: 'üì°', desc: 'Scan and release tension',
          steps: [
            { text: "Time to activate your Body Radar! This skill helps you find where tension is hiding in your body.", subtitle: "üì° Body Radar activated!", pause: 2 },
            { text: "Start at your feet. Squeeze your toes tight for five seconds. Squeeze, squeeze, squeeze!", subtitle: "ü¶∂ Squeeze toes tight!", pause: 4 },
            { text: "Now release! Feel the difference? That tingly, relaxed feeling is what we're after.", subtitle: "ü¶∂ Release! Feel the tingle", pause: 3 },
            { text: "Move up to your legs. Tense them like you're pushing against a wall. Hold!", subtitle: "ü¶ø Legs tense!", pause: 4 },
            { text: "And let go. Feel them get heavy and loose. Like cooked spaghetti!", subtitle: "üçù Spaghetti legs!", pause: 3 },
            { text: "Now your arms and fists. Make the tightest fists ever! Flex your arms like a superhero!", subtitle: "üí™ Superhero flex!", pause: 4 },
            { text: "Release! Shake them out. Feel how light and free they are now.", subtitle: "ü´® Shake it out!", pause: 3 },
            { text: "Finally, scrunch your whole face ‚Äî eyes, nose, mouth. Hold tight!", subtitle: "üòñ Scrunch face!", pause: 4 },
            { text: "And relax into a big smile. Notice how calm your whole body feels now.", subtitle: "üòä Ahhh, so calm!", pause: 3 },
            { text: "Body Radar complete! You can scan any part of your body anytime to find and release tension.", subtitle: "üì° Body Radar mastered!", pause: 2 },
          ],
          quiz: { question: "After squeezing a muscle, you should‚Ä¶", answers: [{ text: "üßò Release and feel the difference", correct: true }, { text: "üí™ Keep squeezing harder", correct: false }] },
          realLifePrompt: "Do a quick body scan before bed tonight. Tap when done!",
        },
        {
          id: 4, title: 'Thought Clouds', icon: '‚òÅÔ∏è', desc: 'Watch thoughts drift by',
          steps: [
            { text: "Explorer, imagine your mind is a big blue sky. Thoughts are like clouds ‚Äî they come and go.", subtitle: "‚òÅÔ∏è Mind = sky, thoughts = clouds", pause: 3 },
            { text: "Close your eyes. Picture a bright blue sky. It's peaceful and wide.", subtitle: "üîµ Bright blue sky", pause: 4 },
            { text: "Now a cloud drifts in. Maybe it's a thought about school, a friend, or something funny. Just notice it.", subtitle: "‚òÅÔ∏è A thought floats in‚Ä¶", pause: 4 },
            { text: "Here's the key: you don't grab it. You just watch it float across the sky. No need to chase it.", subtitle: "üëÄ Just watch, don't chase", pause: 4 },
            { text: "And it drifts away. Another cloud appears ‚Äî maybe a worry. That's okay too. Watch it pass.", subtitle: "‚òÅÔ∏è Worry cloud passing‚Ä¶", pause: 4 },
            { text: "Gone. Thoughts always move on if you let them. You don't have to hold onto any thought.", subtitle: "‚ú® Thoughts always pass", pause: 4 },
            { text: "One more cloud. This one can be anything. Maybe silly, maybe serious. Just let it float.", subtitle: "‚òÅÔ∏è One more cloud‚Ä¶", pause: 4 },
            { text: "And watch it drift out of sight. You are the sky ‚Äî calm, wide, always there. Thoughts are just visitors.", subtitle: "üå§Ô∏è You are the sky", pause: 3 },
            { text: "Open your eyes. You've mastered Thought Clouds! Thoughts come and go ‚Äî you get to choose which ones to follow.", subtitle: "ü¶∏ Thought Clouds unlocked!", pause: 2 },
          ],
          quiz: { question: "When a worry thought comes, we‚Ä¶", answers: [{ text: "üå§Ô∏è Watch it pass like a cloud", correct: true }, { text: "üß≤ Hold on tight", correct: false }] },
          realLifePrompt: "Notice one thought cloud at school and let it float away. Tap when done!",
        },
        {
          id: 5, title: 'Kindness', icon: 'üíñ', desc: 'Send kind wishes to the world',
          steps: [
            { text: "This superpower makes your heart glow. It's called Kindness ‚Äî sending good wishes to others.", subtitle: "üíñ Kindness power!", pause: 2 },
            { text: "Put your hand on your chest. Feel your heartbeat. That's your kindness engine.", subtitle: "üíó Your kindness engine", pause: 3 },
            { text: "First, send kind wishes to yourself. In your mind say: May I be happy. May I be safe. May I be healthy.", subtitle: "üåü Kind wishes to yourself", pause: 5 },
            { text: "Notice the warm feeling spreading in your chest. That's real.", subtitle: "‚òÄÔ∏è Warmth spreading", pause: 3 },
            { text: "Now think of your best friend. Send them the same wishes: May you be happy. May you be safe.", subtitle: "üë´ Wishes to your friend", pause: 5 },
            { text: "Now think of someone who might be having a tough day. Send them kindness too.", subtitle: "ü§ó Wishes to someone struggling", pause: 5 },
            { text: "Here's the challenging part: think of someone you don't know well, or even someone you disagree with. Send them kindness.", subtitle: "üåç Kindness to everyone", pause: 5 },
            { text: "Finally, imagine your kindness spreading outward like ripples in a pond ‚Äî to your neighborhood, your city, the whole world.", subtitle: "üåä Kindness ripples outward", pause: 4 },
            { text: "You've unlocked Kindness! The more you send, the more you feel. That's the magic.", subtitle: "üíñ Kindness unlocked!", pause: 2 },
          ],
          quiz: { question: "Kind wishes should go to‚Ä¶", answers: [{ text: "üßç Only people I like", correct: false }, { text: "üåç Everyone, even strangers", correct: true }] },
          realLifePrompt: "Say something kind to someone unexpected today. Tap when done!",
        },
        {
          id: 6, title: 'Rainbow Breathing', icon: 'üåà', desc: 'Breathe in colors',
          steps: [
            { text: "Let's combine breathing with imagination! Each breath brings in a different color of the rainbow.", subtitle: "üåà Rainbow Breathing!", pause: 2 },
            { text: "Breathe in RED ‚Äî warm, energizing. Imagine red light filling your lungs.", subtitle: "üî¥ Breathe in RED", pause: 4 },
            { text: "Breathe out and feel the red energy spreading through your body.", subtitle: "üî¥ Red energy!", pause: 3 },
            { text: "Breathe in ORANGE ‚Äî creative, joyful. Warm orange fills you up.", subtitle: "üü† Breathe in ORANGE", pause: 4 },
            { text: "Breathe out orange sparkles. Feel the creativity!", subtitle: "üü† Orange sparkles", pause: 3 },
            { text: "YELLOW ‚Äî bright like sunshine. Breathe it in, feel happy and confident.", subtitle: "üü° Breathe in YELLOW", pause: 4 },
            { text: "Breathe out and share the sunshine.", subtitle: "üü° Share the sunshine", pause: 3 },
            { text: "GREEN ‚Äî fresh like nature. Breathe in calm, fresh air.", subtitle: "üü¢ Breathe in GREEN", pause: 4 },
            { text: "Breathe out any stress. Green takes it away.", subtitle: "üü¢ Stress dissolves", pause: 3 },
            { text: "BLUE ‚Äî cool and peaceful like the ocean. Deep blue breath in.", subtitle: "üîµ Breathe in BLUE", pause: 4 },
            { text: "Breathe out and feel totally at peace.", subtitle: "üîµ Total peace", pause: 3 },
            { text: "PURPLE ‚Äî magical and wise. The final color. Breathe it in deep.", subtitle: "üü£ Breathe in PURPLE", pause: 4 },
            { text: "Breathe out and feel the complete rainbow inside you. You're glowing with every color!", subtitle: "üåà Rainbow complete!", pause: 2 },
          ],
          quiz: { question: "The last color in Rainbow Breathing is‚Ä¶", answers: [{ text: "üî¥ Red", correct: false }, { text: "üü£ Purple", correct: true }] },
          realLifePrompt: "Try rainbow breathing when you need a mood boost. Tap when done!",
        },
        {
          id: 7, title: 'Starfish Stretch', icon: '‚≠ê', desc: 'Stretch and release',
          steps: [
            { text: "Time to move your body! Starfish Stretch combines stretching with deep breathing.", subtitle: "‚≠ê Starfish Stretch!", pause: 2 },
            { text: "Stand up and spread your arms and legs wide ‚Äî like a starfish!", subtitle: "‚≠ê Spread wide!", pause: 3 },
            { text: "Breathe in and reach your right hand to the sky. Stretch as high as you can!", subtitle: "‚òÅÔ∏è Right hand to the sky!", pause: 4 },
            { text: "Breathe out and slowly bring it down. Feel the stretch release.", subtitle: "üåä Release‚Ä¶", pause: 3 },
            { text: "Breathe in, left hand up! Reach through the ceiling!", subtitle: "‚òÅÔ∏è Left hand up high!", pause: 4 },
            { text: "Breathe out and lower. Notice how loose that side feels.", subtitle: "üåä Loose and free", pause: 3 },
            { text: "Now both arms up! Stand on tiptoes! You're the tallest starfish in the ocean!", subtitle: "‚≠ê Tallest starfish ever!", pause: 4 },
            { text: "Slowly melt down toward the ground. Breathe out as you fold forward. Melt, melt, melt.", subtitle: "ü´† Melting down‚Ä¶", pause: 5 },
            { text: "Now lie still like a starfish on a warm beach. Feel the calm spread through every part of you.", subtitle: "üèñÔ∏è Beach starfish! So calm", pause: 5 },
            { text: "Starfish Stretch complete! Great for when you're feeling stiff or stressed.", subtitle: "‚≠ê Starfish Stretch mastered!", pause: 2 },
          ],
          quiz: { question: "After stretching tall, we‚Ä¶", answers: [{ text: "ü´† Slowly melt down", correct: true }, { text: "üèÉ Jump around fast", correct: false }] },
          realLifePrompt: "Do a starfish stretch when you wake up tomorrow. Tap when done!",
        },
        {
          id: 8, title: 'Bubble Thoughts', icon: 'ü´ß', desc: 'Release worries in bubbles',
          steps: [
            { text: "Imagine you have a magic bubble wand. These bubbles can carry away your worries!", subtitle: "ü´ß Magic bubble wand!", pause: 2 },
            { text: "Think of something that's been on your mind. A worry, a frustration, anything. Hold it in your thoughts.", subtitle: "ü§î Think of a worry‚Ä¶", pause: 4 },
            { text: "Take a deep breath in. Now imagine blowing that worry into a bubble.", subtitle: "üå¨Ô∏è Deep breath in!", pause: 3 },
            { text: "Blow! Watch the bubble float up, carrying your worry away. Higher and higher.", subtitle: "ü´ß Up, up, and away!", pause: 4 },
            { text: "Pop! The worry is gone. Dissolved into nothing.", subtitle: "üí• Pop! Gone!", pause: 3 },
            { text: "Got another one? Breathe in deep.", subtitle: "üå¨Ô∏è Another deep breath", pause: 3 },
            { text: "Blow it into a bubble. Watch it float away and pop. Goodbye worry!", subtitle: "ü´ß Goodbye worry!", pause: 4 },
            { text: "Now blow the biggest bubble you can imagine. Put ALL your leftover worries in it.", subtitle: "ü´ß Biggest bubble EVER!", pause: 3 },
            { text: "Watch it rise up into the sky‚Ä¶ and POP! All gone. Feel how light you are now.", subtitle: "üí• All worries gone!", pause: 3 },
            { text: "Bubble Thoughts mastered! Whenever worries pile up, blow them into bubbles.", subtitle: "ü´ß Bubble Thoughts mastered!", pause: 2 },
          ],
          quiz: { question: "What happens to the worry bubble?", answers: [{ text: "ü´ß It floats away and pops", correct: true }, { text: "üß≤ It stays stuck to you", correct: false }] },
          realLifePrompt: "Blow an imaginary worry bubble before homework. Tap when done!",
        },
        {
          id: 9, title: 'Animal Breaths', icon: 'üêæ', desc: 'Breathe like different animals',
          steps: [
            { text: "Let's explore how different animals breathe! Each one teaches a different kind of calm.", subtitle: "üêæ Animal Breaths!", pause: 2 },
            { text: "BUNNY BREATH ‚Äî Quick little sniffs through your nose, like a bunny smelling flowers! Sniff-sniff-sniff!", subtitle: "üê∞ Bunny sniffs!", pause: 4 },
            { text: "Then one long sigh out. This is great for when you need quick energy.", subtitle: "üê∞ Long bunny sigh", pause: 3 },
            { text: "SNAKE BREATH ‚Äî Breathe in through your nose, then hiss it out. Hissssssss! Make it last as long as you can.", subtitle: "üêç Hissssss!", pause: 5 },
            { text: "The longer your hiss, the calmer you get. Try an even longer one! Hissssssssss!", subtitle: "üêç Longest hiss!", pause: 5 },
            { text: "LION BREATH ‚Äî Big breath in, then open your mouth wide, stick out your tongue, and ROAR! Let everything out!", subtitle: "ü¶Å ROAR!", pause: 4 },
            { text: "That felt good, right? Lion breath releases frustration and tension.", subtitle: "ü¶Å Tension released!", pause: 3 },
            { text: "BEAR BREATH ‚Äî The slowest, deepest breaths. Like a bear drifting off to hibernation. Slow in‚Ä¶", subtitle: "üß∏ Slow bear breath in‚Ä¶", pause: 5 },
            { text: "And the slowest breath out. Warm and heavy. Ready for sleep.", subtitle: "üß∏ Slow bear breath out‚Ä¶", pause: 5 },
            { text: "Animal Breaths mastered! Bunny for energy, snake for calm, lion for feelings, bear for sleep.", subtitle: "üêæ Animal Breaths mastered!", pause: 2 },
          ],
          quiz: { question: "Which breath releases frustration best?", answers: [{ text: "üê∞ Bunny sniffs", correct: false }, { text: "ü¶Å Lion roar", correct: true }] },
          realLifePrompt: "Try snake breath before a stressful moment. Tap when done!",
        },
        {
          id: 10, title: 'Grateful Heart', icon: 'üôè', desc: 'Practice gratitude',
          steps: [
            { text: "Gratitude is a superpower that makes everything brighter. Let's practice it!", subtitle: "üôè Grateful Heart!", pause: 2 },
            { text: "Place your hand on your heart. Feel it beating ‚Äî that rhythm is your gratitude engine.", subtitle: "üíó Gratitude engine", pause: 3 },
            { text: "Think of a person who makes your life better. A parent, teacher, friend. Say 'thank you' in your mind.", subtitle: "üòä Thank you to someone special", pause: 5 },
            { text: "Feel the warmth? That's gratitude. It fills you up.", subtitle: "‚ú® Warm feeling", pause: 3 },
            { text: "Now think of a place you love. Your room, the park, grandma's house. Thank you, special place.", subtitle: "üè† Thank you, favorite place", pause: 5 },
            { text: "Think of something your body can do ‚Äî run, draw, hug. Thank your body for being amazing.", subtitle: "ü§ó Thank you, body!", pause: 4 },
            { text: "Think of a challenge you've overcome. Thank yourself for being brave enough to face it.", subtitle: "üí™ Thank you for being brave", pause: 5 },
            { text: "Finally, find something tiny to be grateful for today. A sunrise, a joke, a snack. Even tiny things count.", subtitle: "üåÖ Gratitude in small things", pause: 4 },
            { text: "Your heart is full now. The more you practice gratitude, the happier you feel every day.", subtitle: "üôè Grateful Heart mastered!", pause: 2 },
          ],
          quiz: { question: "We can feel grateful for‚Ä¶", answers: [{ text: "üíó Big and small things", correct: true }, { text: "üèÜ Only big achievements", correct: false }] },
          realLifePrompt: "Write down 3 things you're grateful for tonight. Tap when done!",
        },
      ],
      // ‚îÄ‚îÄ INDEPENDENT (Ages 9‚Äì10) ‚îÄ‚îÄ
      independent: [
        {
          id: 1, title: 'Calm Breath', icon: 'üå¨Ô∏è', desc: 'Diaphragmatic breathing technique',
          steps: [
            { text: "Let's learn diaphragmatic breathing ‚Äî the foundation of every calm-down technique. It activates your parasympathetic nervous system.", subtitle: "üå¨Ô∏è Diaphragmatic breathing", pause: 3 },
            { text: "Place one hand on your chest and one on your belly. When you breathe correctly, only your belly hand should move.", subtitle: "üß™ Only belly moves", pause: 4 },
            { text: "Breathe in through your nose for 4 counts. Focus on pushing your belly out while keeping your chest still.", subtitle: "üå¨Ô∏è In: 4 counts, belly rises", pause: 5 },
            { text: "Hold for 4 counts. This lets your lungs fully absorb the oxygen.", subtitle: "‚è∏Ô∏è Hold: 4 counts", pause: 5 },
            { text: "Exhale slowly through your mouth for 6 counts. Your belly naturally deflates.", subtitle: "üòÆ‚Äçüí® Out: 6 counts", pause: 7 },
            { text: "Notice: the exhale is longer than the inhale. That's intentional ‚Äî it signals your brain to relax.", subtitle: "üß† Longer exhale = calm signal", pause: 4 },
            { text: "Round two. In for 4‚Ä¶ hold for 4‚Ä¶ out for 6. Find your rhythm.", subtitle: "üîÑ Round 2", pause: 6 },
            { text: "Final round. This time, really notice the pause between exhale and the next inhale. That's the stillest moment.", subtitle: "üîÑ Round 3 ‚Äî find the stillness", pause: 6 },
            { text: "You've learned the science behind calm breathing. Use this anytime ‚Äî before tests, when angry, or just to reset.", subtitle: "üß† Calm Breath mastered", pause: 3 },
          ],
          quiz: { question: "Why is the exhale longer than the inhale?", answers: [{ text: "üß† It signals the brain to relax", correct: true }, { text: "üí™ It builds lung strength", correct: false }] },
          realLifePrompt: "Use diaphragmatic breathing before a challenging situation this week. Journal what you noticed. Tap when done.",
        },
        {
          id: 2, title: 'Long Exhale', icon: 'üïØÔ∏è', desc: 'Extended exhale technique',
          steps: [
            { text: "The extended exhale is one of the most powerful tools in your toolkit. Here's why it works.", subtitle: "üïØÔ∏è Extended exhale", pause: 3 },
            { text: "Your vagus nerve runs from your brain to your gut. Long exhales stimulate it, lowering your heart rate.", subtitle: "üß† Vagus nerve activation", pause: 4 },
            { text: "We'll use a 3-6 pattern: breathe in for 3 counts, out for 6. Double the exhale.", subtitle: "üìê 3 in, 6 out", pause: 3 },
            { text: "Breathe in: one, two, three.", subtitle: "üå¨Ô∏è In: 1-2-3", pause: 4 },
            { text: "Now exhale slowly through pursed lips: one, two, three, four, five, six. Control the airflow.", subtitle: "üïØÔ∏è Out: 1-2-3-4-5-6", pause: 7 },
            { text: "Good. Let's increase to 4-8. In for four counts.", subtitle: "üå¨Ô∏è In: 1-2-3-4", pause: 5 },
            { text: "Out for eight. Steady, controlled stream. Let the exhale be effortless.", subtitle: "üïØÔ∏è Out: 1 through 8", pause: 9 },
            { text: "One more round at 4-8. Notice how your heart rate drops after each exhale.", subtitle: "üíì Heart rate dropping", pause: 6 },
            { text: "You've mastered the extended exhale. This is used by athletes, musicians, and even astronauts to stay calm under pressure.", subtitle: "ü¶∏ Extended Exhale mastered", pause: 3 },
          ],
          quiz: { question: "The extended exhale works by stimulating the‚Ä¶", answers: [{ text: "üí™ Muscles", correct: false }, { text: "üß† Vagus nerve", correct: true }] },
          realLifePrompt: "Try 4-8 breathing before bed for 3 nights. Notice if you fall asleep faster. Tap when done.",
        },
        {
          id: 3, title: 'Body Radar', icon: 'üì°', desc: 'Progressive muscle relaxation',
          steps: [
            { text: "Progressive muscle relaxation, or PMR, is a technique developed by doctors. You tense each muscle group, then release.", subtitle: "üì° Progressive Muscle Relaxation", pause: 3 },
            { text: "The science: tensing a muscle before releasing it creates a deeper relaxation than just trying to relax.", subtitle: "üß™ Tension ‚Üí deeper release", pause: 4 },
            { text: "Start with your feet. Curl your toes tight. Hold for 5 seconds. Really squeeze.", subtitle: "ü¶∂ Toes: squeeze 5 sec", pause: 6 },
            { text: "Release. Notice the contrast between tension and relaxation. That awareness is the skill.", subtitle: "ü¶∂ Release ‚Äî notice the contrast", pause: 4 },
            { text: "Legs next. Press your thighs together and tighten everything. Hold for 5.", subtitle: "ü¶ø Legs tight ‚Äî hold 5", pause: 6 },
            { text: "Release. Feel the warmth flooding in as blood flow returns.", subtitle: "ü¶ø Release ‚Äî warmth floods in", pause: 4 },
            { text: "Arms and hands. Make the tightest fists. Flex your biceps. Hold.", subtitle: "üí™ Fists + biceps ‚Äî hold", pause: 6 },
            { text: "Release. Let your arms drop heavy. Notice how different they feel.", subtitle: "üí™ Drop and release", pause: 4 },
            { text: "Face. Scrunch everything ‚Äî forehead, eyes, jaw. Hold tight.", subtitle: "üòñ Full face scrunch", pause: 5 },
            { text: "Release into a neutral face. Scan your body ‚Äî you should feel significantly more relaxed than when we started.", subtitle: "üì° Full scan complete", pause: 3 },
          ],
          quiz: { question: "Why do we tense muscles before relaxing them?", answers: [{ text: "üì° It creates a deeper relaxation", correct: true }, { text: "üí™ To build muscle strength", correct: false }] },
          realLifePrompt: "Practice PMR before sleep 3 times this week. Rate your sleep quality each morning. Tap when done.",
        },
        {
          id: 4, title: 'Thought Clouds', icon: '‚òÅÔ∏è', desc: 'Mindful observation of thoughts',
          steps: [
            { text: "Mindful observation means watching your thoughts without judging them or getting caught up in them.", subtitle: "‚òÅÔ∏è Mindful observation", pause: 3 },
            { text: "Imagine sitting beside a stream. Leaves float by on the water. Each leaf carries a thought.", subtitle: "üçÉ Thoughts on leaves", pause: 4 },
            { text: "Close your eyes. When a thought appears, place it on a leaf and watch it float downstream.", subtitle: "üçÉ Place thought on a leaf", pause: 5 },
            { text: "The goal isn't to stop thinking. It's to create space between you and your thoughts.", subtitle: "üìê Creating space", pause: 5 },
            { text: "Notice: are your thoughts mostly about the past, the future, or the present? Just observe, no judgment.", subtitle: "üîç Past, future, or present?", pause: 5 },
            { text: "If you catch yourself following a thought ‚Äî that's normal. Gently place it back on a leaf.", subtitle: "üçÉ Gently return", pause: 5 },
            { text: "Here's the insight: you are not your thoughts. You are the one watching them. There's a big difference.", subtitle: "üß† You are the watcher", pause: 5 },
            { text: "Open your eyes when ready. With practice, you can create this observing space anytime, anywhere.", subtitle: "‚òÅÔ∏è Thought observation mastered", pause: 3 },
          ],
          quiz: { question: "The goal of thought observation is to‚Ä¶", answers: [{ text: "üõë Stop all thoughts", correct: false }, { text: "üìê Create space between you and your thoughts", correct: true }] },
          realLifePrompt: "Spend 2 minutes observing your thoughts without reacting. Write down what you noticed. Tap when done.",
        },
        {
          id: 5, title: 'Kindness', icon: 'üíñ', desc: 'Loving-kindness meditation',
          steps: [
            { text: "Loving-kindness meditation has been practiced for thousands of years. Research shows it increases empathy and well-being.", subtitle: "üíñ Loving-kindness", pause: 3 },
            { text: "Place your hand on your heart. We'll send wishes in expanding circles, starting with yourself.", subtitle: "üíó Expanding circles", pause: 3 },
            { text: "To yourself: May I be happy. May I be healthy. May I be safe. May I live with ease.", subtitle: "üåü Wishes to self", pause: 6 },
            { text: "To someone you love: May you be happy. May you be healthy. May you be safe. May you live with ease.", subtitle: "‚ù§Ô∏è Wishes to loved one", pause: 6 },
            { text: "To a neutral person ‚Äî someone you see but don't really know. The bus driver, a classmate. Same wishes.", subtitle: "ü§ù Wishes to a neutral person", pause: 6 },
            { text: "Now the hardest part: to someone difficult. Someone you've had conflict with. May you be happy. May you be safe.", subtitle: "üî• Wishes to a difficult person", pause: 6 },
            { text: "Finally, to all beings everywhere. Every person, every animal. May all beings be happy and free from suffering.", subtitle: "üåç Wishes to all beings", pause: 5 },
            { text: "Studies show this practice literally changes your brain ‚Äî increasing activity in areas linked to compassion.", subtitle: "üß† Brain changes with practice", pause: 4 },
            { text: "Loving-kindness mastered. The more you practice, the more natural compassion becomes.", subtitle: "üíñ Loving-kindness mastered", pause: 2 },
          ],
          quiz: { question: "Loving-kindness wishes should include‚Ä¶", answers: [{ text: "üåç Everyone, including difficult people", correct: true }, { text: "‚ù§Ô∏è Only people you already like", correct: false }] },
          realLifePrompt: "Send silent loving-kindness wishes to 3 people today ‚Äî one loved, one neutral, one difficult. Tap when done.",
        },
        {
          id: 6, title: 'Rainbow Breathing', icon: 'üåà', desc: 'Visualization breathing',
          steps: [
            { text: "Visualization breathing combines breath control with mental imagery to deepen relaxation.", subtitle: "üåà Visualization breathing", pause: 3 },
            { text: "With each breath, we'll visualize a different color entering and energizing a different quality.", subtitle: "üé® Color = quality", pause: 3 },
            { text: "RED ‚Äî breathe in courage and strength. Feel it filling your core.", subtitle: "üî¥ Red = courage", pause: 5 },
            { text: "Breathe out doubt. Let it dissolve.", subtitle: "üî¥ Doubt dissolves", pause: 3 },
            { text: "ORANGE ‚Äî breathe in creativity. Ideas flowing freely.", subtitle: "üü† Orange = creativity", pause: 5 },
            { text: "YELLOW ‚Äî breathe in confidence. You are capable and strong.", subtitle: "üü° Yellow = confidence", pause: 5 },
            { text: "GREEN ‚Äî breathe in balance and healing. Your body knows how to restore itself.", subtitle: "üü¢ Green = healing", pause: 5 },
            { text: "BLUE ‚Äî breathe in calm communication. You can express yourself clearly.", subtitle: "üîµ Blue = communication", pause: 5 },
            { text: "PURPLE ‚Äî breathe in wisdom and intuition. Trust your inner knowing.", subtitle: "üü£ Purple = wisdom", pause: 5 },
            { text: "All colors are now inside you. You carry courage, creativity, confidence, balance, clarity, and wisdom.", subtitle: "üåà All qualities within you", pause: 3 },
          ],
          quiz: { question: "Visualization breathing works by combining‚Ä¶", answers: [{ text: "üß† Breath control and mental imagery", correct: true }, { text: "üèÉ Exercise and breathing", correct: false }] },
          realLifePrompt: "Before a challenging task, breathe in the color you need most. Tap when done.",
        },
        {
          id: 7, title: 'Starfish Stretch', icon: '‚≠ê', desc: 'Mindful movement',
          steps: [
            { text: "Mindful movement means paying full attention to how your body feels as you move.", subtitle: "‚≠ê Mindful movement", pause: 3 },
            { text: "Stand with feet shoulder-width apart. Close your eyes. Notice how your body feels right now.", subtitle: "üßç Baseline check", pause: 4 },
            { text: "Inhale and slowly raise both arms overhead. Notice every muscle engaging on the way up.", subtitle: "‚¨ÜÔ∏è Arms up ‚Äî notice each muscle", pause: 5 },
            { text: "At the top, stretch through your fingertips. Reach for the ceiling. Hold and breathe.", subtitle: "‚òÅÔ∏è Stretch and hold", pause: 5 },
            { text: "Exhale and slowly fold forward. Let gravity do the work. Don't force it.", subtitle: "‚¨áÔ∏è Fold forward ‚Äî gravity's work", pause: 6 },
            { text: "Hang there. Feel the stretch in your hamstrings and lower back. Breathe into the tight spots.", subtitle: "üßò Breathe into tight spots", pause: 6 },
            { text: "Slowly roll up, one vertebra at a time. Notice how each section of your spine stacks.", subtitle: "‚¨ÜÔ∏è Roll up slowly", pause: 6 },
            { text: "Open your arms wide like a starfish. Take up space. You deserve to.", subtitle: "‚≠ê Take up space", pause: 4 },
            { text: "Now relax everything. Let your arms drop. Compare how you feel now to when we started.", subtitle: "üìä Before vs. after", pause: 3 },
            { text: "Mindful movement mastered. The key is awareness ‚Äî paying attention to sensation, not just doing the movement.", subtitle: "‚≠ê Mindful movement mastered", pause: 3 },
          ],
          quiz: { question: "The key to mindful movement is‚Ä¶", answers: [{ text: "üß† Awareness of sensation", correct: true }, { text: "üí™ Moving as fast as possible", correct: false }] },
          realLifePrompt: "Do 3 mindful stretches during a study break. Notice how your focus changes afterward. Tap when done.",
        },
        {
          id: 8, title: 'Bubble Thoughts', icon: 'ü´ß', desc: 'Cognitive defusion',
          steps: [
            { text: "Cognitive defusion is a technique where you separate yourself from unhelpful thoughts.", subtitle: "ü´ß Cognitive defusion", pause: 3 },
            { text: "Think of a worry or negative thought you've had recently. Something that keeps coming back.", subtitle: "ü§î A recurring thought‚Ä¶", pause: 4 },
            { text: "Now imagine putting that thought into a bubble. Watch it float in front of you. You can see it, but you're not inside it.", subtitle: "ü´ß Thought in a bubble", pause: 5 },
            { text: "Try saying the thought with a silly voice in your head. Notice how it loses some of its power.", subtitle: "üó£Ô∏è Silly voice ‚Äî power fades", pause: 5 },
            { text: "Now let the bubble float away. The thought might come back later ‚Äî that's fine. You know how to bubble it again.", subtitle: "ü´ß Float away‚Ä¶", pause: 4 },
            { text: "Try this with another thought. Notice: you are not your thoughts. You are the person observing them.", subtitle: "üß† You observe thoughts", pause: 5 },
            { text: "Bubble it. Watch it float. You have the power to create distance between you and any thought.", subtitle: "ü´ß Distance from thoughts", pause: 4 },
            { text: "Cognitive defusion mastered. This technique is used by therapists worldwide. The more you practice, the more control you have.", subtitle: "ü´ß Cognitive defusion mastered", pause: 3 },
          ],
          quiz: { question: "Cognitive defusion helps you‚Ä¶", answers: [{ text: "ü´ß Create distance from thoughts", correct: true }, { text: "üõë Eliminate all negative thoughts", correct: false }] },
          realLifePrompt: "Next time a worry loops in your head, try bubbling it. Write about what changed. Tap when done.",
        },
        {
          id: 9, title: 'Animal Breaths', icon: 'üêæ', desc: 'Breath pattern exploration',
          steps: [
            { text: "Different breathing patterns create different effects in your body. Let's explore four distinct patterns.", subtitle: "üêæ Breath patterns", pause: 3 },
            { text: "RABBIT BREATHING ‚Äî Short, quick inhales through the nose, followed by one long exhale. This energizes you.", subtitle: "üê∞ Quick in, long out", pause: 4 },
            { text: "Try it: sniff-sniff-sniff-sniff‚Ä¶ then one slow exhale. Feel the energy.", subtitle: "üê∞ Energizing pattern", pause: 5 },
            { text: "SNAKE BREATHING ‚Äî Equal inhale, extended hissing exhale. This activates your parasympathetic system.", subtitle: "üêç Extended hiss exhale", pause: 4 },
            { text: "Breathe in for 4‚Ä¶ hiss out as long as you can. 8, 10, even 12 counts.", subtitle: "üêç Maximum hiss length", pause: 6 },
            { text: "LION BREATHING ‚Äî Deep inhale, forceful open-mouth exhale with tongue out. This releases tension and emotion.", subtitle: "ü¶Å Tension release", pause: 4 },
            { text: "Try it. Big breath in‚Ä¶ and HAAA! Tongue out, eyes wide. Feel the release.", subtitle: "ü¶Å HAAA! Full release", pause: 5 },
            { text: "HIBERNATION BREATHING ‚Äî The slowest, gentlest breathing. 6 in, 2 hold, 8 out. This prepares you for sleep.", subtitle: "üß∏ Sleep preparation", pause: 5 },
            { text: "Try it: 6 in‚Ä¶ hold 2‚Ä¶ 8 out. Feel your whole body getting heavy.", subtitle: "üß∏ Heavy and sleepy", pause: 6 },
            { text: "You now have four tools: rabbit for energy, snake for calm, lion for emotions, hibernation for sleep. Choose based on what you need.", subtitle: "üêæ Four tools mastered", pause: 3 },
          ],
          quiz: { question: "Hibernation breathing is best used for‚Ä¶", answers: [{ text: "‚ö° Quick energy", correct: false }, { text: "üò¥ Preparing for sleep", correct: true }] },
          realLifePrompt: "Try all 4 breath patterns in one day. Note which one helped most and when. Tap when done.",
        },
        {
          id: 10, title: 'Grateful Heart', icon: 'üôè', desc: 'Gratitude practice',
          steps: [
            { text: "Research shows that regular gratitude practice increases happiness by up to 25%. Let's build this habit.", subtitle: "üôè Evidence-based gratitude", pause: 3 },
            { text: "Close your eyes. Hand on heart. We'll scan five areas of gratitude.", subtitle: "üíó Five gratitude areas", pause: 3 },
            { text: "First: people. Think of someone who helped you grow as a person. Feel genuine appreciation for them.", subtitle: "üòä Gratitude for mentors", pause: 6 },
            { text: "Second: abilities. What's something you can do now that you couldn't do a year ago? Appreciate your growth.", subtitle: "üìà Gratitude for growth", pause: 6 },
            { text: "Third: challenges. Think of a hard moment that taught you something. Can you feel grateful for the lesson?", subtitle: "üî• Gratitude for challenges", pause: 6 },
            { text: "Fourth: basics. Clean water, food, shelter, health. These aren't guaranteed for everyone. Take a moment.", subtitle: "üè† Gratitude for basics", pause: 5 },
            { text: "Fifth: this moment. Right here, right now. You're alive, learning, growing. That's worth appreciating.", subtitle: "üåÖ Gratitude for now", pause: 5 },
            { text: "Gratitude isn't about ignoring problems. It's about training your brain to notice what's already good.", subtitle: "üß† Rewiring your brain", pause: 4 },
            { text: "Gratitude practice mastered. Try to find 3 things to be grateful for every day ‚Äî it literally rewires your brain.", subtitle: "üôè Gratitude practice mastered", pause: 3 },
          ],
          quiz: { question: "Regular gratitude practice can increase happiness by up to‚Ä¶", answers: [{ text: "üìà 25%", correct: true }, { text: "üìà 1%", correct: false }] },
          realLifePrompt: "Start a gratitude journal. Write 3 things each night for a week. Tap when done.",
        },
      ],
    };

    function getCurriculum() {
      const mode = getAgeMode();
      return CURRICULUM_BY_AGE[mode] || CURRICULUM_BY_AGE.tiny;
    }

    // ===== PARENT ZONE =====
    function switchParentTab(tab) {
      document.querySelectorAll('.parent-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.parent-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.parent-tab[onclick*="${tab}"]`).classList.add('active');
      document.getElementById('parent-' + tab).classList.add('active');
      if (tab === 'dashboard') refreshDashboard();
    }

    // --- Together Mode ---
    let togetherRunning = false;
    let togetherTimer = null;

    async function startTogetherMode() {
      if (togetherRunning) { stopTogetherMode(); return; }
      togetherRunning = true;
      const btn = document.getElementById('together-start-btn');
      btn.textContent = 'Stop';
      const circle = document.getElementById('together-circle');
      const label = document.getElementById('together-label');
      const sublabel = document.getElementById('together-sublabel');
      const timerEl = document.getElementById('together-timer');

      const totalSeconds = 180; // 3 minutes
      let elapsed = 0;
      let cycleCount = 0;

      // Intro voice
      await elevenSpeak("Let's breathe together. Place your hands on your bellies. Here we go.");

      // Varied cues for each cycle so it doesn't feel robotic
      const inhaleCues = [
        'Breathe in together, slowly through your nose.',
        'In through your nose, nice and slow.',
        'Breathe in, fill your belly with air.',
        'Slowly in, feel your belly rise.',
      ];
      const holdCues = [
        'Hold it gently.',
        'Hold together.',
        'Keep it in.',
        'Pause right here.',
      ];
      const exhaleCues = [
        'Now breathe out, slowly through your mouth.',
        'Let it all out, nice and slow.',
        'Exhale together, let everything go.',
        'Breathe out, let your body relax.',
      ];

      // Breathing cycle: 4s inhale, 2s hold, 4s exhale, 1s pause = 11s
      while (togetherRunning && elapsed < totalSeconds) {
        const ci = cycleCount % inhaleCues.length;

        // Inhale
        label.textContent = 'Breathe In';
        sublabel.textContent = 'Both breathe in slowly through your nose';
        circle.className = 'together-circle inhale';
        circle.textContent = 'üå¨Ô∏è';
        elevenSpeak(inhaleCues[ci]);
        for (let i = 0; i < 4 && togetherRunning; i++) {
          timerEl.textContent = formatTime(totalSeconds - elapsed);
          await sleep(1000); elapsed++;
        }
        if (!togetherRunning) break;

        // Hold
        label.textContent = 'Hold';
        sublabel.textContent = 'Hold it gently together';
        circle.textContent = '‚ú®';
        elevenSpeak(holdCues[ci]);
        for (let i = 0; i < 2 && togetherRunning; i++) {
          timerEl.textContent = formatTime(totalSeconds - elapsed);
          await sleep(1000); elapsed++;
        }
        if (!togetherRunning) break;

        // Exhale
        label.textContent = 'Breathe Out';
        sublabel.textContent = 'Both breathe out slowly through your mouth';
        circle.className = 'together-circle exhale';
        circle.textContent = 'üòÆ‚Äçüí®';
        elevenSpeak(exhaleCues[ci]);
        for (let i = 0; i < 4 && togetherRunning; i++) {
          timerEl.textContent = formatTime(totalSeconds - elapsed);
          await sleep(1000); elapsed++;
        }
        if (!togetherRunning) break;

        // Pause
        label.textContent = 'Rest';
        sublabel.textContent = 'Gentle pause';
        circle.className = 'together-circle';
        circle.textContent = 'ü§ù';
        await sleep(1000); elapsed++;
        timerEl.textContent = formatTime(totalSeconds - elapsed);

        cycleCount++;
      }

      // Complete
      togetherRunning = false;
      label.textContent = 'Amazing! ‚≠ê';
      sublabel.textContent = 'You both did great! Star earned!';
      circle.className = 'together-circle';
      circle.textContent = 'üéâ';
      btn.textContent = 'Start Breathing';
      timerEl.textContent = '';
      elevenSpeak("Amazing! You both did great. Star earned!");
      addStar();
      logActivity('together');
    }

    function stopTogetherMode() {
      togetherRunning = false;
      const btn = document.getElementById('together-start-btn');
      btn.textContent = 'Start Breathing';
      document.getElementById('together-label').textContent = 'Ready?';
      document.getElementById('together-sublabel').textContent = 'Sit together, place hands on your bellies';
      document.getElementById('together-circle').className = 'together-circle';
      document.getElementById('together-circle').textContent = 'ü§ù';
      document.getElementById('together-timer').textContent = '';
    }

    function formatTime(s) {
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- Co-Reg Exercises ---
    const COREG_EXERCISES = {
      mirror: {
        title: 'ü™û Mirror Breathing', steps: [
          { text: "Sit facing each other. Make eye contact and smile.", subtitle: "ü™û Face each other", pause: 3 },
          { text: "Parent: start breathing slowly. In through your nose.", subtitle: "üå¨Ô∏è Parent leads ‚Äî breathe in", pause: 4 },
          { text: "Child: match your parent's breath. Breathe in when they do.", subtitle: "ü™û Mirror the breath in", pause: 4 },
          { text: "Now both breathe out together. Slowly, gently.", subtitle: "üòÆ‚Äçüí® Breathe out together", pause: 5 },
          { text: "Keep going. In together‚Ä¶ and out together. You're in sync!", subtitle: "ü§ù In sync!", pause: 5 },
          { text: "Let's try with hands up. Breathe in, hands rise. Breathe out, hands lower.", subtitle: "üôå Add hand movements", pause: 5 },
          { text: "Beautiful! Three more breaths. Feel how connected you are.", subtitle: "üíó Connected breaths", pause: 5 },
          { text: "Last breath together. The biggest, slowest one yet.", subtitle: "üåü Last beautiful breath", pause: 5 },
          { text: "Amazing mirror breathing! Give each other a hug.", subtitle: "ü§ó Hug time!", pause: 2 },
        ]
      },
      squeeze: {
        title: 'ü§ù Squeeze & Release', steps: [
          { text: "Hold hands with your child. Feel each other's warmth.", subtitle: "ü§ù Hold hands", pause: 3 },
          { text: "On the count of three, both squeeze your hands tight. One, two, three ‚Äî SQUEEZE!", subtitle: "‚úä SQUEEZE together!", pause: 4 },
          { text: "Hold the squeeze! Feel the tightness. Hold, hold, hold!", subtitle: "‚úä Hold tight!", pause: 4 },
          { text: "Now release! Let your hands go soft and floppy. Ahhhhh.", subtitle: "ü§≤ Release! Ahhh", pause: 4 },
          { text: "Feel the difference? The tingly relaxed feeling? That's what calm feels like.", subtitle: "‚ú® That's calm!", pause: 3 },
          { text: "Let's do it again. Ready? One, two, three ‚Äî SQUEEZE!", subtitle: "‚úä Squeeze again!", pause: 4 },
          { text: "Hold! Even tighter this time! Make your strongest muscles!", subtitle: "üí™ Strongest squeeze!", pause: 4 },
          { text: "And release. Let everything go soft. Breathe out together.", subtitle: "ü§≤ Soft and calm", pause: 4 },
          { text: "One more time. The biggest squeeze, then the biggest release.", subtitle: "‚úä Ultimate squeeze!", pause: 4 },
          { text: "Release! Now just hold hands gently. Feel the calm flowing between you.", subtitle: "üíó Calm flows between you", pause: 3 },
          { text: "Wonderful co-regulation! You helped each other feel calm.", subtitle: "üéâ Great teamwork!", pause: 2 },
        ]
      },
      counting: {
        title: 'üî¢ Counting Calm', steps: [
          { text: "We're going to count backward from 10. One number for each exhale.", subtitle: "üî¢ 10 breaths, counting down", pause: 3 },
          { text: "Take a deep breath in together.", subtitle: "üå¨Ô∏è Breathe in together", pause: 4 },
          { text: "Breathe out and say TEN.", subtitle: "üîü TEN", pause: 4 },
          { text: "Breathe in.", subtitle: "üå¨Ô∏è In", pause: 3 },
          { text: "Out ‚Äî NINE.", subtitle: "9Ô∏è‚É£ NINE", pause: 4 },
          { text: "In. Feel your body relaxing.", subtitle: "üå¨Ô∏è In ‚Äî body relaxing", pause: 3 },
          { text: "Out ‚Äî EIGHT.", subtitle: "8Ô∏è‚É£ EIGHT", pause: 4 },
          { text: "In. You're doing great.", subtitle: "üå¨Ô∏è In", pause: 3 },
          { text: "Out ‚Äî SEVEN. Halfway there!", subtitle: "7Ô∏è‚É£ SEVEN ‚Äî halfway!", pause: 4 },
          { text: "In. Notice how much calmer you feel.", subtitle: "üå¨Ô∏è In ‚Äî feeling calmer", pause: 3 },
          { text: "Out ‚Äî SIX, FIVE, FOUR ‚Äî keep counting together.", subtitle: "6Ô∏è‚É£5Ô∏è‚É£4Ô∏è‚É£ Keep counting!", pause: 6 },
          { text: "Out ‚Äî THREE, TWO.", subtitle: "3Ô∏è‚É£2Ô∏è‚É£ Almost there!", pause: 5 },
          { text: "Last breath in. The deepest one.", subtitle: "üå¨Ô∏è Deepest breath", pause: 4 },
          { text: "Out ‚Äî ONE. Total calm.", subtitle: "1Ô∏è‚É£ ONE ‚Äî total calm", pause: 4 },
          { text: "You counted all the way to calm! High five!", subtitle: "üôå High five!", pause: 2 },
        ]
      }
    };

    let coregStopped = false;
    async function startCoRegExercise(key) {
      const exercise = COREG_EXERCISES[key];
      if (!exercise) return;
      coregStopped = false;

      // Reuse curriculum lesson screen
      document.getElementById('curriculum-lesson-title').textContent = exercise.title;
      document.getElementById('curriculum-step-label').textContent = 'Get ready...';
      document.getElementById('curriculum-progress-fill').style.width = '0%';
      showScreen('curriculum-lesson');

      const labelEl = document.getElementById('curriculum-step-label');
      const subtitleEl = document.getElementById('curriculum-subtitle');
      const progressEl = document.getElementById('curriculum-progress-fill');

      for (let i = 0; i < exercise.steps.length; i++) {
        if (coregStopped) return;
        const step = exercise.steps[i];
        labelEl.textContent = step.text;
        if (subtitleEl) subtitleEl.textContent = step.subtitle || '';
        progressEl.style.width = ((i + 1) / exercise.steps.length * 100) + '%';

        if (typeof speakStep === 'function') speakStep(step.text);
        await sleep((step.pause || 3) * 1000);
      }

      if (!coregStopped) {
        labelEl.textContent = 'üéâ Great co-regulation session!';
        if (subtitleEl) subtitleEl.textContent = '';
        addStar();
        logActivity('coreg');
      }
    }

    // --- Activity Logging (privacy-first) ---
    function logActivity(type) {
      if (!state.activityLog) state.activityLog = [];
      const today = new Date().toDateString();
      state.activityLog.push({ type, date: today });
      if (state.activityLog.length > 100) state.activityLog = state.activityLog.slice(-100);
      saveState();
    }

    // --- Dashboard ---
    function refreshDashboard() {
      const log = state.activityLog || [];
      const now = new Date();
      const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 7);

      // Skills this week
      const thisWeek = log.filter(e => new Date(e.date) >= weekAgo);
      const uniqueSkills = new Set(thisWeek.map(e => e.type));
      document.getElementById('dash-skills').textContent = uniqueSkills.size;

      // Streak
      document.getElementById('dash-streak').textContent = state.streak || 0;

      // Best routine
      const counts = {};
      const labels = { breathing: 'üå¨Ô∏è Breathing', meditation: 'üßò Meditation', curriculum: 'üó∫Ô∏è Journey', breathcoach: 'üéÆ Breath Coach', together: 'ü§ù Together', coreg: 'üíÜ Co-Reg', mood: 'üÜò Mood Check' };
      thisWeek.forEach(e => { counts[e.type] = (counts[e.type] || 0) + 1; });
      const best = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('dash-best').textContent = best ? (labels[best[0]] || best[0]) : '‚Äî';

      // Recommended next
      const cs = getCurriculumState();
      const curriculum = getCurriculum();
      const nextLesson = curriculum.find(l => !cs.completed.includes(l.id));
      document.getElementById('dash-next').textContent = nextLesson ? (nextLesson.icon + ' ' + nextLesson.title) : '‚úÖ All complete!';
    }

    // ===== CURRICULUM STATE =====
    function getCurriculumState() {
      const mode = getAgeMode();
      const key = 'curriculum_' + mode;
      if (!state[key]) {
        state[key] = { unlocked: 10, completed: [], quizPassed: [], realLifeDone: [] };
        saveState();
      }
      return state[key];
    }

    // ===== JOURNEY MAP =====
    function renderJourneyPath() {
      // Update title per age
      const titles = { tiny: 'ü¶∏ Calm Superpowers', explorer: 'üó∫Ô∏è Superpower Quest', independent: 'üß† Mindfulness Skills' };
      const titleEl = document.querySelector('#journey-screen .screen-title');
      if (titleEl) titleEl.textContent = titles[getAgeMode()] || titles.tiny;

      const cs = getCurriculumState();
      const container = document.getElementById('journey-path');
      container.innerHTML = '';

      getCurriculum().forEach((lesson, idx) => {
        // Connector line (not before first)
        if (idx > 0) {
          const connector = document.createElement('div');
          connector.className = 'journey-connector' + (cs.completed.includes(lesson.id - 1) ? ' completed' : '');
          container.appendChild(connector);
        }

        const node = document.createElement('button');
        const isCompleted = cs.completed.includes(lesson.id);
        const isUnlocked = lesson.id <= cs.unlocked;
        const isActive = !isCompleted && isUnlocked;

        node.className = 'journey-node'
          + (isCompleted ? ' completed-node' : '')
          + (isActive ? ' active-node' : '')
          + (!isUnlocked ? ' locked' : '');

        const badge = isCompleted ? '‚úÖ' : (!isUnlocked ? 'üîí' : '‚ñ∂Ô∏è');

        node.innerHTML = `
          <div class="journey-node-icon">${lesson.icon}</div>
          <div class="journey-node-info">
            <div class="journey-node-title">${lesson.title}</div>
            <div class="journey-node-desc">${lesson.desc}</div>
          </div>
          <div class="journey-node-badge">${badge}</div>
        `;

        if (isUnlocked && !isCompleted) {
          node.onclick = () => startCurriculumLesson(lesson.id);
        } else if (isCompleted) {
          node.onclick = () => startCurriculumLesson(lesson.id); // Allow replay
        } else {
          node.onclick = (e) => { e.preventDefault(); };
        }

        container.appendChild(node);
      });
    }

    // ===== CURRICULUM LESSON PLAYER =====
    let curriculumLessonId = null;
    let curriculumStopped = false;

    function startCurriculumLesson(lessonId) {
      const lesson = getCurriculum().find(l => l.id === lessonId);
      if (!lesson) return;
      curriculumLessonId = lessonId;
      curriculumStopped = false;

      document.getElementById('curriculum-lesson-title').textContent = lesson.icon + ' ' + lesson.title;
      document.getElementById('curriculum-step-label').textContent = 'Get ready...';
      document.getElementById('curriculum-progress-fill').style.width = '0%';
      showScreen('curriculum-lesson');
      MeditationMusic.start();

      runCurriculumLesson(lesson);
    }

    async function runCurriculumLesson(lesson) {
      const labelEl = document.getElementById('curriculum-step-label');
      const progressEl = document.getElementById('curriculum-progress-fill');
      const mode = getAgeMode();

      for (let i = 0; i < lesson.steps.length; i++) {
        if (curriculumStopped) return;
        const step = lesson.steps[i];
        const progress = ((i + 1) / lesson.steps.length) * 100;
        progressEl.style.width = progress + '%';

        // Age-adaptive subtitle display
        if (mode === 'tiny') {
          labelEl.textContent = step.subtitle; // Emoji-rich subtitle only
        } else {
          labelEl.textContent = step.subtitle;
        }

        await speakStep(step.text);
        if (curriculumStopped) return;

        // Independent mode: show "why it works" tip after last step
        if (mode === 'independent' && i === lesson.steps.length - 1 && WHY_TIPS[lesson.id]) {
          const tipEl = document.createElement('div');
          tipEl.className = 'why-tip';
          tipEl.textContent = 'üß† ' + WHY_TIPS[lesson.id];
          labelEl.parentElement.appendChild(tipEl);
          // Give time to read
          await new Promise(r => setTimeout(r, 4000));
          if (curriculumStopped) { tipEl.remove(); return; }
          tipEl.remove();
        }

        // Pause after speech
        const pauseMs = step.pause * 1000;
        const startTime = Date.now();
        while (Date.now() - startTime < pauseMs && !curriculumStopped) {
          await new Promise(r => setTimeout(r, 100));
        }
      }

      if (!curriculumStopped) {
        progressEl.style.width = '100%';
        playBell();
        MeditationMusic.stop();

        // Mark completed
        const cs = getCurriculumState();
        if (!cs.completed.includes(lesson.id)) {
          cs.completed.push(lesson.id);
          saveState();
        }

        // Show quiz after a moment
        setTimeout(() => {
          if (!curriculumStopped) {
            showQuiz(lesson);
          }
        }, 2000);
      }
    }

    window.stopCurriculumLesson = function () {
      curriculumStopped = true;
      speechSynthesis.cancel();
      stopAllElevenAudio();
      MeditationMusic.stop();
      curriculumLessonId = null;
      showScreen('journey');
    };

    // ===== QUIZ =====
    let currentQuizLesson = null;

    function showQuiz(lesson) {
      currentQuizLesson = lesson;
      const questionEl = document.getElementById('quiz-question');
      const answersEl = document.getElementById('quiz-answers');
      const feedbackEl = document.getElementById('quiz-feedback');
      const mode = getAgeMode();

      questionEl.textContent = lesson.quiz.question;
      feedbackEl.textContent = '';
      feedbackEl.style.color = '';
      answersEl.innerHTML = '';

      lesson.quiz.answers.forEach((answer, idx) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-answer-btn';
        btn.textContent = answer.text;
        btn.onclick = () => handleQuizAnswer(btn, answer, lesson);
        answersEl.appendChild(btn);
      });

      document.getElementById('quiz-overlay').classList.add('active');

      // Tiny mode: voice-read the question and answers
      if (mode === 'tiny') {
        const answerTexts = lesson.quiz.answers.map(a => a.text).join(', or, ');
        tinyNarrate(lesson.quiz.question + ' Is it ' + answerTexts + '?');
      }
    }

    function handleQuizAnswer(btnEl, answer, lesson) {
      const feedbackEl = document.getElementById('quiz-feedback');
      const allBtns = document.querySelectorAll('.quiz-answer-btn');

      if (answer.correct) {
        btnEl.classList.add('correct');
        feedbackEl.textContent = 'üéâ You got it! Amazing!';
        feedbackEl.style.color = '#66BB6A';
        allBtns.forEach(b => { b.disabled = true; b.style.pointerEvents = 'none'; });

        // Mark quiz passed and unlock next
        const cs = getCurriculumState();
        if (!cs.quizPassed.includes(lesson.id)) {
          cs.quizPassed.push(lesson.id);
        }
        // Unlock next lesson if current quiz passed
        if (lesson.id >= cs.unlocked && lesson.id < getCurriculum().length) {
          cs.unlocked = lesson.id + 1;
        }
        saveState();
        addStar();

        // Show real-life prompt after a delay
        setTimeout(() => {
          document.getElementById('quiz-overlay').classList.remove('active');
          showRealLifePrompt(lesson);
        }, 1800);
      } else {
        btnEl.classList.add('wrong');
        feedbackEl.textContent = 'ü§î Hmm, try again!';
        feedbackEl.style.color = '#FF7F7F';
        // Reset after animation
        setTimeout(() => {
          btnEl.classList.remove('wrong');
          feedbackEl.textContent = '';
        }, 1200);
      }
    }

    // ===== REAL-LIFE PROMPT =====
    function showRealLifePrompt(lesson) {
      currentQuizLesson = lesson; // reuse for tracking
      document.getElementById('reallife-prompt-text').textContent = lesson.realLifePrompt;
      document.getElementById('reallife-overlay').classList.add('active');
    }

    window.completeRealLifePrompt = function () {
      if (currentQuizLesson) {
        const cs = getCurriculumState();
        if (!cs.realLifeDone.includes(currentQuizLesson.id)) {
          cs.realLifeDone.push(currentQuizLesson.id);
          saveState();
        }
        addStar(); // Bonus star
      }
      document.getElementById('reallife-overlay').classList.remove('active');
      spawnConfetti();
      completeActivity('Superpower Unlocked!', currentQuizLesson ? currentQuizLesson.title + ' ‚Äî mastered!' : 'Great job!', 'curriculum');
      currentQuizLesson = null;
      curriculumLessonId = null;
      // Navigate back to journey after celebration
      setTimeout(() => showScreen('journey'), 500);
    };

    window.skipRealLifePrompt = function () {
      document.getElementById('reallife-overlay').classList.remove('active');
      completeActivity('Lesson Complete!', currentQuizLesson ? currentQuizLesson.title + ' done!' : 'Well done!', 'curriculum');
      currentQuizLesson = null;
      curriculumLessonId = null;
      setTimeout(() => showScreen('journey'), 500);
    };

    // ===== BREATH DETECTOR =====
    const BreathDetector = {
      ctx: null, analyser: null, dataArr: null, stream: null,
      active: false, exhaling: false, exhaleStart: 0, volume: 0,
      threshold: 0.06, minExhaleMs: 180,
      async start() {
        try {
          this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          const src = this.ctx.createMediaStreamSource(this.stream);
          this.analyser = this.ctx.createAnalyser();
          this.analyser.fftSize = 256;
          src.connect(this.analyser);
          this.dataArr = new Uint8Array(this.analyser.frequencyBinCount);
          this.active = true;
          this._poll();
          return true;
        } catch (e) { console.warn('Mic denied', e); return false; }
      },
      _poll() {
        if (!this.active) return;
        this.analyser.getByteFrequencyData(this.dataArr);
        let sum = 0;
        for (let i = 0; i < this.dataArr.length; i++) sum += this.dataArr[i];
        this.volume = sum / (this.dataArr.length * 255);
        const wasExhaling = this.exhaling;
        if (this.volume > this.threshold) {
          if (!this.exhaling) { this.exhaling = true; this.exhaleStart = Date.now(); }
        } else {
          this.exhaling = false;
        }
        requestAnimationFrame(() => this._poll());
      },
      isExhaling() { return this.exhaling && (Date.now() - this.exhaleStart > this.minExhaleMs); },
      exhaleDuration() { return this.exhaling ? (Date.now() - this.exhaleStart) / 1000 : 0; },
      getVolume() { return this.volume; },
      stop() {
        this.active = false;
        if (this.stream) this.stream.getTracks().forEach(t => t.stop());
        if (this.ctx) { try { this.ctx.close(); } catch (e) { } }
        this.stream = null; this.ctx = null; this.analyser = null;
        this.exhaling = false; this.volume = 0;
      }
    };

    // ===== BREATH GAME STATE =====
    let breathGameType = null;
    let breathGameRunning = false;
    let breathGameTimer = 60;
    let breathGameInterval = null;
    let breathGameAnimFrame = null;
    let breathUsingMic = false;
    let breathTapDown = false;
    let breathTapStart = 0;
    let breathTotalExhale = 0;
    let breathBestExhale = 0;
    let breathExhaleCount = 0;
    // For boat game
    let boatY = 0, boatWavePhase = 0, boatCalm = 0;
    // For firefly game
    let fireflyGlow = 0, fireflyParticles = [];
    // For bear game
    let bearCalmLevel = 0, bearShake = 0;

    window.initBreathGame = function (type) {
      breathGameType = type;

      // Game-specific tutorial content
      const tutorials = {
        boat: {
          icon: 'üö§', title: 'Steady Boat',
          goal: 'Breathe out slowly to calm the ocean waves so the boat can sail smoothly!',
          prize: '‚≠ê Keep the waters calm to earn stars!',
          banner: 'üö§ Calm the waves!',
          voiceIntro: 'Welcome to Steady Boat! Breathe out slowly and the waves will get calm. The longer you breathe out, the smoother the boat sails!',
          hintMic: 'üå¨Ô∏è Blow slowly near the mic to calm the ocean!',
          hintTap: 'üëÜ Hold the screen while breathing out to calm the waves!',
        },
        firefly: {
          icon: 'üåü', title: 'Firefly Glow',
          goal: 'Breathe out to make the firefly glow brighter and light up the whole forest!',
          prize: '‚≠ê Light up the forest to earn stars!',
          banner: 'üåü Light up the forest!',
          voiceIntro: 'Welcome to Firefly Glow! Breathe out slowly and the firefly will glow. The forest will light up with your breath!',
          hintMic: 'üå¨Ô∏è Blow slowly to make the firefly shine brighter!',
          hintTap: 'üëÜ Hold the screen while breathing out to make the firefly glow!',
        },
        bear: {
          icon: 'üß∏', title: 'Calm Bear',
          goal: 'Bear is stressed and shaking! Breathe out slowly to help Bear feel calm and fall asleep.',
          prize: '‚≠ê Help Bear fall asleep to earn stars!',
          banner: 'üß∏ Help Bear sleep!',
          voiceIntro: 'Oh no, Bear is feeling stressed! Can you help? Breathe out slowly to calm Bear down. If you breathe long enough, Bear will fall asleep!',
          hintMic: 'üå¨Ô∏è Blow slowly near the mic to calm Bear down!',
          hintTap: 'üëÜ Hold the screen while breathing out to help Bear relax!',
        },
      };

      const t = tutorials[type] || tutorials.boat;

      // Populate tutorial overlay
      document.getElementById('tutorial-game-icon').textContent = t.icon;
      document.getElementById('tutorial-game-title').textContent = t.title;
      document.getElementById('tutorial-game-goal').textContent = t.goal;
      document.getElementById('tutorial-game-prize').textContent = t.prize;

      // Set header title
      document.getElementById('breathgame-title').textContent = t.icon + ' ' + t.title;
      // Set goal banner
      document.getElementById('breath-goal-banner').textContent = t.banner;

      // Store tutorial data for later voice narration
      window._currentGameTutorial = t;

      // Show tutorial overlay
      document.getElementById('mic-prompt-overlay').classList.add('active');
    };

    window.allowMic = async function () {
      document.getElementById('mic-prompt-overlay').classList.remove('active');
      const ok = await BreathDetector.start();
      breathUsingMic = ok;
      const t = window._currentGameTutorial || {};
      if (!ok) {
        document.getElementById('breath-hint').textContent = t.hintTap || 'Tap & hold the screen while breathing out!';
      } else {
        document.getElementById('breath-hint').textContent = t.hintMic || 'Blow gently near the mic!';
      }
      startBreathGame();
      // Voice narration
      if (t.voiceIntro) elevenSpeak(t.voiceIntro);
    };

    window.skipMic = function () {
      document.getElementById('mic-prompt-overlay').classList.remove('active');
      breathUsingMic = false;
      const t = window._currentGameTutorial || {};
      document.getElementById('breath-hint').textContent = t.hintTap || 'Tap & hold the screen while breathing out!';
      startBreathGame();
      if (t.voiceIntro) elevenSpeak(t.voiceIntro);
    };

    // ===== HANDPAN AMBIENT MUSIC =====
    const HandpanMusic = {
      ctx: null, masterGain: null, droneOscs: [], noteTimer: null, playing: false,
      // D minor pentatonic scale frequencies (octaves 3-5) ‚Äî calming handpan tuning
      notes: [146.83, 174.61, 196.00, 220.00, 261.63, 293.66, 349.23, 392.00, 440.00, 523.25],
      start() {
        if (this.playing) return;
        this.playing = true;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Must resume ‚Äî browsers suspend AudioContext until user gesture
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.setValueAtTime(0, this.ctx.currentTime);
        this.masterGain.gain.linearRampToValueAtTime(0.45, this.ctx.currentTime + 2);
        this.masterGain.connect(this.ctx.destination);

        // Soft drone pad (low D + A)
        this._startDrone();
        // Schedule handpan notes
        this._scheduleNote();
      },
      _startDrone() {
        const droneFreqs = [73.42, 110.00]; // D2, A2
        droneFreqs.forEach(freq => {
          const osc = this.ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = freq;
          const g = this.ctx.createGain();
          g.gain.value = 0.09;
          // Gentle LFO for warmth
          const lfo = this.ctx.createOscillator();
          lfo.type = 'sine';
          lfo.frequency.value = 0.15 + Math.random() * 0.1;
          const lfoGain = this.ctx.createGain();
          lfoGain.gain.value = 0.008;
          lfo.connect(lfoGain);
          lfoGain.connect(g.gain);
          lfo.start();
          osc.connect(g);
          g.connect(this.masterGain);
          osc.start();
          this.droneOscs.push({ osc, g, lfo });
        });
      },
      _playHandpanNote() {
        if (!this.playing || !this.ctx) return;
        const freq = this.notes[Math.floor(Math.random() * this.notes.length)];
        const now = this.ctx.currentTime;

        // Fundamental (sine) ‚Äî body of handpan tone
        const osc1 = this.ctx.createOscillator();
        osc1.type = 'sine';
        osc1.frequency.value = freq;

        // Harmonic overtone (triangle, octave up) ‚Äî metallic shimmer
        const osc2 = this.ctx.createOscillator();
        osc2.type = 'triangle';
        osc2.frequency.value = freq * 2.01; // Slight detune for beating

        // Third partial ‚Äî the "ding" character
        const osc3 = this.ctx.createOscillator();
        osc3.type = 'sine';
        osc3.frequency.value = freq * 3.0;

        // Envelope ‚Äî fast attack, long decay (handpan ring)
        const env = this.ctx.createGain();
        env.gain.setValueAtTime(0, now);
        env.gain.linearRampToValueAtTime(0.12, now + 0.01); // Quick strike
        env.gain.exponentialRampToValueAtTime(0.04, now + 0.8); // Sustain ring
        env.gain.exponentialRampToValueAtTime(0.001, now + 3.5); // Long decay

        // Overtone envelope (faster decay)
        const env2 = this.ctx.createGain();
        env2.gain.setValueAtTime(0, now);
        env2.gain.linearRampToValueAtTime(0.04, now + 0.005);
        env2.gain.exponentialRampToValueAtTime(0.001, now + 1.5);

        const env3 = this.ctx.createGain();
        env3.gain.setValueAtTime(0, now);
        env3.gain.linearRampToValueAtTime(0.02, now + 0.003);
        env3.gain.exponentialRampToValueAtTime(0.001, now + 0.8);

        osc1.connect(env);
        osc2.connect(env2);
        osc3.connect(env3);
        env.connect(this.masterGain);
        env2.connect(this.masterGain);
        env3.connect(this.masterGain);

        osc1.start(now); osc2.start(now); osc3.start(now);
        osc1.stop(now + 4); osc2.stop(now + 2); osc3.stop(now + 1);
      },
      _scheduleNote() {
        if (!this.playing) return;
        this._playHandpanNote();
        // Random interval 1.5‚Äì4s for organic feel
        const delay = 1500 + Math.random() * 2500;
        this.noteTimer = setTimeout(() => this._scheduleNote(), delay);
      },
      stop() {
        this.playing = false;
        if (this.noteTimer) { clearTimeout(this.noteTimer); this.noteTimer = null; }
        if (this.masterGain) {
          try {
            this.masterGain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1.5);
          } catch (e) { }
        }
        // Clean up after fade
        setTimeout(() => {
          this.droneOscs.forEach(d => {
            try { d.osc.stop(); d.lfo.stop(); } catch (e) { }
          });
          this.droneOscs = [];
          if (this.ctx) { try { this.ctx.close(); } catch (e) { } this.ctx = null; }
          this.masterGain = null;
        }, 2000);
      }
    };

    function startBreathGame() {
      breathGameRunning = true;
      const gameDuration = getAgeGameTimer();
      breathGameTimer = gameDuration;
      breathTotalExhale = 0;
      breathBestExhale = 0;
      breathExhaleCount = 0;
      boatY = 170; boatWavePhase = 0; boatCalm = 0;
      fireflyGlow = 0; fireflyParticles = [];
      bearCalmLevel = 0; bearShake = 5;
      updateExhaleStars(0);
      document.getElementById('breath-timer').textContent = String(gameDuration);
      showScreen('breathgame');

      // Start ambient handpan music
      HandpanMusic.start();


      // Tap fallback listeners
      const canvas = document.getElementById('breath-canvas');
      canvas.addEventListener('pointerdown', onBreathTapDown);
      canvas.addEventListener('pointerup', onBreathTapUp);
      canvas.addEventListener('pointerleave', onBreathTapUp);

      // Timer countdown
      breathGameInterval = setInterval(() => {
        breathGameTimer--;
        document.getElementById('breath-timer').textContent = breathGameTimer;
        if (breathGameTimer <= 0) endBreathGame();
      }, 1000);

      // Animation loop
      breathGameAnimFrame = requestAnimationFrame(breathGameLoop);
    }

    function onBreathTapDown(e) {
      e.preventDefault();
      breathTapDown = true;
      breathTapStart = Date.now();
    }
    function onBreathTapUp(e) {
      e.preventDefault();
      if (breathTapDown) {
        const dur = (Date.now() - breathTapStart) / 1000;
        if (dur > 0.3) {
          breathTotalExhale += dur;
          breathExhaleCount++;
          if (dur > breathBestExhale) breathBestExhale = dur;
        }
      }
      breathTapDown = false;
    }

    function isBreathing() {
      if (breathUsingMic) return BreathDetector.isExhaling();
      return breathTapDown && (Date.now() - breathTapStart > 200);
    }
    function currentExhaleSec() {
      if (breathUsingMic) return BreathDetector.exhaleDuration();
      return breathTapDown ? (Date.now() - breathTapStart) / 1000 : 0;
    }

    function breathGameLoop() {
      if (!breathGameRunning) return;
      const canvas = document.getElementById('breath-canvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      const breathing = isBreathing();
      const exSec = currentExhaleSec();

      // Update indicator
      const ind = document.getElementById('breath-indicator');
      ind.classList.toggle('active', breathing);

      // Track mic exhales
      if (breathUsingMic && BreathDetector.exhaling === false && breathExhaleCount >= 0) {
        // exhale just ended ‚Äî captured by detector
      }
      if (breathUsingMic && breathing) {
        // live update
        if (exSec > breathBestExhale) breathBestExhale = exSec;
      }

      // Update exhale stars based on current exhale
      const starLevel = Math.min(5, Math.floor(exSec / 1.0));
      updateExhaleStars(starLevel);

      // Dispatch to game renderer
      if (breathGameType === 'boat') renderBoatGame(ctx, w, h, breathing, exSec);
      else if (breathGameType === 'firefly') renderFireflyGame(ctx, w, h, breathing, exSec);
      else if (breathGameType === 'bear') renderBearGame(ctx, w, h, breathing, exSec);

      breathGameAnimFrame = requestAnimationFrame(breathGameLoop);
    }

    function updateExhaleStars(level) {
      for (let i = 1; i <= 5; i++) {
        const el = document.getElementById('estar-' + i);
        if (el) el.classList.toggle('lit', i <= level);
      }
    }

    // ===== BOAT GAME =====
    function renderBoatGame(ctx, w, h, breathing, exSec) {
      const t = Date.now() / 1000;
      // Calm factor smoothly approaches target
      const target = breathing ? Math.min(1, exSec / 3) : 0;
      boatCalm += (target - boatCalm) * 0.04;

      // Sky gradient (calmer = warmer sunset)
      const skyG = ctx.createLinearGradient(0, 0, 0, h * 0.55);
      const skyR = Math.floor(135 + boatCalm * 60);
      const skyGv = Math.floor(180 + boatCalm * 40);
      const skyB = Math.floor(235 - boatCalm * 30);
      skyG.addColorStop(0, `rgb(${skyR},${skyGv},${skyB})`);
      skyG.addColorStop(1, `rgb(${skyR + 40},${skyGv + 20},${skyB - 20})`);
      ctx.fillStyle = skyG;
      ctx.fillRect(0, 0, w, h * 0.55);

      // Sun
      const sunY = h * 0.18 + boatCalm * 20;
      ctx.beginPath();
      ctx.arc(w / 2, sunY, 30 + boatCalm * 8, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,${200 + boatCalm * 55},${80 + boatCalm * 80},${0.7 + boatCalm * 0.3})`;
      ctx.fill();

      // Water
      const waveAmp = 18 * (1 - boatCalm * 0.85);
      const waterTop = h * 0.55;
      const waterG = ctx.createLinearGradient(0, waterTop, 0, h);
      waterG.addColorStop(0, `rgba(60,${140 + boatCalm * 50},${200 + boatCalm * 30},0.9)`);
      waterG.addColorStop(1, `rgba(30,${80 + boatCalm * 30},${160 + boatCalm * 20},1)`);
      ctx.fillStyle = waterG;
      ctx.beginPath();
      ctx.moveTo(0, waterTop);
      for (let x = 0; x <= w; x += 4) {
        const y = waterTop + Math.sin(x * 0.03 + t * (2 - boatCalm * 1.2)) * waveAmp
          + Math.sin(x * 0.06 + t * 1.5) * waveAmp * 0.4;
        ctx.lineTo(x, y);
      }
      ctx.lineTo(w, h); ctx.lineTo(0, h);
      ctx.closePath(); ctx.fill();

      // Boat
      const boatX = w / 2;
      const boatWaveY = waterTop + Math.sin(boatX * 0.03 + t * (2 - boatCalm * 1.2)) * waveAmp - 10;
      const boatTilt = Math.sin(t * (2.5 - boatCalm * 1.5)) * (8 - boatCalm * 6);
      ctx.save();
      ctx.translate(boatX, boatWaveY);
      ctx.rotate(boatTilt * Math.PI / 180);
      // Hull
      ctx.beginPath();
      ctx.moveTo(-30, 0); ctx.lineTo(-24, 16); ctx.lineTo(24, 16); ctx.lineTo(30, 0);
      ctx.closePath();
      ctx.fillStyle = '#A0522D'; ctx.fill();
      // Sail
      ctx.beginPath();
      ctx.moveTo(0, -2); ctx.lineTo(0, -42); ctx.lineTo(18, -8);
      ctx.closePath();
      ctx.fillStyle = '#fff'; ctx.fill();
      ctx.restore();

      // Clouds
      for (let i = 0; i < 3; i++) {
        const cx = (i * 150 + t * 8 * (0.5 + i * 0.2)) % (w + 80) - 40;
        const cy = 30 + i * 25;
        ctx.beginPath();
        ctx.arc(cx, cy, 20, 0, Math.PI * 2);
        ctx.arc(cx + 18, cy - 6, 16, 0, Math.PI * 2);
        ctx.arc(cx + 30, cy, 14, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.fill();
      }
    }

    // ===== FIREFLY GAME =====
    function renderFireflyGame(ctx, w, h, breathing, exSec) {
      const t = Date.now() / 1000;
      // Glow factor
      const target = breathing ? Math.min(1, exSec / 4) : 0;
      fireflyGlow += (target - fireflyGlow) * 0.05;

      // Dark forest background
      const bgBright = Math.floor(10 + fireflyGlow * 30);
      ctx.fillStyle = `rgb(${bgBright},${bgBright + 8},${bgBright + 5})`;
      ctx.fillRect(0, 0, w, h);

      // Trees (silhouettes)
      const treePositions = [30, 80, 140, 200, 260, 320, 360];
      treePositions.forEach((tx, i) => {
        const treeH = 120 + (i % 3) * 40;
        const trunkW = 8 + (i % 2) * 4;
        // Trunk
        ctx.fillStyle = `rgb(${20 + fireflyGlow * 25},${15 + fireflyGlow * 15},${10 + fireflyGlow * 10})`;
        ctx.fillRect(tx - trunkW / 2, h - treeH, trunkW, treeH);
        // Canopy
        ctx.beginPath();
        ctx.moveTo(tx, h - treeH - 30 - (i % 2) * 20);
        ctx.lineTo(tx - 25 - (i % 2) * 10, h - treeH + 20);
        ctx.lineTo(tx + 25 + (i % 2) * 10, h - treeH + 20);
        ctx.closePath();
        ctx.fillStyle = `rgb(${15 + fireflyGlow * 30},${30 + fireflyGlow * 40},${15 + fireflyGlow * 20})`;
        ctx.fill();
      });

      // Ground
      ctx.fillStyle = `rgb(${15 + fireflyGlow * 15},${25 + fireflyGlow * 20},${10 + fireflyGlow * 10})`;
      ctx.fillRect(0, h - 40, w, 40);

      // Grass tufts
      for (let gx = 0; gx < w; gx += 14) {
        const gH = 8 + Math.sin(gx * 0.3) * 4;
        ctx.beginPath();
        ctx.moveTo(gx, h - 40);
        ctx.lineTo(gx + 3, h - 40 - gH);
        ctx.lineTo(gx + 7, h - 40);
        ctx.fillStyle = `rgb(${20 + fireflyGlow * 25},${40 + fireflyGlow * 45},${15 + fireflyGlow * 15})`;
        ctx.fill();
      }

      // Firefly center
      const ffx = w / 2, ffy = h / 2 - 20;
      const glowRadius = 15 + fireflyGlow * 120;
      const glowAlpha = 0.1 + fireflyGlow * 0.5;

      // Light radius
      const lightG = ctx.createRadialGradient(ffx, ffy, 0, ffx, ffy, glowRadius);
      lightG.addColorStop(0, `rgba(255,255,150,${glowAlpha})`);
      lightG.addColorStop(0.5, `rgba(255,230,80,${glowAlpha * 0.4})`);
      lightG.addColorStop(1, 'rgba(255,230,80,0)');
      ctx.fillStyle = lightG;
      ctx.fillRect(0, 0, w, h);

      // Firefly body
      ctx.beginPath();
      ctx.arc(ffx, ffy, 5, 0, Math.PI * 2);
      ctx.fillStyle = `rgb(${200 + fireflyGlow * 55},${200 + fireflyGlow * 55},${50 + fireflyGlow * 100})`;
      ctx.fill();
      // Firefly glow core
      ctx.beginPath();
      ctx.arc(ffx, ffy, 3 + fireflyGlow * 4, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,200,${0.3 + fireflyGlow * 0.7})`;
      ctx.fill();
      // Wings
      ctx.beginPath();
      ctx.ellipse(ffx - 6, ffy - 3, 5, 3, -0.3, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(200,220,255,0.3)'; ctx.fill();
      ctx.beginPath();
      ctx.ellipse(ffx + 6, ffy - 3, 5, 3, 0.3, 0, Math.PI * 2);
      ctx.fill();

      // Sparkle particles
      if (breathing && Math.random() < 0.3 + fireflyGlow * 0.5) {
        fireflyParticles.push({
          x: ffx + (Math.random() - 0.5) * glowRadius,
          y: ffy + (Math.random() - 0.5) * glowRadius,
          life: 1, speed: 0.3 + Math.random() * 0.5
        });
      }
      fireflyParticles = fireflyParticles.filter(p => {
        p.life -= 0.015;
        p.y -= p.speed;
        if (p.life <= 0) return false;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 1.5 * p.life, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,255,180,${p.life * 0.8})`;
        ctx.fill();
        return true;
      });

      // Stars in sky based on glow
      if (fireflyGlow > 0.3) {
        for (let i = 0; i < 20; i++) {
          const sx = (i * 53 + 17) % w;
          const sy = (i * 31 + 7) % (h * 0.4);
          const sa = (fireflyGlow - 0.3) * 1.4;
          const twinkle = Math.sin(t * 2 + i) * 0.3 + 0.7;
          ctx.beginPath();
          ctx.arc(sx, sy, 1.2, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255,255,220,${sa * twinkle})`;
          ctx.fill();
        }
      }
    }

    // ===== BEAR GAME =====
    function renderBearGame(ctx, w, h, breathing, exSec) {
      const t = Date.now() / 1000;
      // Calm level smoothly approaches target
      const target = breathing ? Math.min(1, exSec / 3.5) : Math.max(0, bearCalmLevel - 0.003);
      bearCalmLevel += (target - bearCalmLevel) * 0.03;

      // Background: nervous red ‚Üí calm green/blue
      const bgR = Math.floor(240 - bearCalmLevel * 60);
      const bgG = Math.floor(210 + bearCalmLevel * 30);
      const bgB = Math.floor(220 + bearCalmLevel * 25);
      ctx.fillStyle = `rgb(${bgR},${bgG},${bgB})`;
      ctx.fillRect(0, 0, w, h);

      // Meadow ground
      const groundG = ctx.createLinearGradient(0, h * 0.7, 0, h);
      groundG.addColorStop(0, `rgb(${120 + bearCalmLevel * 40},${180 + bearCalmLevel * 40},${100 + bearCalmLevel * 30})`);
      groundG.addColorStop(1, `rgb(${80 + bearCalmLevel * 30},${140 + bearCalmLevel * 40},${70 + bearCalmLevel * 20})`);
      ctx.fillStyle = groundG;
      ctx.beginPath();
      ctx.moveTo(0, h * 0.72);
      for (let x = 0; x <= w; x += 5) {
        ctx.lineTo(x, h * 0.72 + Math.sin(x * 0.02 + 1) * 8);
      }
      ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath(); ctx.fill();

      // Flowers when calm
      if (bearCalmLevel > 0.3) {
        for (let i = 0; i < 8; i++) {
          const fx = 30 + i * 46;
          const fy = h * 0.75 + Math.sin(fx * 0.5) * 10;
          const fAlpha = Math.min(1, (bearCalmLevel - 0.3) * 2);
          ctx.beginPath();
          ctx.arc(fx, fy, 4, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255,${150 + i * 12},${100 + i * 15},${fAlpha})`;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(fx, fy, 2, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255,255,200,${fAlpha})`;
          ctx.fill();
        }
      }

      // Bear position with shake
      const shake = (1 - bearCalmLevel) * 4;
      const bx = w / 2 + Math.sin(t * 8) * shake;
      const by = h * 0.48 + Math.sin(t * 6) * shake * 0.5;
      // Bear sits lower as calm
      const sitOffset = bearCalmLevel * 20;

      ctx.save();
      ctx.translate(bx, by + sitOffset);

      // Body
      ctx.beginPath();
      ctx.ellipse(0, 30, 42, 50, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();

      // Belly
      ctx.beginPath();
      ctx.ellipse(0, 40, 28, 34, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#DEB887'; ctx.fill();

      // Head
      ctx.beginPath();
      ctx.arc(0, -20, 32, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();

      // Ears
      ctx.beginPath();
      ctx.arc(-22, -42, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();
      ctx.beginPath();
      ctx.arc(-22, -42, 7, 0, Math.PI * 2);
      ctx.fillStyle = '#E8C9A0'; ctx.fill();
      ctx.beginPath();
      ctx.arc(22, -42, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();
      ctx.beginPath();
      ctx.arc(22, -42, 7, 0, Math.PI * 2);
      ctx.fillStyle = '#E8C9A0'; ctx.fill();

      // Eyes
      const eyeOpenness = 1 - bearCalmLevel * 0.6; // Close eyes as calm
      ctx.beginPath();
      ctx.ellipse(-10, -22, 4, 4 * eyeOpenness + 0.5, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#333'; ctx.fill();
      ctx.beginPath();
      ctx.ellipse(10, -22, 4, 4 * eyeOpenness + 0.5, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#333'; ctx.fill();

      // Nose
      ctx.beginPath();
      ctx.ellipse(0, -12, 5, 4, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#8B6848'; ctx.fill();

      // Mouth ‚Äî worried ‚Üí smile
      ctx.beginPath();
      if (bearCalmLevel < 0.3) {
        // Worried squiggle
        ctx.moveTo(-8, -4);
        ctx.quadraticCurveTo(-4, -1, 0, -4);
        ctx.quadraticCurveTo(4, -7, 8, -4);
      } else {
        // Smile
        const smileW = 6 + bearCalmLevel * 6;
        ctx.arc(0, -6, smileW, 0.1, Math.PI - 0.1);
      }
      ctx.strokeStyle = '#8B6848';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Arms ‚Äî nervous up ‚Üí calm at sides
      const armAngle = (1 - bearCalmLevel) * 0.6;
      // Left arm
      ctx.beginPath();
      ctx.ellipse(-38, 10 + bearCalmLevel * 15, 14, 10, -armAngle, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();
      // Right arm
      ctx.beginPath();
      ctx.ellipse(38, 10 + bearCalmLevel * 15, 14, 10, armAngle, 0, Math.PI * 2);
      ctx.fillStyle = '#C4956A'; ctx.fill();

      // Zzz when very calm
      if (bearCalmLevel > 0.7) {
        const za = (bearCalmLevel - 0.7) * 3.3;
        ctx.font = `${14 + bearCalmLevel * 6}px Nunito`;
        ctx.fillStyle = `rgba(100,100,200,${za})`;
        const zOff = Math.sin(t * 1.5) * 5;
        ctx.fillText('z', 35, -40 + zOff);
        ctx.font = `${10 + bearCalmLevel * 4}px Nunito`;
        ctx.fillText('z', 48, -52 + zOff);
        ctx.font = `${8 + bearCalmLevel * 2}px Nunito`;
        ctx.fillText('z', 56, -60 + zOff);
      }

      ctx.restore();

      // Hearts when calm > 0.5
      if (bearCalmLevel > 0.5) {
        const hAlpha = (bearCalmLevel - 0.5) * 2;
        for (let i = 0; i < 4; i++) {
          const hx = w * 0.2 + i * w * 0.2;
          const hy = h * 0.2 + Math.sin(t + i * 2) * 15;
          ctx.font = '16px sans-serif';
          ctx.globalAlpha = hAlpha * (Math.sin(t * 1.5 + i) * 0.3 + 0.7);
          ctx.fillText('üíö', hx, hy);
        }
        ctx.globalAlpha = 1;
      }

      // Status text
      ctx.font = 'bold 15px Nunito';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#555';
      if (bearCalmLevel < 0.2) ctx.fillText('Bear is nervous... breathe to help!', w / 2, h - 15);
      else if (bearCalmLevel < 0.5) ctx.fillText('Bear is starting to relax...', w / 2, h - 15);
      else if (bearCalmLevel < 0.8) ctx.fillText('Bear feels much calmer! üíö', w / 2, h - 15);
      else ctx.fillText('Bear is peacefully calm! üò¥‚ú®', w / 2, h - 15);
      ctx.textAlign = 'start';
    }

    function endBreathGame() {
      breathGameRunning = false;
      clearInterval(breathGameInterval);
      if (breathGameAnimFrame) cancelAnimationFrame(breathGameAnimFrame);
      BreathDetector.stop();
      HandpanMusic.stop();
      const canvas = document.getElementById('breath-canvas');
      canvas.removeEventListener('pointerdown', onBreathTapDown);
      canvas.removeEventListener('pointerup', onBreathTapUp);
      canvas.removeEventListener('pointerleave', onBreathTapUp);

      // Award stars based on performance
      let earnedStars = 0;
      if (breathBestExhale >= 2) earnedStars++;
      if (breathBestExhale >= 4) earnedStars++;
      if (breathTotalExhale >= 15) earnedStars++;
      earnedStars = Math.max(1, earnedStars); // Always at least 1 for trying
      for (let i = 0; i < earnedStars; i++) addStar();

      playBell();
      spawnConfetti();
      const gameNames = { boat: 'Steady Boat', firefly: 'Firefly Glow', bear: 'Calm Bear' };
      completeActivity('Breath Coach!', (gameNames[breathGameType] || 'Game') + ' ‚Äî ' + earnedStars + ' stars!', 'breathcoach');
      breathGameType = null;
      setTimeout(() => showScreen('breathcoach'), 500);
    }

    window.stopBreathGame = function () {
      breathGameRunning = false;
      clearInterval(breathGameInterval);
      if (breathGameAnimFrame) cancelAnimationFrame(breathGameAnimFrame);
      BreathDetector.stop();
      HandpanMusic.stop();
      const canvas = document.getElementById('breath-canvas');
      canvas.removeEventListener('pointerdown', onBreathTapDown);
      canvas.removeEventListener('pointerup', onBreathTapUp);
      canvas.removeEventListener('pointerleave', onBreathTapUp);
      breathGameType = null;
      showScreen('breathcoach');
    };

    // ===== PATCH showScreen for journey =====
    const _origShowScreen = window.showScreen;
    window.showScreen = function (name) {
      _origShowScreen(name);
      if (name === 'journey') renderJourneyPath();
      if (name === 'affirmations') renderAffirmationScreen();
    };

    // Voices are loaded at the top of the script
  </script>
  <script>
    // Register Service Worker for PWA / offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then((reg) => {
          console.log('SW registered:', reg.scope);
        }).catch((err) => {
          console.log('SW registration failed:', err);
        });
      });
    }
  </script>
</body>

</html>